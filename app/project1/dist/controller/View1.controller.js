sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/format/DateFormat","sap/viz/ui5/controls/VizFrame","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/json/JSONModel"],function(e,t,a,o,i,n,s,r,c){"use strict";return e.extend("project1.controller.View1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({milestones:[{fase:"Kick off",fechaInicio:null,fechaFin:null},{fase:"Diseño",fechaInicio:null,fechaFin:null},{fase:"Construcción",fechaInicio:null,fechaFin:null},{fase:"Pruebas TQ",fechaInicio:null,fechaFin:null},{fase:"Go live",fechaInicio:null,fechaFin:null},{fase:"Paso AM",fechaInicio:null,fechaFin:null},{fase:"Server post/prod",fechaInicio:null,fechaFin:null}],chartData:[]});this.getView().setModel(e,"planning");console.log(e);this.updateVizFrame1();var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("view").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(e){var t=e.getParameter("arguments").sProjectID;this._sProjectID=t;var a=`/odata/v4/datos-cdo/DatosProyect(${t})`;try{const e=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const t=await e.json();console.log("Datos del proyecto:",t);if(t){this.byId("input0").setValue(t.codigoProyect||"");this.byId("input1").setValue(t.nameProyect||"");this.byId("int_clienteFun").setValue(t.clienteFuncional||"");this.byId("id_Cfactur").setValue(t.clienteFacturacion||"");this.byId("idObje").setValue(t.objetivoAlcance||"");this.byId("idAsunyRestri").setValue(t.AsuncionesyRestricciones||"");this.byId("box_multiJuridica").setSelected(!!t.multijuridica);this.byId("box_pluriAnual").setSelected(!!t.pluriAnual);this.byId("slct_area").setSelectedKey(t.Area_ID||"");this.byId("slct_Jefe").setSelectedKey(t.jefeProyectID_ID||"");this.byId("slct_verti").setSelectedKey(t.Vertical_ID||"");this.byId("slct_inic").setSelectedKey(t.Iniciativa_ID||"");this.byId("idNatu").setSelectedKey(t.Naturaleza_ID||"");this.byId("date_inico").setDateValue(new Date(t.fechaInicio||""));this.byId("date_fin").setDateValue(new Date(t.fechaFin||""));this.byId("input0").setValue(oProjectData.codigoProyect);this.byId("input1").setValue(oProjectData.nameProyect);this.byId("box_pluriAnual").setSelected(oProjectData.pluriAnual);this.byId("id_Cfactur").setValue(oProjectData.clienteFacturacion);this.byId("box_multiJuridica").setSelected(oProjectData.multijuridica)}}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}},onFechaChange:function(){this.updateVizFrame1()},onPerfilChangeTabla1:function(e){this.updateRowData(e,"table_dimicFecha")},updateRowData:function(e,t){const a=e.getSource();var o=this.byId(t);var i=a.getParent();var n=o.indexOfItem(i);if(n===-1){console.error("Índice de la fila no encontrado. Verifica la estructura de la tabla.");return}var s=o.getItems();var r=s[n].getCells();if(!r||r.length===0){console.error("Datos de la fila no encontrados.");return}var c=a.getSelectedItem().getText();var l={Director:{PMJ:1370.88,2024:41,2025:15,2026:0,2027:0,2028:0,2029:0},"CG4.C":{PMJ:182.72,2024:5,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.A":{PMJ:331.24,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.B":{PMJ:225.11,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0}};var d=l[c];if(d){r[4].setText(d.PMJ);r[5].setText(d["2024"]);r[6].setText(d["2025"]);r[7].setText(d["2026"]);r[8].setText(d["2027"]);r[9].setText(d["2028"]);r[10].setText(d["2029"]);var u=d["2024"]+d["2025"];r[11].setText(u);var h=d.PMJ+u;r[12].setText(h);var f=["junio","julio","agosto"];var g=o.getColumns();for(var I=9;I<r.length;I++){var y=g[I].getHeader().getText().toLowerCase();if(f.some(e=>y.includes(e))){r[I].setText("4.00")}}}else{console.error(`No hay configuración definida para el valor seleccionado: ${c}`)}},updateVizFrame1:function(){var e=this.getView();var t=e.getModel("planning");var a=t.getData();var o=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var i=a.milestones.map(function(e){var t=e.fechaInicio?new Date(e.fechaInicio):null;var a=e.fechaFin?new Date(e.fechaFin):null;if(t&&a&&!isNaN(t)&&!isNaN(a)){var i=(a-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:o.format(t),fechaFin:o.format(a),duracion:i,label:`Inicio: ${o.format(t)}, Fin: ${o.format(a)}, Duración: ${i} días`}}else{return null}}).filter(Boolean);t.setProperty("/chartData",i);console.log(i);this._aChartData=i;var n={};i.forEach(function(e){if(e.fase==="Construcción"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Pruebas TQ"){n.fechaFinPruebasTQ=e.fechaFin}});var s=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:n.fechaInicioConstruccion,fechaFinPruebasTQ:n.fechaFinPruebasTQ}]});e.setModel(s,"fechasModel")},onSave:async function(e){let t=0;const a=this._sProjectID;const o=this._aChartData;const i=parseInt(this.byId("input0").getValue(),10);const n=this.byId("input1").getValue();const s=this.byId("box_pluriAnual").getSelected();const r=this.byId("id_Cfactur").getValue();const c=this.byId("box_multiJuridica").getSelected();const l=this.byId("date_inico").getDateValue();const d=this.byId("date_fin").getDateValue();const u=this.byId("int_clienteFun").getValue();const h=this.byId("idObje").getValue();const f=this.byId("idAsunyRestri").getValue();var g=this.byId("idNatu");var I=g.getSelectedKey();var y=this.byId("slct_area");var b=y.getSelectedKey();var m=this.byId("slct_Jefe");var v=m.getSelectedKey();var p=this.byId("slct_inic");var x=p.getSelectedKey();var T=this.byId("selc_Segui");var S=T.getSelectedKey();var _=this.byId("selc_ejcu");var D=_.getSelectedKey();var F=this.byId("slct_verti");var V=F.getSelectedKey();var w=this.byId("selct_Amrecp");var C=w.getSelectedKey();const P=(e,a)=>{if(!a||typeof a==="string"&&a.trim()===""){e.setValueState("Error");e.setValueStateText("Este campo es obligatorio");t++}else{e.setValueState("None")}};P(this.byId("input0"),i);P(this.byId("input1"),n);P(this.byId("id_Cfactur"),r);P(this.byId("int_clienteFun"),u);P(this.byId("idNatu"),I);if(t>0){const e=this.byId("idIniu");e.setCount(t);return}const M={codigoProyect:i,nameProyect:this.byId("input1").getValue(),pluriAnual:s,clienteFacturacion:r,multijuridica:c,Fechainicio:l,FechaFin:d,clienteFuncional:u,Naturaleza_ID:I,Area_ID:b,Iniciativa_ID:x,jefeProyectID_ID:v,objetivoAlcance:h,AsuncionesyRestricciones:f,Vertical_ID:V};try{let e;if(a){console.log(a);e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${a})`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)})}else{e=await fetch("/odata/v4/datos-cdo/DatosProyect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)});console.log("chartfata",o)}if(e.ok){const t=await e.json();const o=t.ID||a;console.log("Guardado con éxito. ID:",o);const i=this.getOwnerComponent().getRouter();i.navTo("app",{newId:o});console.log(i)}else{const t=await e.text();console.log("Error al guardar el proyecto:",t)}}catch(e){console.log("Error en la llamada al servicio:",e)}},onClearFields:function(){var e=this.getView();function t(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}if(e.getAggregation){const a=e.getMetadata().getAllAggregations();for(let o in a){const a=e.getAggregation(o);if(Array.isArray(a)){a.forEach(t)}else if(a instanceof sap.ui.core.Control){t(a)}}}}e.findAggregatedObjects(false,t)},onSelectIniMethod:function(e){this.onInputChange(e);this.onSelectOpx(e)},onselectmethodsetinfo:function(e){this.onInputChange(e);this.fechasDinamicas(e)},onAddRowPress:function(e){console.log(e);var t=this.byId(e);if(t){var a=new sap.m.ColumnListItem({cells:[new sap.m.Select({selectedKey:"{Vertical>valueVertical}",forceSelection:false,items:{path:"/Vertical",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreVertical}"})}}),new sap.m.Select({selectedKey:"{TipoServicio>valueTipoServ}",forceSelection:false,items:{path:"/TipoServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreTipoServ}"})}}),new sap.m.Select({selectedKey:"{PerfilServicio>valuePerfil}",forceSelection:false,items:{path:"/PerfilServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombrePerfil}"})}}),new sap.m.Input({value:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""})]});t.addItem(a)}else{console.error("No se encontró la tabla con ID: "+e)}},onDateChange:function(){this.updateVizFrame()},fechasDinamicas:function(e){var t=this.getView().byId("date_inico");var a=this.getView().byId("date_fin");if(!t||!a){console.error("Error: No se pudieron obtener los DatePickers.");return}var o=t.getDateValue();var i=a.getDateValue();if(!o||!i){console.log("Esperando a que se seleccionen ambas fechas.");return}var n=this.getMonthsDifference(o,i);var s=["tablaConsuExter","table_dimicFecha","tablaRecExterno"];s.forEach(function(e){var t=this.getView().byId(e);if(!t){console.error("Error: No se pudo obtener la tabla con ID "+e);return}var a=this.findTotalColumnIndex(t);if(a===-1){console.error("Error: No se encontró la columna 'Total1' en la tabla "+e);return}var s=t.getColumns().length;for(var r=s-1;r>a;r--){t.removeColumn(r)}for(var c=0;c<=n;c++){var l=new Date(o.getFullYear(),o.getMonth()+c,1);var d=l.getFullYear();var u=l.toLocaleString("default",{month:"long"});var h=d+"-"+u;var f=new sap.m.Column({header:new sap.m.Label({text:h}),width:"100px"});t.insertColumn(f,a+1+c)}var g=this.getView().byId("scroll_container_"+e);if(g){g.setHorizontal(true);g.setVertical(false);g.setWidth("100%")}console.log("startDate:",o);console.log("endDate:",i)},this)},findTotalColumnIndex:function(e){var t=e.getColumns();for(var a=0;a<t.length;a++){var o=t[a].getHeader();if(o&&o.getText()==="Total1"){return a}}return-1},getMonthsDifference:function(e,t){var a=(t.getFullYear()-e.getFullYear())*12;a-=e.getMonth();a+=t.getMonth();return a},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);console.log("Navigating to View1");e.navTo("appNoparame")},onSelectOpx:function(e){var t=e.getParameter("selectedItem").getKey();console.log(t);var a=this.getView().byId("table0");if(t==="Opex Servicios"){a.setVisible(false)}else{a.setVisible(true)}},onCheckBoxSelectMulti:function(e){console.log("onCheckBoxSelect called");var t=e.getSource();var a=t.getSelected();console.log("Checkbox selected: ",a);var o=this.byId("table_clienteFac");console.log("Table found: ",!!o);if(o){o.setVisible(a)}},onInputChange:function(){var e=this.getView();var t=this.byId("input0").getValue();var a=this.byId("input1").getValue();var o=this.byId("id_Cfactur").getValue();var i=this.byId("int_clienteFun").getValue();console.log(t,a);var n=this.byId("slct_area");var s="";var r="";if(n&&n.getSelectedItem()){s=n.getSelectedItem().getText();r=n.getSelectedItem().getKey();console.log("Selected Key:",r);console.log("Selected Text:",s)}var c=this.byId("slct_Jefe");var l="";if(c&&c.getSelectedItem()){l=c.getSelectedItem().getText();console.log("Selected Jefe Text:",l)}var d=this.byId("slct_client");var u="";if(d&&d.getSelectedItem()){u=d.getSelectedItem().getText();console.log("Selected Function Text:",u)}var h=this.byId("date_inico");var f=h?h.getDateValue():null;var g="";if(f){g=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(f)}var I=this.byId("slct_inic");var y="";if(I&&I.getSelectedItem()){y=I.getSelectedItem().getText();console.log("Selected Function Text:",y)}var b=this.byId("idNatu");var m="";if(b&&b.getSelectedItem()){m=b.getSelectedItem().getText();console.log("Selected Function Text:",m)}var v=this.byId("date_fin");var p=v?v.getDateValue():null;var x="";if(p){x=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(p)}console.log("Formatted Start Date: ",g);console.log("Formatted End Date: ",x);this.byId("txt_codig").setText(t);this.byId("txt_nomPro").setText(a);this.byId("txt_area").setText(s);this.byId("txt_NomJefe").setText(l);this.byId("txt_funcio").setText(i);this.byId("txt_feIni").setText(g);this.byId("txt_feFin").setText(x);this.byId("txt_ini").setText(y);this.byId("txt_client").setText(i);this.byId("txt_cFactura").setText(o);this.byId("txt_Codi2").setText(t);this.byId("txt_Nombre2").setText(a);this.byId("txt_area2").setText(s);this.byId("txt_Fe_ini2").setText(g);this.byId("txt_Fe_fin2").setText(x);this.byId("textClitFu3").setText(i);this.byId("textCliFac3").setText(o);this.byId("textCodigo3").setText(t);this.byId("textNatural3").setText(m);this.byId("txtNombre3").setText(a);this.byId("txtAre3").setText(s);this.byId("txtFechInici3").setText(g);this.byId("txtFechFin3").setText(x)},onSelectCheckbox:function(e){try{var t=this.byId("table2");if(!t){console.error("Tabla no encontrada.");return}var a=t.getItems();var o=e.getSource().getSelected();if(o===undefined){console.error("Error al obtener el estado del checkbox.");return}var i=e.getSource().getParent().getParent().indexOfColumn(e.getSource().getParent());var n=i===0?"box_prove":"box_condi";var s=this.byId(n);if(!s){console.error("El otro checkbox no se encontró.");return}s.setEnabled(!o);a.forEach(function(e){var t=e.getCells();t.forEach(function(e,t){if(e.setEditable){e.setEditable(t===i?o:!o)}})})}catch(e){console.error("Error en la función onSelectCheckbox:",e)}}})});
//# sourceMappingURL=View1.controller.js.map