sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/format/DateFormat","sap/viz/ui5/controls/VizFrame","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/json/JSONModel"],function(e,t,a,o,i,n,r,s,c){"use strict";return e.extend("project1.controller.View1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({milestones:[{fase:"Kick off",fechaInicio:null,fechaFin:null},{fase:"Diseño",fechaInicio:null,fechaFin:null},{fase:"Construcción",fechaInicio:null,fechaFin:null},{fase:"Pruebas TQ",fechaInicio:null,fechaFin:null},{fase:"Go live",fechaInicio:null,fechaFin:null},{fase:"Paso AM",fechaInicio:null,fechaFin:null},{fase:"Server post/prod",fechaInicio:null,fechaFin:null}],chartData:[]});this.getView().setModel(e,"planning");console.log(e);this.updateVizFrame1()},onFechaChange:function(){this.updateVizFrame1()},onPerfilChangeTabla1:function(e){this.updateRowData(e,"table_dimicFecha")},updateRowData:function(e,t){const a=e.getSource();var o=this.byId(t);var i=a.getParent();var n=o.indexOfItem(i);if(n===-1){console.error("Índice de la fila no encontrado. Verifica la estructura de la tabla.");return}var r=o.getItems();var s=r[n].getCells();if(!s||s.length===0){console.error("Datos de la fila no encontrados.");return}var c=a.getSelectedItem().getText();var l={Director:{PMJ:1370.88,2024:41,2025:15,2026:0,2027:0,2028:0,2029:0},"CG4.C":{PMJ:182.72,2024:5,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.A":{PMJ:331.24,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.B":{PMJ:225.11,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0}};var d=l[c];if(d){s[4].setText(d.PMJ);s[5].setText(d["2024"]);s[6].setText(d["2025"]);s[7].setText(d["2026"]);s[8].setText(d["2027"]);s[9].setText(d["2028"]);s[10].setText(d["2029"]);var u=d["2024"]+d["2025"];s[11].setText(u);var f=d.PMJ+u;s[12].setText(f);var h=["junio","julio","agosto"];var g=o.getColumns();for(var I=9;I<s.length;I++){var m=g[I].getHeader().getText().toLowerCase();if(h.some(e=>m.includes(e))){s[I].setText("4.00")}}}else{console.error(`No hay configuración definida para el valor seleccionado: ${c}`)}},pruebaCambioDIner:function(){const e=this.byId("selct3").getSelectedItem().getText();const t=this.byId("select4").getSelectedItem().getText();const a=this.byId("select409").getSelectedItem().getText();const o=this.byId("seect4").getSelectedItem().getText();const i=this.byId("select6").getSelectedItem().getText();const n=this.byId("select6543").getSelectedItem().getText();const r=this.byId("select16").getSelectedItem().getText();const s=this.byId("select6544").getSelectedItem().getText();const c=this.byId("select065443").getSelectedItem().getText();var l=this.byId("pmj1");var d=this.byId("pmj2");var u=this.byId("pmj3");var f=this.byId("pmj4");var h=this.byId("pmj5");var g=this.byId("pmj6");var I=this.byId("pmj7");var m=this.byId("pmj8");var b=this.byId("pmj9");console.log(e);if(e==="Director"||t==="Director"||a==="Director"||o==="Director"||i==="Director"||n==="Director"||r==="Director"||s==="Director"||c==="Director"){l.setText("13000")}},updateVizFrame1:function(){var e=this.getView();var t=e.getModel("planning");var a=t.getData();var o=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var i=a.milestones.map(function(e){var t=e.fechaInicio?new Date(e.fechaInicio):null;var a=e.fechaFin?new Date(e.fechaFin):null;if(t&&a&&!isNaN(t)&&!isNaN(a)){var i=(a-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:o.format(t),fechaFin:o.format(a),duracion:i,label:`Inicio: ${o.format(t)}, Fin: ${o.format(a)}, Duración: ${i} días`}}else{return null}}).filter(Boolean);t.setProperty("/chartData",i);var n={};i.forEach(function(e){if(e.fase==="Construcción"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Pruebas TQ"){n.fechaFinPruebasTQ=e.fechaFin}});var r=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:n.fechaInicioConstruccion,fechaFinPruebasTQ:n.fechaFinPruebasTQ}]});e.setModel(r,"fechasModel")},onSave:async function(){let e=0;const t=parseInt(this.byId("input0").getValue(),10);const a=this.byId("input1").getValue();const o=this.byId("box_pluriAnual").getSelected();const i=this.byId("id_Cfactur").getValue();const n=this.byId("box_multiJuridica").getSelected();const r=this.byId("date_inico").getDateValue();const s=this.byId("date_fin").getDateValue();const c=this.byId("int_clienteFun").getValue();const l=this.byId("idObje").getValue();const d=this.byId("idAsunyRestri").getValue();var u=this.byId("idNatu");var f=u.getSelectedKey();var h=this.byId("slct_area");var g=h.getSelectedKey();var I=this.byId("slct_Jefe");var m=I.getSelectedKey();var b=this.byId("slct_inic");var v=b.getSelectedKey();var y=this.byId("selc_Segui");var x=y.getSelectedKey();var p=this.byId("selc_ejcu");var T=p.getSelectedKey();var S=this.byId("slct_verti");var D=S.getSelectedKey();var F=this.byId("selct_Amrecp");var _=F.getSelectedKey();const C=(t,a)=>{if(!a||typeof a==="string"&&a.trim()===""){t.setValueState("Error");t.setValueStateText("Este campo es obligatorio");e++}else{t.setValueState("None")}};C(this.byId("input0"),t);C(this.byId("input1"),a);C(this.byId("id_Cfactur"),i);C(this.byId("int_clienteFun"),c);C(this.byId("idNatu"),f);if(e>0){const t=this.byId("idIniu");t.setCount(e);return}const V={codigoProyect:t,nameProyect:this.byId("input1").getValue(),pluriAnual:o,clienteFacturacion:i,multijuridica:n,Fechainicio:r,FechaFin:s,clienteFuncional:c,Naturaleza_ID:f,Area_ID:g,Iniciativa_ID:v,jefeProyectID_ID:m,objetivoAlcance:l,AsuncionesyRestricciones:d,Vertical_ID:D};try{const e=await fetch("/odata/v4/datos-cdo/DatosProyect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)});if(e.ok){const t=await e.json();const a=t.ID;console.log("Producto guardado con éxito.",a)}else{const t=await e.text();console.error("Error al guardar el producto:",t)}}catch(e){if(e.message.includes("401")){console.error("Token expirado o inválido, redirigiendo al inicio de sesión.")}else{console.error("Error en la llamada al servicio:",e)}}},onClearFields:function(){var e=this.getView();function t(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}if(e.getAggregation){const a=e.getMetadata().getAllAggregations();for(let o in a){const a=e.getAggregation(o);if(Array.isArray(a)){a.forEach(t)}else if(a instanceof sap.ui.core.Control){t(a)}}}}e.findAggregatedObjects(false,t)},onSelectIniMethod:function(e){this.onInputChange(e);this.onSelectOpx(e)},onselectmethodsetinfo:function(e){this.onInputChange(e);this.fechasDinamicas(e)},onAddRowPress:function(e){console.log(e);var t=this.byId(e);if(t){var a=new sap.m.ColumnListItem({cells:[new sap.m.Select({selectedKey:"{Vertical>valueVertical}",forceSelection:false,items:{path:"/Vertical",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreVertical}"})}}),new sap.m.Select({selectedKey:"{TipoServicio>valueTipoServ}",forceSelection:false,items:{path:"/TipoServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreTipoServ}"})}}),new sap.m.Select({selectedKey:"{PerfilServicio>valuePerfil}",forceSelection:false,items:{path:"/PerfilServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombrePerfil}"})}}),new sap.m.Input({value:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""})]});t.addItem(a)}else{console.error("No se encontró la tabla con ID: "+e)}},onDateChange:function(){this.updateVizFrame()},fechasDinamicas:function(e){var t=this.getView().byId("date_inico");var a=this.getView().byId("date_fin");if(!t||!a){console.error("Error: No se pudieron obtener los DatePickers.");return}var o=t.getDateValue();var i=a.getDateValue();if(!o||!i){console.log("Esperando a que se seleccionen ambas fechas.");return}var n=this.getMonthsDifference(o,i);var r=["tablaConsuExter","table_dimicFecha","tablaRecExterno"];r.forEach(function(e){var t=this.getView().byId(e);if(!t){console.error("Error: No se pudo obtener la tabla con ID "+e);return}var a=this.findTotalColumnIndex(t);if(a===-1){console.error("Error: No se encontró la columna 'Total1' en la tabla "+e);return}var r=t.getColumns().length;for(var s=r-1;s>a;s--){t.removeColumn(s)}for(var c=0;c<=n;c++){var l=new Date(o.getFullYear(),o.getMonth()+c,1);var d=l.getFullYear();var u=l.toLocaleString("default",{month:"long"});var f=d+"-"+u;var h=new sap.m.Column({header:new sap.m.Label({text:f}),width:"100px"});t.insertColumn(h,a+1+c)}var g=this.getView().byId("scroll_container_"+e);if(g){g.setHorizontal(true);g.setVertical(false);g.setWidth("100%")}console.log("startDate:",o);console.log("endDate:",i)},this)},findTotalColumnIndex:function(e){var t=e.getColumns();for(var a=0;a<t.length;a++){var o=t[a].getHeader();if(o&&o.getText()==="Total1"){return a}}return-1},getMonthsDifference:function(e,t){var a=(t.getFullYear()-e.getFullYear())*12;a-=e.getMonth();a+=t.getMonth();return a},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);console.log("Navigating to View1");e.navTo("app")},onSelectOpx:function(e){var t=e.getParameter("selectedItem").getKey();console.log(t);var a=this.getView().byId("table0");if(t==="Opex Servicios"){a.setVisible(false)}else{a.setVisible(true)}},onCheckBoxSelectMulti:function(e){console.log("onCheckBoxSelect called");var t=e.getSource();var a=t.getSelected();console.log("Checkbox selected: ",a);var o=this.byId("table_clienteFac");console.log("Table found: ",!!o);if(o){o.setVisible(a)}},onInputChange:function(){var e=this.getView();var t=this.byId("input0").getValue();var a=this.byId("input1").getValue();var o=this.byId("id_Cfactur").getValue();var i=this.byId("int_clienteFun").getValue();console.log(t,a);var n=this.byId("slct_area");var r="";var s="";if(n&&n.getSelectedItem()){r=n.getSelectedItem().getText();s=n.getSelectedItem().getKey();console.log("Selected Key:",s);console.log("Selected Text:",r)}var c=this.byId("slct_Jefe");var l="";if(c&&c.getSelectedItem()){l=c.getSelectedItem().getText();console.log("Selected Jefe Text:",l)}var d=this.byId("slct_client");var u="";if(d&&d.getSelectedItem()){u=d.getSelectedItem().getText();console.log("Selected Function Text:",u)}var f=this.byId("date_inico");var h=f?f.getDateValue():null;var g="";if(h){g=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(h)}var I=this.byId("slct_inic");var m="";if(I&&I.getSelectedItem()){m=I.getSelectedItem().getText();console.log("Selected Function Text:",m)}var b=this.byId("idNatu");var v="";if(b&&b.getSelectedItem()){v=b.getSelectedItem().getText();console.log("Selected Function Text:",v)}var y=this.byId("date_fin");var x=y?y.getDateValue():null;var p="";if(x){p=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(x)}console.log("Formatted Start Date: ",g);console.log("Formatted End Date: ",p);this.byId("txt_codig").setText(t);this.byId("txt_nomPro").setText(a);this.byId("txt_area").setText(r);this.byId("txt_NomJefe").setText(l);this.byId("txt_funcio").setText(i);this.byId("txt_feIni").setText(g);this.byId("txt_feFin").setText(p);this.byId("txt_ini").setText(m);this.byId("txt_client").setText(i);this.byId("txt_cFactura").setText(o);this.byId("txt_Codi2").setText(t);this.byId("txt_Nombre2").setText(a);this.byId("txt_area2").setText(r);this.byId("txt_Fe_ini2").setText(g);this.byId("txt_Fe_fin2").setText(p);this.byId("textClitFu3").setText(i);this.byId("textCliFac3").setText(o);this.byId("textCodigo3").setText(t);this.byId("textNatural3").setText(v);this.byId("txtNombre3").setText(a);this.byId("txtAre3").setText(r);this.byId("txtFechInici3").setText(g);this.byId("txtFechFin3").setText(p)},onSelectCheckbox:function(e){try{var t=this.byId("table2");if(!t){console.error("Tabla no encontrada.");return}var a=t.getColumns();var o=t.getItems();var i=e.getSource()?.getSelected();if(i===undefined){console.error("Error al obtener el estado del checkbox.");return}var n=e.getSource().getParent().getParent().indexOfColumn(e.getSource().getParent());var r=n===0?"box_prove":"box_condi";var s=this.byId(r);if(!s){console.error("El otro checkbox no se encontró.");return}s.setEnabled(!i);a.forEach(function(e,t){o.forEach(function(e){var a=e.getCells()[t];if(a&&a.setEditable){a.setEditable(t===n?i:!i)}})})}catch(e){console.error("Error en la función onSelectCheckbox:",e)}}})});
//# sourceMappingURL=View1.controller.js.map