sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/format/DateFormat","sap/viz/ui5/controls/VizFrame","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,o,a,s,n,r,i,l,c,d){"use strict";return e.extend("project1.controller.View1",{recursoID:null,onInit:function(){var e=new sap.ui.model.json.JSONModel({milestones:[{fase:"Kick off",fechaInicio:null,fechaFin:null},{fase:"Dise√±o",fechaInicio:null,fechaFin:null},{fase:"Construcci√≥n",fechaInicio:null,fechaFin:null},{fase:"Pruebas TQ",fechaInicio:null,fechaFin:null},{fase:"Go live",fechaInicio:null,fechaFin:null},{fase:"Paso AM",fechaInicio:null,fechaFin:null},{fase:"Server post/prod",fechaInicio:null,fechaFin:null}],chartData:[]});this.getView().setModel(e,"planning");var t=this.byId("idVizFrame");t.setVizProperties({title:{text:"Planificacion"}});var o=[{feed:"color",palette:["#f7f7ff","#0066ff","#c5f8f9","#75c0c7","#f3e996","#d6786b","#e1c3f4"]}];var a={replace:true};t.setVizScales(o,a);this._tableValues={tablaConsuExter:{},table_dimicFecha:{},tablaRecExterno:{},idOtroserConsu:{},idGastoViajeConsu:{},idServiExterno:{},idGastoRecuExter:{},tablaInfrestuctura:{},tablaLicencia:{},tableServicioInterno:{},tablGastoViajeInterno:{}};this._editedRows=this._editedRows||{};this._rowYearlySums=this._rowYearlySums||{};this.currentRow=0;this.currentTable=0;var s=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:"2024-09-01",fechaFinPruebasTQ:"2024-09-30"}]});this.getView().setModel(s,"fechasModel");var n=this.byId("idVizFrame2");n.setVizProperties({title:{text:"Plan"}});this.updateVizFrame1();this.updateVizFrame3();this.updateVizFrame2();this._yearlySums={2024:0,2025:0,2026:0,2027:0,2028:0,2029:0};this.token();this.getUserInfo();this.onColumnTotales();this._mode="";const r=new sap.ui.model.json.JSONModel({mode:""});this.getView().setModel(r,"viewModel");const i=sap.ui.core.UIComponent.getRouterFor(this);["viewWithMode","viewNoParam","view","viewWithAprobacion"].forEach(function(e){i.getRoute(e).attachPatternMatched(this._onObjectMatched,this)},this);this.enviarID();this.byId("coste6552").setVisible(false);this._handleInputChangeCounter=0},refreshODataModel:function(){const e=this.getOwnerComponent().getModel();if(e&&typeof e.refresh==="function"){e.refresh()}const t=this.getView();if(t.getElementBinding()){t.getElementBinding().refresh(true)}},onInfoPress:function(e){if(!this._oPopover){this._oPopover=this.byId("infoPopover")}this._oPopover.openBy(e.getSource())},onInfoPressRecursos:function(e){if(!this._oPopover){this._oPopover=this.byId("infoPopoverRecursos")}this._oPopover.openBy(e.getSource())},onInfoGeneralPress:function(e){if(!this._oPopoverGeneral){this._oPopoverGeneral=this.byId("infoPopoverGeneral")}this._oPopoverGeneral.openBy(e.getSource())},onTipoCambioLive:function(e){var t=e.getSource();var o=t.getValue().trim();if(o===""){return}var a=parseFloat(o);if(!isNaN(a)){t.setValue(a.toFixed(4))}},highlightControls:function(){const e=[this.byId("input0"),this.byId("input1"),this.byId("idDescripcion"),this.byId("int_clienteFun"),this.byId("id_Cfactur"),this.byId("idObje"),this.byId("idAsunyRestri"),this.byId("box_multiJuridica"),this.byId("box_pluriAnual"),this.byId("slct_area"),this.byId("slct_Jefe"),this.byId("slct_verti"),this.byId("slct_inic"),this.byId("idNatu"),this.byId("selct_Amrecp"),this.byId("selc_ejcu"),this.byId("selc_Segui"),this.byId("slct_client"),this.byId("date_inico"),this.byId("date_fin")];setTimeout(()=>{e.forEach(e=>{if(e&&e.setValueState){e.setValueState("Information")}});setTimeout(()=>{e.forEach(e=>{if(e&&e.setValueState){e.setValueState("None")}})},2e3)},50)},getUserInfo:async function(){fetch("/odata/v4/datos-cdo/getUserInfo").then(e=>{if(!e.ok){throw new Error("No se pudo obtener la informaci√≥n del usuario.")}return e.json()}).then(e=>{const t=e.value;const o=e.token||t&&t.token;if(t){const e=this.byId("dddtg");e?.setText(t.email);e?.setTooltip(t.email);this.byId("23d3")?.setText(t.fullName);this._user=t.email;const a=t.roles||{};const s=Object.keys(a);console.log("Roles del usuario  View:",s);this._userRoles=s;const n=["Control","Direccion","BasisTQFac","PMO"];this._userPuedeAprobar=n.some(e=>s.includes(e));this.getUsuario();if(o){this._startSessionWatcher(o)}else{console.warn("Token no recibido en la respuesta.")}}else{console.error("No se encontr√≥ la informaci√≥n del usuario.")}}).catch(e=>{console.error("Error obteniendo datos del usuario:",e)})},_startSessionWatcher:function(e){const t=this._parseJwt(e);const o=t.exp*1e3;const a=Date.now();const s=o-a-1*60*1e3;if(s>0){setTimeout(()=>{this._showSessionWarning(o)},s)}else{this._showSessionWarning(o)}},_showSessionWarning:function(e){let t=Math.floor((e-Date.now())/1e3);const o=setInterval(()=>{if(t<=0){clearInterval(o);d.error("‚õî Tu sesi√≥n ha expirado. (En pruebas: no se cerrar√° la sesi√≥n)");return}if(a&&a.getContent&&a.getContent()[0]){a.getContent()[0].setText(`Tu sesi√≥n expirar√° en ${t} segundos. ¬øDeseas continuar?`)}t--},1e3);const a=new sap.m.Dialog({title:"‚ö†Ô∏è Sesi√≥n a punto de expirar",content:[new sap.m.Text({text:`Tu sesi√≥n expirar√° en ${t} segundos. ¬øDeseas continuar?`})],beginButton:new sap.m.Button({text:"S√≠, mantener sesi√≥n",press:()=>{clearInterval(o);a.close();this._refreshToken()}}),endButton:new sap.m.Button({text:"No",press:()=>{clearInterval(o);a.close()}}),afterClose:()=>{a.destroy()}});a.open()},_parseJwt:function(e){const t=e.split(".")[1];const o=atob(t.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(decodeURIComponent(escape(o)))},_refreshToken:async function(){try{const e=await fetch("/odata/v4/datos-cdo/getUserInfo",{method:"GET"});const t=await e.json();const o=t.token||t.value&&t.value.token;if(o){this._startSessionWatcher(o);d.success("Sesi√≥n renovada.")}else{throw new Error("Token no recibido.")}}catch(e){d.error("No se pudo renovar la sesi√≥n: "+e.message)}},onEmailPress:function(e){const t=e.getSource().getText();window.location.href="mailto:"+t},_resetButtonHandlers:function(){const e=this.byId("btnAceptar");const t=this.byId("btnBorrado");if(e){e.detachPress(this._onDecisionPress,this);e.detachPress(this.onSave,this);e.detachPress(this.onClearFields,this);e.detachPress(this.onBorrador,this)}if(t){t.detachPress(this._onDecisionPress,this);t.detachPress(this.onSave,this);t.detachPress(this.onClearFields,this);t.detachPress(this.onBorrador,this)}},resetFormUI:function(){var e=this.getView().findAggregatedObjects(true,function(e){return e.isA("sap.m.Input")||e.isA("sap.m.TextArea")||e.isA("sap.m.CheckBox")||e.isA("sap.m.ComboBox")||e.isA("sap.m.DatePicker")});e.forEach(function(e){if(e.setEnabled){e.setEnabled(true)}if(e.setEditable){e.setEditable(true)}if(e.setValue){e.setValue("")}})},_onObjectMatched:async function(e){this._resetButtonHandlers();const t=e.getParameter("arguments");let o=t.sProjectID;let a=t.sourceModel||"modelPendientes";const s=t.mode||"display";let n=this._parseAprobacionFlag(t,a);if(a.includes(";")){a=a.split(";")[0]}const r=this.byId("btnAceptar");const i=this.byId("btnBorrado");this._mode=s;this.getView().getModel("viewModel").setProperty("/mode",s);if(s==="create"){await this._clearAllInputs()}else if(s==="edit"){this._clearAllInputsEdit()}r.setEnabled(true);r.setText("Enviar");r.setType(sap.m.ButtonType.Accept);r.attachPress(this.onSave,this);i.setEnabled(true);i.setText("Guardar");i.setType(sap.m.ButtonType.Emphasized);i.attachPress(this.onBorrador,this);if(s==="display"&&(a==="modelAprobados"||a==="modelEtapasAsignadas"||a==="modelRechazados")){this._Visualizar(o,a);return}this._configureButtons(a,n,s);this._sProjectID=o;if(o){try{const e=await this._fetchProjectData(o);await this._populateViewWithData(e)}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}}},_parseAprobacionFlag:function(e,t){let o=false;if(t.includes(";")){const e=t.split(";");t=e[0];e.slice(1).forEach(e=>{const[t,a]=e.split("=");if(t==="aprobacion"){o=a==="true"}})}else{o=e.aprobacion==="true"}return o},_configureButtons:function(e,t,o){const a=this.byId("btnAceptar");const s=this.byId("btnBorrado");if(!a||!s)return;a.detachPress(this.onSave,this);a.removeAllCustomData();s.detachPress(this.onBorrador,this);s.removeAllCustomData();if(o==="display"){a.setEnabled(false);a.setText("Enviar");a.setType(sap.m.ButtonType.Accept);s.setEnabled(false);s.setText("Guardar");s.setType(sap.m.ButtonType.Emphasized);return}if(e==="modelBorrador"||o==="create"){this._isAprobacion=false;a.setEnabled(true);a.setText("Enviar");a.setType(sap.m.ButtonType.Accept);a.attachPress(this.onSave,this);s.setEnabled(true);s.setText("Guardar como borrador");s.setType(sap.m.ButtonType.Emphasized);s.attachPress(this.onBorrador,this);var n=new Date;var r=n.getDay();var i=n.getHours();if(r===3&&i>=12){var l=this.byId("btnAceptar");l.setEnabled(false);d.error("El env√≠o est√° deshabilitado los mi√©rcoles por revisi√≥n interna. Intenta ma√±ana.",{title:"Env√≠o bloqueado"});return}return}if(e==="modelPendientes"||o==="edit"){this._isAprobacion=false;a.setEnabled(true);a.setText("Enviar");a.setType(sap.m.ButtonType.Accept);a.attachPress(this.onSave,this);s.setEnabled(false);s.setText("Guardar como borrador");s.setType(sap.m.ButtonType.Transparent);s.attachPress(this.onBorrador,this);return}a.setEnabled(true);a.setText("Enviar");a.setType(sap.m.ButtonType.Accept);a.attachPress(this.onSave,this);s.setEnabled(true);s.setText("Guardar");s.setType(sap.m.ButtonType.Transparent);s.attachPress(this.onBorrador,this)},_fetchProjectData:async function(e){const t=this._sCsrfToken;const o=`/odata/v4/datos-cdo/DatosProyect(${e})`;const a=await fetch(o,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":t}});if(!a.ok){const e=await a.text();throw new Error("Network response was not ok: "+e)}return await a.json()},_populateViewWithData:async function(e){if(!e)return;this.byId("input0").setValue(e.codigoProyect||"");this.byId("input1").setValue(e.nameProyect||"");this.byId("area0").setValue(e.datosExtra||"");this.byId("inputCambioEu").setValue(e.CambioEuRUSD||"");this.byId("23d3").setText(e.Empleado||"");this.byId("ofertaCheckBox").setSelected(e.Oferta===true||e.Oferta==="true");this.byId("idComentariosFac").setValue(e.comentarioFacturacion||"");this.byId("idComentarioTipo").setValue(e.comentarioTipoCompra||"");this.byId("idCheckMensual").setSelected(!!e.mensual);this.byId("idTextComProve").setValue(e.comentarioProveedor||"");this.byId("idComenpVd").setValue(e.comentarioPvD||"");this.byId("dddtg").setText(e.Email||"");this.byId("int_clienteFun").setValue(e.funcionalString||"");this.byId("id_Cfactur").setValue(e.clienteFacturacion||"");this.byId("idObje").setValue(e.objetivoAlcance||"");this.byId("idDescripcion").setValue(e.descripcion||"");this.byId("input0_1725625161348").setValue(e.Total||"");this.byId("idAsunyRestri").setValue(e.AsuncionesyRestricciones||"");this.byId("box_multiJuridica").setSelected(!!e.multijuridica);this.byId("box_pluriAnual").setSelected(!!e.pluriAnual);this.byId("slct_area").setSelectedKey(e.Area_ID||"");this.byId("slct_Jefe").setSelectedKey(e.jefeProyectID_ID||"");this.byId("selectMotivo").setSelectedKey(e.MotivoCondi_ID||"");this.byId("select_tipoCom").setSelectedKey(e.TipoCompra_ID||"");this.byId("slct_verti").setSelectedKey(e.Vertical_ID||"");this.byId("slct_inic").setSelectedKey(e.Iniciativa_ID||"");this.byId("idNatu").setSelectedKey(e.Naturaleza_ID||"");this.byId("selct_Amrecp").setSelectedKey(e.AmReceptor_ID||"");this.byId("selc_ejcu").setSelectedKey(e.EjecucionVia_ID||"");this.byId("selc_Segui").setSelectedKey(e.Seguimiento_ID||"");this.byId("slct_client").setSelectedKey(e.clienteFuncional_ID||"");this.byId("date_inico").setDateValue(e.Fechainicio?new Date(e.Fechainicio):null);this.byId("date_fin").setDateValue(e.FechaFin?new Date(e.FechaFin):null);this.byId("box_pluriAnual").setSelected(e.pluriAnual);this.byId("id_Cfactur").setValue(e.clienteFacturacion);this.byId("box_multiJuridica").setSelected(e.multijuridica);const t=e.Iniciativa_ID;this.byId("table0").setVisible(t==="323e4567-e89b-12d3-a456-426614174002");this.byId("idCheckMensual").setVisible(t==="323e4567-e89b-12d3-a456-426614174002");this.byId("idComentarioTipo").setVisible(t==="323e4567-e89b-12d3-a456-426614174002");this.byId("idComenpVd").setEditable(t==="223e4567-e89b-12d3-a456-426614174001");this.onInputChange();await Promise.all([this.fetchMilestones(this._sProjectID),this.leerProveedor(this._sProjectID),this.leerFacturacion(this._sProjectID),this.leerClientFactura(this._sProjectID),this.leerRecursos(this._sProjectID),this.leerConsumoExterno(this._sProjectID),this.leerGastoViajeConsu(this._sProjectID),this.leerRecursoExterno(this._sProjectID),this.leerOtrosServiExter(this._sProjectID),this.leerOtrosConcepto(this._sProjectID),this.leerSerivioInterno(this._sProjectID),this.leerGastoviajeInterno(this._sProjectID),this.leerConsuOtroServi(this._sProjectID),this.leerGastoViaExter(this._sProjectID),this.leerLicencias(this._sProjectID),this.leerPerfilJornadas(this._sProjectID),this.leerTotalRecursoInterno(this._sProjectID),this.leerTotalConsumoExter(this._sProjectID),this.leerTotalRecuExterTotal(this._sProjectID),this.leerWorkflowInstancias(this._sProjectID),this.leerTotalInfraestrLicencia(this._sProjectID),this.leerTotalResumenCostesTotal(this._sProjectID),this.getArchivosByProjectId(this._sProjectID)]);this.highlightControls();const o=this.byId("btnAceptar");if(!this._isAprobacion&&o){o.setText("Guardar")}new sap.m.Dialog({title:"Informaci√≥n",type:"Message",state:"Success",content:new sap.m.Text({text:"Datos cargados correctamente"}),beginButton:new sap.m.Button({text:"OK",press:function(){this.getParent().close()}}),afterClose:function(){this.destroy()}}).open()},onVerArchivo:function(e){const t=e.getSource();const o=t.getBindingContext("archivosModel");if(!o){sap.m.MessageToast.show("‚ö†Ô∏è No se pudo obtener el contexto del archivo.");return}const a=o.getProperty("ID");const s=o.getProperty("nombre");const n=o.getProperty("tipoMime");if(!a||!s||!n){sap.m.MessageToast.show("‚ö†Ô∏è Faltan datos para abrir o descargar el archivo.");return}this._descargarArchivo(a,s,n)},_descargarArchivo:async function(e,t,o){try{const a=await fetch(`/odata/v4/datos-cdo/Archivos('${e}')/contenido/$value`,{method:"GET"});if(!a.ok){const e=await a.text();throw new Error("‚ùå Error al descargar archivo: "+e)}const s=await a.blob();const n=URL.createObjectURL(new Blob([s],{type:o}));if(o.startsWith("image/")||o==="application/pdf"||o.startsWith("text/")){const e=window.open();e.document.write(`<title>${t}</title><iframe src="${n}" width="100%" height="100%"></iframe>`)}const r=document.createElement("a");r.href=n;r.download=t||"archivo";document.body.appendChild(r);r.click();document.body.removeChild(r)}catch(e){console.error("‚ùå Error en descarga:",e)}},getArchivosByProjectId:async function(e){try{const t=`/odata/v4/datos-cdo/Archivos?$filter=datosProyect_ID eq '${e}'`;const o=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!o.ok){const e=await o.text();throw new Error("Error en la respuesta de la API: "+e)}const a=await o.json();const s=a.value||[];const n=s.map(e=>e.ID);this._archivoIds=n;const r=new sap.ui.model.json.JSONModel({archivos:s});this.getView().setModel(r,"archivosModel")}catch(e){console.error("‚ùå Error al cargar archivos:",e);sap.m.MessageToast.show(e.message)}},_clearAllInputs:function(){const e=this.getView();const t=e.findElements(true);const o=e.getModel("planning");this._idWorkflowInstancias=null;this._idWorkIniciado=null;this._clearTableTextsOnly();this._IdFechasPorMesLicencia=null;this._IdFechasPorMesOtConp=null;this._IdFechasPorMesReEx=null;this._IdFechasPorMesSerReEx=null;this._IdFechasPorMesREExt=null;this._IdFechasPorMesGasViaConsuEx=null;this._IdFechasPorMesServiConsu=null;this._IdFechasPorMesConsuEx=null;this._IdFechasPorMesGVinter=null;this._IdFechasPorMesServInt=null;this._IdFechasPorMesGasViaConsuEx=[];this._IdFechasPorMes=[];this._RecursoInt=[];this._FacturacionID=null;this._aChartData=[];this._proveedoresIDs=[];this._recursosIDs=[];this._consumoExternosIDs=[];this._RecursoExterno=null;this._OtrosConceptos=null;this._idServiInterno=null;this._IdGastoViajInter=null;this._idConsuOtrser=null;this._idGastoViajeCOnsu=null;this._idOtroSerEx=null;this._idGasViaReEx=null;this._idLicencia=null;this._idJornadas=null;this._idTotalRecInter=null;this._selectedFile=null;const a=["tablaConsuExter","table_dimicFecha","tablaRecExterno","idOtroserConsu","idGastoViajeConsu","idServiExterno","idGastoRecuExter","tablaInfrestuctura","tablaLicencia","tableServicioInterno","tablGastoViajeInterno"];a.forEach(e=>{const t=this.byId(e);if(t){const e=t.getColumns();for(let o=e.length-1;o>=0;o--){const a=e[o].getHeader();if(a&&/\d{4}-\w+/.test(a.getText())){t.removeColumn(e[o])}}t.getItems().forEach(t=>{const o=t.getCells();for(let a=o.length-1;a>=0;a--){const s=o[a];const n=e[a]&&e[a].getHeader()?.getText();if(/\d{4}-\w+/.test(n)){t.removeCell(s)}}})}});const s=["txt_codig","txt_nomPro","txt_area","txt_NomJefe","txt_funcio","txt_feIni","txt_feFin","txt_ini","text72_1731325324246","text73_1731325328049","txt_client","txt_cFactura","txt_Codi2","txt_Nombre2","txt_area2","txt_Fe_ini2","txt_Fe_fin2","textClitFu3","textCliFac3","textCodigo3","textNatural3","txtNombre3","txtAre3","txtFechInici3","txtFechFin3"];s.forEach(e=>{const t=this.byId(e);if(t&&typeof t.setText==="function"){t.setText("")}});const n=["inputReInter","inputConsuEx","inputRcurExtern","inputTotalJor","inputServi1","inputOtrosServi1","inputGastoVia1","totalRecuInter","inputServi2","inputOtroSer2","input2_1756121205","inptGastoVi2","inputServi","input10_1724757017406","input9_1724757015442","totalInfraestruc","input0_1724758359","input0_1725625161348","input0_1725625132423424361348","totaRecurExterno","input0","totalConsuExternot","idComenpVd","idTextComProve","input0_1724758359","totalSubtotal","input2_1724756105"];t.forEach(e=>{if(e instanceof sap.m.Input||e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.Select){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null);e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}const t=e.getId().split("--").pop();const o=n.includes(t);if(!o){if(typeof e.setEditable==="function"){e.setEditable(true)}if(typeof e.setEnabled==="function"){e.setEnabled(true)}}});const r=["table0","idCheckMensual","idComentarioTipo","table_clienteFac"];r.forEach(e=>{const t=this.byId(e);if(t){t.setVisible(false)}});this.byId("text73_172746565340567").setText("");this.byId("text73_172746565340569997").setText("");if(o){o.setProperty("/chartData",[]);o.setProperty("/chartModel",[])}const i=this.getView().getModel("archivosModel");if(i){i.setProperty("/archivos",[])}this.refreshODataModel()},_clearAllInputsEdit:function(){const e=this.getView();const t=e.findElements(true);const o=e.getModel("planning");this._IdFechasPorMesGasViaConsuEx=[];this._IdFechasPorMes=[];this._RecursoInt=[];this._FacturacionID=null;this._aChartData=[];this._proveedoresIDs=[];this._recursosIDs=[];this._consumoExternosIDs=[];this._RecursoExterno=null;this._OtrosConceptos=null;this._idServiInterno=null;this._IdGastoViajInter=null;this._idConsuOtrser=null;this._idGastoViajeCOnsu=null;this._idOtroSerEx=null;this._idGasViaReEx=null;this._idLicencia=null;this._idJornadas=null;this._idTotalRecInter=null;this._selectedFile=null;this._clearTableTextsOnly();const a=["inputReInter","inputConsuEx","inputRcurExtern","inputTotalJor","inputServi1","inputOtrosServi1","inputGastoVia1","totalRecuInter","inputServi2","inputOtroSer2","inptGastoVi2","inputServi","input10_1724757017406","input9_1724757015442","totalSubtotal","input2_1724756105","input0_1724758359","totalInfraestruc","totaRecurExterno","input0","totalConsuExternot","idComenpVd","idTextComProve , input0_1724758359","input2_1756121205","input0_1725625161348","input0_1725625132423424361348"];t.forEach(e=>{const t=e.getId().split("--").pop();const o=a.includes(t);if(!o){if(typeof e.setEditable==="function"){e.setEditable(true)}if(typeof e.setEnabled==="function"){e.setEnabled(true)}}})},_clearTableTextsOnly:function(){const e=this.getView();const t=["tablaConsuExter","table_dimicFecha","tablaRecExterno","idOtroserConsu","idGastoViajeConsu","idServiExterno","idGastoRecuExter","tablaInfrestuctura","tablaLicencia","tableServicioInterno","tablGastoViajeInterno"];t.forEach(e=>{const t=this.byId(e);if(!t){console.warn(`Tabla no encontrada: ${e}`);return}const o=t.getItems();o.forEach(e=>{const t=e.getCells();t.forEach(e=>{if(e instanceof sap.m.Input||e instanceof sap.m.Text){if(typeof e.setValue==="function"){e.setValue("")}if(typeof e.setText==="function"){e.setText("")}}})})})},_onDecisionPress:function(e){const t=e.getSource().data("valor");console.log("DESAION "+t);if(t){this._completarWorkflow(t).catch(e=>{console.error("Error completando workflow:",e);sap.m.MessageBox.error("Hubo un error procesando la aprobaci√≥n.")});sap.m.MessageBox.information("La aprobaci√≥n se envi√≥ correctamente. Puede ir a la aplicaci√≥n para ver el estado del proceso de aprobaci√≥n.",{title:"Aprobaci√≥n enviada",onClose:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("appNoparame")}.bind(this)})}else{sap.m.MessageBox.warning("No se pudo determinar la decisi√≥n.")}},_Visualizar:async function(e,t){console.log("ENTRE A VISUALIZAR con ID:",t);const o=this.byId("btnAceptar");const a=this.byId("btnBorrado");o.detachPress(this.onSave,this);o.removeAllCustomData();a.detachPress(this.onBorrador,this);a.removeAllCustomData();const s=this.byId("idDelete");if(t==="modelEtapasAsignadas"){this._isAprobacion=true;s.setVisible(false);o.setEnabled(true);o.setText("Aprobar");o.setType(sap.m.ButtonType.Accept);o.data("valor","approve");o.attachPress(this._onDecisionPress,this);a.setEnabled(true);a.setText("Rechazar");a.setType(sap.m.ButtonType.Reject);a.data("valor","reject");a.attachPress(this._onDecisionPress,this)}else{o.setEnabled(false);a.setEnabled(false)}console.log("ENTRE A VISUALIZAR con ID:",e);this._configureButtonsForView();const n=this._sCsrfToken;const r=this.getView().getModel("mainService");if(r){r.setData({});r.refresh(true)}this._sProjectID=e;const i=`/odata/v4/datos-cdo/DatosProyect('${e}')`;try{const t=await fetch(i,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":n}});if(!t.ok){const e=await t.text();throw new Error("Network response was not ok: "+e)}const o=await t.json();if(o){this._fillControlsWithData(o);await Promise.all([this.fetchMilestones(e),this.leerProveedor(e),this.leerFacturacion(e),this.leerClientFactura(e),this.leerRecursos(e),this.leerConsumoExterno(e),this.leerGastoViajeConsu(e),this.leerRecursoExterno(e),this.leerOtrosServiExter(e),this.leerOtrosConcepto(e),this.leerSerivioInterno(e),this.leerGastoviajeInterno(e),this.leerConsuOtroServi(e),this.leerGastoViaExter(e),this.leerLicencias(e),this.leerPerfilJornadas(e),this.leerTotalRecursoInterno(e),this.leerTotalConsumoExter(e),this.leerTotalRecuExterTotal(e),this.leerWorkflowInstancias(e),this.leerTotalInfraestrLicencia(e),this.leerTotalResumenCostesTotal(e)]);this.highlightControls();this._setAllControlsEditable(false);this._showSuccessDialog("Datos cargados correctamente")}}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}},_configureButtonsForView:function(){if(this._isAprobacion){return}const e=this.byId("btnAceptar");const t=this.byId("btnBorrado");const o=this.byId("idDelete");e.setEnabled(false);t.setEnabled(false);o.setEnabled(false);e.setText("Enviar");e.setType(sap.m.ButtonType.Accept);t.setText("Guardar");t.setType(sap.m.ButtonType.Emphasized)},_fillControlsWithData:async function(e){this.byId("input0").setValue(e.codigoProyect||"");this.byId("input1").setValue(e.nameProyect||"");this.byId("area0").setValue(e.datosExtra||"");this.byId("inputCambioEu").setValue(e.CambioEuRUSD||"");this.byId("ofertaCheckBox").setSelected(e.Oferta===true||e.Oferta==="true");this.byId("23d3").setText(e.Empleado||"");this.byId("idComentariosFac").setValue(e.comentarioFacturacion||"");this.byId("idComentarioTipo").setValue(e.comentarioTipoCompra||"");this.byId("idCheckMensual").setSelected(!!e.mensual);this.byId("idTextComProve").setValue(e.comentarioProveedor||"");this.byId("idComenpVd").setValue(e.comentarioPvD||"");this.byId("dddtg").setText(e.Email||"");this.byId("int_clienteFun").setValue(e.funcionalString||"");this.byId("id_Cfactur").setValue(e.clienteFacturacion||"");this.byId("idObje").setValue(e.objetivoAlcance||"");this.byId("idDescripcion").setValue(e.descripcion||"");this.byId("input0_1725625161348").setValue(e.Total||"");this.byId("idAsunyRestri").setValue(e.AsuncionesyRestricciones||"");this.byId("box_multiJuridica").setSelected(!!e.multijuridica);this.byId("box_pluriAnual").setSelected(!!e.pluriAnual);this.byId("slct_area").setSelectedKey(e.Area_ID||"");this.byId("slct_Jefe").setSelectedKey(e.jefeProyectID_ID||"");this.byId("selectMotivo").setSelectedKey(e.MotivoCondi_ID||"");this.byId("select_tipoCom").setSelectedKey(e.TipoCompra_ID||"");this.byId("slct_verti").setSelectedKey(e.Vertical_ID||"");this.byId("slct_inic").setSelectedKey(e.Iniciativa_ID||"");this.byId("idNatu").setSelectedKey(e.Naturaleza_ID||"");this.byId("selct_Amrecp").setSelectedKey(e.AmReceptor_ID||"");this.byId("selc_ejcu").setSelectedKey(e.EjecucionVia_ID||"");this.byId("selc_Segui").setSelectedKey(e.Seguimiento_ID||"");this.byId("slct_client").setSelectedKey(e.clienteFuncional_ID||"");this.byId("date_inico").setDateValue(e.Fechainicio?new Date(e.Fechainicio):null);this.byId("date_fin").setDateValue(e.FechaFin?new Date(e.FechaFin):null);await this.onInputChange();if(e.Iniciativa_ID==="323e4567-e89b-12d3-a456-426614174002"){this.byId("table0").setVisible(true);this.byId("idCheckMensual").setVisible(true);this.byId("idComentarioTipo").setVisible(true)}else{this.byId("table0").setVisible(false);this.byId("idCheckMensual").setVisible(false);this.byId("idComentarioTipo").setVisible(false)}this.byId("idComenpVd").setEditable(e.Iniciativa_ID==="223e4567-e89b-12d3-a456-426614174001")},_showSuccessDialog:function(e){var t=new sap.m.Dialog({title:"Informaci√≥n",type:"Message",state:"Success",content:new sap.m.Text({text:e}),beginButton:new sap.m.Button({text:"OK",press:function(){t.close()}}),afterClose:function(){t.destroy()}});t.open()},_setAllControlsEditable:function(e){const t=this.getView();const o=["sap.m.Input","sap.m.TextArea","sap.m.Select","sap.m.CheckBox","sap.m.DatePicker"];o.forEach(o=>{t.findAggregatedObjects(true,function(e){return e.isA&&e.isA(o)}).forEach(function(t){if(t.setEditable){t.setEditable(e)}else if(t.setEnabled){t.setEnabled(e)}})})},enviarID:async function(e){const t=e;if(!t){d.error("No se ha definido el ID del workflow.");return}const o=this.getOwnerComponent().getModel();const a=o.bindContext(`/registrarTareasWorkflow(workflowInstanceId='${e}')`);try{await a.execute();const e=a.getBoundContext().getObject();console.log("Resultado:",e)}catch(e){d.error("Error al registrar tareas:\n"+e.message)}},_completarWorkflow:async function(e){const t=this._idWorkIniciado;const o=this._sProjectID;const a="Carolina Falen";console.log("ID DEL PROYECTO "+o);if(!t){sap.m.MessageBox.error("No se encontr√≥ el ID del flujo de trabajo.");return}const s=this.getOwnerComponent().getModel();const n=s.bindContext("/completeWorkflow(...)");n.setParameter("workflowInstanceId",t);n.setParameter("decision",e);n.setParameter("usuario",a);n.setParameter("idProject",o);try{await n.execute();const t=this._idWorkflowInstancias;if(!t){sap.m.MessageBox.error("No se encontr√≥ el ID de la instancia de workflow para actualizar el estado.");return}const o=`/odata/v4/datos-cdo/WorkflowInstancias(${t})`;let a;if(e==="approve"){a="Aprobado"}else if(e==="reject"){a="Rechazado"}else{a="Desconocido"}const s=(new Date).toISOString();const r=await fetch(o,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":this._sCsrfToken},body:JSON.stringify({estado:a,actualizadoEn:s})});if(!r.ok){const e=await r.text();throw new Error("Error actualizando el estado del proyecto: "+e)}}catch(e){sap.m.MessageBox.error("Error al completar el workflow: "+e.message)}},fetchMilestones:async function(e){if(!e){console.error("Error: projectID es inv√°lido o indefinido:",e);return}var t=`/odata/v4/datos-cdo/planificacion?$filter=datosProyect_ID eq '${e}'`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Error en la respuesta de la API: "+t)}const a=await e.json();if(!a||!a.value||!Array.isArray(a.value)||a.value.length===0){return}a.value.sort((e,t)=>new Date(e.fecha_inicio)-new Date(t.fecha_inicio));var o=this.getView().getModel("planning");let s={};a.value.forEach(e=>{let t=e.fecha_inicio?new Date(e.fecha_inicio).toISOString().split("T")[0]:null;let o=e.fecha_fin?new Date(e.fecha_fin).toISOString().split("T")[0]:null;s[e.hito]={fechaInicio:t,fechaFin:o}});const n=["Kick off","Dise√±o","Construcci√≥n","Pruebas TQ","Go live","Paso AM","Server post/prod"];n.forEach((e,t)=>{let a=`/milestones/${t}`;if(s[e]){o.setProperty(a+"/fechaInicio",s[e].fechaInicio);o.setProperty(a+"/fechaFin",s[e].fechaFin)}else{o.setProperty(a+"/fechaInicio",null);o.setProperty(a+"/fechaFin",null)}});this._idPlani=a.value[0].ID;this.updateVizFrame1(a)}catch(e){console.error("Error al obtener los datos de planificaci√≥n:",e)}},leerProveedor:async function(e){var t=`/odata/v4/datos-cdo/ProveedoresC?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("table2");var a=o.getItems();this._proveedoresIDs=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{var o=a[t];if(o){var s=o.getCells();if(s.length>1){s[0].setValue(e.valueCondi||"");s[1].setValue(e.valueProvee||"")}this._proveedoresIDs[t]=e.ID}});this.byId("box_condi").setSelected(s.value[0].checkCondi||false);this.byId("box_prove").setSelected(s.value[0].checkProveedor||false)}else{console.log("No hay datos de proveedores disponibles.")}}catch(e){console.error("Error al obtener los datos de proveedor:",e)}},leerFacturacion:async function(e){var t=`/odata/v4/datos-cdo/Facturacion?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("table0");var a=o.getItems();if(s.value&&s.value.length>0){s.value.forEach(function(e,t){var o=a[t];var s=o.getCells();if(a[t]){var s=a[t].getCells();if(s.length>1){if(s[0]instanceof sap.m.DatePicker){console.log("Tipo de celda:",s[0].constructor.name);s[0].setDateValue(e.fechaEstimida?new Date(e.fechaEstimida):null)}if(s[1]instanceof sap.m.Input){s[1].setValue(e.descripcionHito||"")}if(s[2]instanceof sap.m.Input){s[2].setValue(Math.round(e.facturacion))}}}});if(s.value[0]&&s.value[0].ID){this._FacturacionID=s.value[0].ID}this.metodoSumarFac()}else{}}catch(e){console.error("Error al obtener los datos de Facturaci√≥n:",e)}},leerClientFactura:async function(e){var t=`/odata/v4/datos-cdo/ClientFactura?$filter=datosProyect_ID eq ${e}&$orderby=ID asc`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const l=await e.json();var o=this.byId("table_clienteFac");var a=o.getItems();if(l.value&&l.value.length>0){let e=l.value.sort((e,t)=>e.ID-t.ID);for(let t=0;t<e.length;t++){let r=e[t];if(t>=a.length){let e=new sap.m.ColumnListItem({cells:[new sap.m.Input({value:r.juridica||""}),new sap.m.Input({value:r.oferta?`${r.oferta}%`:""})]});o.addItem(e);a.push(e)}var s=a[t];var n=s.getCells();if(n[0].getMetadata().getName()==="sap.m.Input"){n[0].setValue(r.juridica||"")}else if(n[0].getMetadata().getName()==="sap.m.Text"){n[0].setText(r.juridica||"")}if(n[1].getMetadata().getName()==="sap.m.Input"){let e=r.oferta?r.oferta.toString():"";e=e.replace("%","");n[1].setValue(e?`${e}%`:"")}else if(n[1].getMetadata().getName()==="sap.m.Text"){n[1].setText(r.oferta?`${r.oferta}%`:"")}}}this.metodoSumar();var r=this.byId("box_multiJuridica");var i=r.getSelected();this.onCheckBoxSelectMulti({getSource:()=>r,getSelected:()=>i})}catch(e){console.error("Error al obtener los datos de cliente Facturaci√≥n:",e)}},leerWorkflowInstancias:async function(e){var t=`/odata/v4/datos-cdo/WorkflowInstancias?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const n=await e.json();if(n.value&&n.value.length>0){var o=n.value[0];var a=o.ID;var s=o.workflowId;this._idWorkIniciado=s;this._idWorkflowInstancias=a}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerRecursos:async function(e){var t=`/odata/v4/datos-cdo/RecursosInternos?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("table_dimicFecha");var a=o.getItems();this._recursosIDs=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._recursosIDs[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[2].setSelectedKey(e.PerfilServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalE?parseFloat(e.totalE).toFixed(2):"0.00")}})}await this.fechasDinamicas();await this.leerFechas()}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e);sap.m.MessageToast.show("Error al cargar los datos de Recursos Internos")}},leerPerfilJornadas:async function(e){var t=`/odata/v4/datos-cdo/PerfilTotal?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("inputReInter").setValue(o.totalJorRI?parseFloat(o.totalJorRI).toFixed(2):"0.00");this.byId("inputConsuEx").setValue(o.totalJorCE?parseFloat(o.totalJorCE).toFixed(2):"0.00");this.byId("inputRcurExtern").setValue(o.totalJorRE?parseFloat(o.totalJorRE).toFixed(2):"0.00");this.byId("inputTotalJor").setValue(o.Total?parseFloat(o.Total).toFixed(2):"0.00");this._idJornadas=a}else{console.log("NO SE ENCONTRARON DATOS PARA PERFIL JORNADAS")}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerTotalRecursoInterno:async function(e){var t=`/odata/v4/datos-cdo/RecurInterTotal?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("inputServi1").setValue(o.servicios?parseFloat(o.servicios).toFixed(2):"0.00");this.byId("inputOtrosServi1").setValue(o.OtrosServicios?parseFloat(o.OtrosServicios).toFixed(2):"0.00");this.byId("inputGastoVia1").setValue(o.GastosdeViaje?parseFloat(o.GastosdeViaje).toFixed(2):"0.00");this.byId("totalRecuInter").setValue(o.Total?parseFloat(o.Total).toFixed(2):"0.00");this._idTotalRecInter=a}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerTotalConsumoExter:async function(e){var t=`/odata/v4/datos-cdo/ConsuExterTotal?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("inputServi2").setValue(o.servicios?parseFloat(o.servicios).toFixed(2):"0.00");this.byId("inputOtroSer2").setValue(o.OtrosServicios?parseFloat(o.OtrosServicios).toFixed(2):"0.00");this.byId("inptGastoVi2").setValue(o.GastosdeViaje?parseFloat(o.GastosdeViaje).toFixed(2):"0.00");this.byId("totalConsuExternot").setValue(o.Total?parseFloat(o.Total).toFixed(2):"0.00");this._idTotalConsuEx=a}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerTotalRecuExterTotal:async function(e){var t=`/odata/v4/datos-cdo/RecuExterTotal?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("inputServi").setValue(o.servicios?parseFloat(o.servicios).toFixed(2):"0.00");this.byId("input10_1724757017406").setValue(o.OtrosServicios?parseFloat(o.OtrosServicios).toFixed(2):"0.00");this.byId("input9_1724757015442").setValue(o.GastosdeViaje?parseFloat(o.GastosdeViaje).toFixed(2):"0.00");this.byId("totaRecurExterno").setValue(o.Total?parseFloat(o.Total).toFixed(2):"0.00");this._idtotalRecurExter=a}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerTotalInfraestrLicencia:async function(e){var t=`/odata/v4/datos-cdo/InfraestrLicencia?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("totalInfraestruc").setValue(o.totalInfraestruc?parseFloat(o.totalInfraestruc).toFixed(2):"0.00");this.byId("input0_1724758359").setValue(o.totalLicencia?parseFloat(o.totalLicencia).toFixed(2):"0.00");this._idInfraLicencia=a}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerTotalResumenCostesTotal:async function(e){var t=`/odata/v4/datos-cdo/ResumenCostesTotal?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();if(s.value&&s.value.length>0){var o=s.value[0];var a=o.ID;this.byId("totalSubtotal").setValue(o.Subtotal?parseFloat(o.Subtotal).toFixed(2):"0.00");this.byId("input2_172475612").setValue(o.CosteEstruPorce?parseFloat(o.CosteEstruPorce).toFixed(2):"0.00");this.byId("input2_1724756105").setValue(o.Costeestructura?parseFloat(o.Costeestructura).toFixed(2):"0.00");this.byId("input2_17221205").setValue(o.totalLicencias?parseFloat(o.totalLicencias).toFixed(2):"0.00");this.byId("input2_1756121205").setValue(o.Margeingresos?parseFloat(o.Margeingresos).toFixed(2):"0.00");this._ResumenTotal=a;this.onColumnTotales()}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerFechas:async function(){const e=this._recursosIDs;const t={};const o={};const a=e.map(async(e,t)=>{const a=`/odata/v4/datos-cdo/ValorMensuReInter?$filter=RecursosInternos_ID eq '${e}'`;try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});const n=await s.json();if(n.value&&n.value.length>0){}else{console.warn(`‚ö†Ô∏è Sin resultados para recursoID ${e}`)}const r={};n.value.forEach(e=>{const t=e.mesAno;r[t]=e.valor;o[t]=e.ID});this._IdFechasPorMes=o;this.rellenarInputsConFechas("table_dimicFecha",t,r);return{recursoID:e,data:n.value||[]}}catch(t){console.error(`‚ùå Error en consulta para recursoID ${e}:`,t);return{recursoID:e,error:t}}});const s=await Promise.all(a)},rellenarInputsConFechas:function(e,t,o){const a=this._inputsDinamicos?.[e]?.[t];if(!a){console.warn(`No existen inputs din√°micos para tabla ${e} fila ${t}`);return}for(const[s,n]of Object.entries(o)){const o=a[s];if(o){const e=Number(n).toFixed(2);o.setValue(e);o.fireChange({value:e})}else{console.warn(`No se encontr√≥ input para la fecha ${s} en tabla ${e}, fila ${t}`)}}},leerFechasServiRecInter:async function(){const e=this._idServiInterno;const t={};const o={};const a=e.map(async(e,t)=>{const a=`/odata/v4/datos-cdo/ValorMensuServReInter?$filter=otrosGastoRecu_ID eq '${e}'`;try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});const n=await s.json();if(n.value&&n.value.length>0){}else{console.warn(`‚ö†Ô∏è Sin resultados para servicioID ${e}`)}const r={};n.value.forEach(e=>{const t=e.mesAno;r[t]=e.valor;o[t]=e.ID});this._IdFechasPorMesServInt=o;this.rellenarInputsConFechas("tableServicioInterno",t,r);return{servicioID:e,data:n.value||[]}}catch(t){console.error(`‚ùå Error en consulta para servicioID ${e}:`,t);return{servicioID:e,error:t}}});const s=await Promise.all(a)},leerFechasGastoViajeRecInter:async function(){const e=this._IdGastoViajInter;const t={};const o={};const a=Array.isArray(e)?e:[e];const s=a.map(async(e,t)=>{const a=`/odata/v4/datos-cdo/ValorMensuGastViaReInter?$filter=otrosRecursos_ID eq '${e}'`;try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});const n=await s.json();if(n.value&&n.value.length>0){}else{console.warn(`‚ö†Ô∏è Sin resultados para recursoID ${e}`)}const r={};n.value.forEach(e=>{const t=e.mesAno;r[t]=e.valor;o[t]=e.ID});this._IdFechasPorMesGVinter=o;this._idGastInterno=n.value[0]?.ID||null;this.rellenarInputsConFechas("tablGastoViajeInterno",t,r);return{recursoID:e,data:n.value||[]}}catch(t){console.error(`‚ùå Error en consulta para recursoID ${e}:`,t);return{recursoID:e,error:t}}});const n=await Promise.all(s)},leerFechasConsumoExterno:async function(){const e=this._consumoExternosIDs;const t={};const o={};const a=e.map(async(e,t)=>{const a=`/odata/v4/datos-cdo/ValorMensuConsuEx?$filter=ConsumoExternos_ID eq '${e}'`;try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});const n=await s.json();if(n.value&&n.value.length>0){}else{console.warn(`‚ö†Ô∏è Sin resultados para consumoID ${e}`)}const r={};n.value.forEach(e=>{const t=e.mesAno;r[t]=e.valor;o[t]=e.ID});this._IdFechasPorMesConsuEx=o;this.rellenarInputsConFechas("tablaConsuExter",t,r);return{consumoID:e,data:n.value||[]}}catch(t){console.error(`‚ùå Error en consulta para consumoID ${e}:`,t);return{consumoID:e,error:t}}});const s=await Promise.all(a)},leerFechasServConsumoExterno:async function(){const e=this._idConsuOtrser;const t={};const o={};const a=e.map(async(e,t)=>{const a=`/odata/v4/datos-cdo/ValorMensuServConsuEx?$filter=otrosServiciosConsu_ID eq '${e}'`;console.log(`üîó Consultando URL para servicioID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error al consultar el servicio: "+e)}const n=await s.json();if(n.value&&n.value.length>0){}else{console.warn(`‚ö†Ô∏è Sin resultados para servicioID ${e}`)}const r={};n.value.forEach(e=>{const t=e.mesAno;r[t]=e.valor;o[t]=e.ID});this._IdFechasPorMesServiConsu=o;this.rellenarInputsConFechas("idOtroserConsu",t,r);return{servicioID:e,data:n.value||[]}}catch(t){console.error(`‚ùå Error en consulta para servicioID ${e}:`,t);return{servicioID:e,error:t}}});const s=await Promise.all(a)},leerFechasGastoConsumoExterno:async function(){console.log("üîé IDs de Gasto de Viaje Consumo Externo a consultar:",gastosIDs);const e={};const t={};const o=gastosIDs.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensuGastoViaConsuEx?$filter=GastoViajeConsumo_ID eq '${e}'`;console.log(`üîó Consultando URL para gastoID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è Sin datos encontrados para gastoID: ${e}`);return{gastoID:e,data:[]}}const r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesGasViaConsuEx=t;console.log("üìÖ Valores por fecha para gastoID:",e,r);this.rellenarInputsConFechas("idGastoViajeConsu",o,r);return{gastoID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar gastoID ${e}:`,t);return{gastoID:e,error:t}}});const a=await Promise.all(o)},leerFechasRecursoExterno:async function(){const e=this._RecursoExterno;const t={};const o=e.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensuRecuExter?$filter=RecursosExternos_ID eq ${e}`;console.log(`üîó Consultando URL para recursoID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è Sin datos encontrados para recurso externo ID: ${e}`);return{recursoID:e,data:[]}}const r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesREExt=t;this.rellenarInputsConFechas("tablaRecExterno",o,r);return{recursoID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar recurso externo ID ${e}:`,t);return{recursoID:e,error:t}}});const a=await Promise.all(o)},leerFechasServRecursoExterno:async function(){const e=this._idOtroSerEx;const t={};const o=e.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensuSerExter?$filter=ServiRecurExterno_ID eq ${e}`;console.log(`üîó URL consultada para ServiRecurExterno_ID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è No hay datos de ValorMensuSerExter para el ID: ${e}`);return{servID:e,data:[]}}let r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesSerReEx=t;console.log("üìÖ Valores por fecha para servicio externo:",e,r);this.rellenarInputsConFechas("idServiExterno",o,r);return{servID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar ServiRecurExterno_ID ${e}:`,t);return{servID:e,error:t}}});const a=await Promise.all(o)},leerFechasGastoRecursoExterno:async function(){const e=this._idGasViaReEx;const t={};const o=e.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensuGastoViExter?$filter=GastoViajeRecExter_ID eq ${e}`;console.log(`üîó URL consultada para GastoViajeRecExter_ID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è No hay datos de ValorMensuGastoViExter para el ID: ${e}`);return{gastoID:e,data:[]}}let r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesReEx=t;console.log("üìÖ Valores por fecha para gasto externo:",e,r);this.rellenarInputsConFechas("idGastoRecuExter",o,r);return{gastoID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar GastoViajeRecExter_ID ${e}:`,t);return{gastoID:e,error:t}}});const a=await Promise.all(o)},leerGastoviajeInterno:async function(e){var t=`/odata/v4/datos-cdo/otrosRecursos?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("tablGastoViajeInterno");var a=o.getItems();this._IdGastoViajInter=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._IdGastoViajInter[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalE?parseFloat(e.totalE).toFixed(2):"0.00")}}});await this.leerFechasGastoViajeRecInter()}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerSerivioInterno:async function(e){var t=`/odata/v4/datos-cdo/otrosGastoRecu?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("tableServicioInterno");var a=o.getItems();this._idServiInterno=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idServiInterno[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalE?parseFloat(e.totalE).toFixed(2):"0.00")}}});await this.leerFechasServiRecInter()}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerConsumoExterno:async function(e){var t=`/odata/v4/datos-cdo/ConsumoExternos?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("tablaConsuExter");var a=o.getItems();this._consumoExternosIDs=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._consumoExternosIDs[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();console.log("N√∫mero de filas visibles en la tabla: ",a.length);if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");console.log("RECURSO PERFOL "+e.tipoServicio_ID);s[2].setSelectedKey(e.PerfilConsumo_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.totalC).toFixed(2):"0.00")}}});for(let e=0;e<this._consumoExternosIDs.length;e++){const t=this._consumoExternosIDs[e];await this.leerFechasConsumoExterno(t)}}else{}}catch(e){console.error("Error al obtener los datos de Consumo Externo:",e)}},leerConsuOtroServi:async function(e){var t=`/odata/v4/datos-cdo/otrosServiciosConsu?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("idOtroserConsu");var a=o.getItems();this._idConsuOtrser=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idConsuOtrser[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});for(let e of this._idConsuOtrser){await this.leerFechasServConsumoExterno(e)}}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerGastoViajeConsu:async function(e){var t=`/odata/v4/datos-cdo/GastoViajeConsumo?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("idGastoViajeConsu");var a=o.getItems();this._idGastoViajeCOnsu=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idGastoViajeCOnsu[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});this.leerFechasGastoConsumoExterno()}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerRecursoExterno:async function(e){var t=`/odata/v4/datos-cdo/RecursosExternos?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}this._RecursoExterno=[];const n=await e.json();var o=this.byId("tablaRecExterno");var a=o.getItems();if(n.value&&n.value.length>0){n.value.forEach((e,t)=>{this._RecursoExterno[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[2].setValue(e.PerfilServicio||"");s[3].setValue(e.ConceptoOferta||"");s[4].setValue(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.totalC).toFixed(2):"0.00")}}});var s=n.value[0].ID;await this.leerFechasRecursoExterno(s)}else{}}catch(e){console.error("Error al obtener los datos de Recursos Externos:",e)}},leerOtrosServiExter:async function(e){var t=`/odata/v4/datos-cdo/serviRecurExter?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("idServiExterno");var a=o.getItems();this._idOtroSerEx=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idOtroSerEx[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});await this.leerFechasServRecursoExterno()}else{}}catch(e){console.error("Error al obtener los datos de serviRecurExter:",e)}},leerGastoViaExter:async function(e){var t=`/odata/v4/datos-cdo/GastoViajeRecExter?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("idGastoRecuExter");var a=o.getItems();this._idGasViaReEx=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idGasViaReEx[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[1].setSelectedKey(e.tipoServicio_ID||"");s[3].setValue(e.ConceptoOferta||"");s[4].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[5].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[6].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[7].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[8].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[9].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[10].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[11].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[12].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});for(let e of this._idGasViaReEx){await this.leerFechasGastoRecursoExterno(e)}}else{}}catch(e){console.error("Error al obtener los datos de GastoViajeRecExter:",e)}},leerOtrosConcepto:async function(e){var t=`/odata/v4/datos-cdo/otrosConceptos?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("tablaInfrestuctura");var a=o.getItems();this._OtrosConceptos=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._OtrosConceptos[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[2].setValue(e.ConceptoOferta||"");s[3].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[4].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[5].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[6].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[7].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[8].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[9].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[10].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[11].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});for(let e of this._OtrosConceptos){await this.leerFechasOtrosConcetos(e)}}else{}}catch(e){console.error("Error al obtener los datos de Recursos Internos:",e)}},leerFechasOtrosConcetos:async function(){const e=this._OtrosConceptos;const t={};const o=e.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensuOtrConcep?$filter=otrosConceptos_ID eq ${e}`;console.log(`üîó URL consultada para otrosConceptos_ID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è No hay datos de ValorMensuOtrConcep para el ID: ${e}`);return{conceptoID:e,data:[]}}let r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesOtConp=t;this.rellenarInputsConFechas("tablaInfrestuctura",o,r);return{conceptoID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar otrosConceptos_ID ${e}:`,t);return{conceptoID:e,error:t}}});const a=await Promise.all(o)},leerFechasLicencia:async function(){const e=this._idLicencia;const t={};const o=e.map(async(e,o)=>{const a=`/odata/v4/datos-cdo/ValorMensulicencia?$filter=licencia_ID eq ${e}`;console.log(`üîó URL consultada para licencia_ID: ${e}`);try{const s=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!s.ok){const e=await s.text();throw new Error("‚ùå Error en respuesta de red: "+e)}const n=await s.json();console.log("üì¶ Respuesta JSON completa:",n);if(!n.value||n.value.length===0){console.warn(`‚ö†Ô∏è No hay datos de ValorMensulicencia para el ID: ${e}`);return{licenciaID:e,data:[]}}let r={};n.value.forEach(e=>{const o=e.mesAno;r[o]=e.valor;t[o]=e.ID});this._IdFechasPorMesLicencia=t;console.log("üìÖ Valores por fecha para licencia:",e,r);this.rellenarInputsConFechas("tablaLicencia",o,r);return{licenciaID:e,data:n.value}}catch(t){console.error(`‚ùå Error al consultar licencia_ID ${e}:`,t);return{licenciaID:e,error:t}}});const a=await Promise.all(o)},leerLicencias:async function(e){var t=`/odata/v4/datos-cdo/LicenciasCon?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const s=await e.json();var o=this.byId("tablaLicencia");var a=o.getItems();this._idLicencia=[];if(s.value&&s.value.length>0){s.value.forEach((e,t)=>{this._idLicencia[t]=e.ID;if(t<a.length){var o=a[t];var s=o.getCells();if(s.length>1){s[0].setSelectedKey(e.Vertical_ID||"");s[2].setValue(e.ConceptoOferta||"");s[3].setText(e.PMJ?parseFloat(e.PMJ).toFixed(2):"0.00");s[4].setText(e.year1?parseFloat(e.year1).toFixed(2):"0.00");s[5].setText(e.year2?parseFloat(e.year2).toFixed(2):"0.00");s[6].setText(e.year3?parseFloat(e.year3).toFixed(2):"0.00");s[7].setText(e.year4?parseFloat(e.year4).toFixed(2):"0.00");s[8].setText(e.year5?parseFloat(e.year5).toFixed(2):"0.00");s[9].setText(e.year6?parseFloat(e.year6).toFixed(2):"0.00");s[10].setText(e.total?parseFloat(e.total).toFixed(2):"0.00");s[11].setText(e.totalC?parseFloat(e.total).toFixed(2):"0.00")}}});await this.leerFechasLicencia()}else{}}catch(e){console.error("Error al obtener los datos de LicenciasCon:",e)}},updateVizFrame1:function(e){var t=this.getView();var o=t.getModel("planning");if(!o){console.error("El modelo 'planning' no est√° definido.");return}if(!e||!e.value){return}var a=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var s=e.value.map(function(e){var t=e.fecha_inicio?new Date(e.fecha_inicio):null;var o=e.fecha_fin?new Date(e.fecha_fin):null;if(t&&!isNaN(t.getTime())&&o&&!isNaN(o.getTime())){var s=(o-t)/(1e3*60*60*24);return{fase:e.hito,fechaInicio:a.format(t),fechaFin:a.format(o),duracion:s,label:`Inicio: ${a.format(t)}, Fin: ${a.format(o)}, Duraci√≥n: ${s} d√≠as`}}else{console.warn("Fechas no v√°lidas para el hito:",e);return null}}).filter(Boolean);o.setProperty("/chartData",s);console.log(s);this._aChartData=s;var n={};s.forEach(function(e){if(e.fase==="Kick off"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Server post/prod"){n.fechaFinPruebasTQ=e.fechaFin}});var r=new sap.ui.model.json.JSONModel({fechas:[{fase:"Plan",fechaInicioConstruccion:n.fechaInicioConstruccion||"No definida",fechaFinPruebasTQ:n.fechaFinPruebasTQ||"No definida"}]});t.setModel(r,"fechasModel");this.updateVizFrame2(r)},updateVizFrame2:function(e){var t=this.getView();var o=t.getModel("planning");if(!(e instanceof sap.ui.model.json.JSONModel)||!e.getData){return}var a=e.getData().fechas;var s=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var n=a.map(function(e){var t=e.fechaInicioConstruccion&&e.fechaInicioConstruccion!=="No definida"?new Date(e.fechaInicioConstruccion):null;var o=e.fechaFinPruebasTQ&&e.fechaFinPruebasTQ!=="No definida"?new Date(e.fechaFinPruebasTQ):null;if(t&&!isNaN(t.getTime())&&o&&!isNaN(o.getTime())){var a=(o-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:s.format(t),fechaFin:s.format(o),duracion:a,label:`Inicio: ${s.format(t)}, Fin: ${s.format(o)}, Duraci√≥n: ${a} d√≠as`}}else{return null}}).filter(Boolean);o.setProperty("/chartModel",n)},updateVizFrame3:function(){var e=this.getView();var t=e.getModel("planning");var o=t.getData();var a=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var s=o.milestones.map(function(e){var t=e.fechaInicio?new Date(e.fechaInicio):null;var o=e.fechaFin?new Date(e.fechaFin):null;if(t&&o&&!isNaN(t)&&!isNaN(o)){var s=(o-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:a.format(t),fechaFin:a.format(o),duracion:s,label:`Inicio: ${a.format(t)}, Fin: ${a.format(o)}, Duraci√≥n: ${s} d√≠as`}}else{return null}}).filter(Boolean);t.setProperty("/chartData",s);this._aChartData=s;var n={};s.forEach(function(e){if(e.fase==="Kick off"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Server post/prod"){n.fechaFinPruebasTQ=e.fechaFin}});var r=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:n.fechaInicioConstruccion,fechaFinPruebasTQ:n.fechaFinPruebasTQ}]});e.setModel(r,"fechasModel");this.updateVizFrame2(r)},onFechaChange:function(){this.updateVizFrame1();this.updateVizFrame3()},onPerfilChangeTabla1:function(e){this.updateRowData(e,["table_dimicFecha"])},updateRowData:function(e){const t=e.getSource();var o=this.byId("table_dimicFecha");var a=t.getParent();var s=o.indexOfItem(a);if(s===-1){console.error(`√çndice de la fila no encontrado en la tabla ${oTableId}. Verifica la estructura de la tabla.`);return}else{}var n=o.getItems();var r=n[s].getCells();if(!r||r.length===0){console.error(`Datos de la fila no encontrados en la tabla ${oTableId}.`);return}var i=t.getSelectedItem().getText();var l={Director:{PMJ:1370.88},"CG4.C":{PMJ:179.46},"CG4.A":{PMJ:347.37},"CG4.B":{PMJ:223.59},CG3:{PMJ:424.15},CG2:{PMJ:529.92},CG1:{PMJ:670.46}};var c=l[i];if(c){r[4].setText(c.PMJ);var d="table_dimicFecha";if(!this._editedRows[d]){this._editedRows[d]=new Set}if(!this._editedRows[d].has(s)){this._editedRows[d].add(s)}this.updateTotalField(d,s,c.PMJ,e,4)}else{console.error(`No hay configuraci√≥n definida para el valor seleccionado: ${i}`)}},selectFuncionchange:function(e){const t=e.getSource();const o=this.byId("tablaConsuExter");var a=t.getParent();var s=o.indexOfItem(a);if(s===-1){console.error(`√çndice de la fila no encontrado en la tabla ${oTableId}. Verifica la estructura de la tabla.`);return}var n=o.getItems();var r=n[s].getCells();if(!r||r.length===0){console.error(`Datos de la fila no encontrados en la tabla ${oTableId}.`);return}var i=t.getSelectedItem().getText();var l={"Equipo Argentina - Analista":{PMJ:216.18},"Equipo Argentina - Asistente":{PMJ:190.74},"Equipo Argentina - Jefe":{PMJ:296.13},"Equipo Argentina - Gerente":{PMJ:478.34},"Basis - Consultor Junior":{PMJ:207.19},"Basis - Consultor Senior":{PMJ:356.21},"Basis - Arquitecto":{PMJ:356.21},"QA - An√°lisis Funcional":{PMJ:278},"QA - Jefe Proyecto":{PMJ:320},"Testing - An√°lisis Funcional":{PMJ:180},"TA - Consultor Senior 1-2":{PMJ:379.17},"TA - Consultor Senior 3":{PMJ:455.4}};var c=l[i];if(c){r[4].setText(c.PMJ);var d="tablaConsuExter";if(!this._editedRows[d]){this._editedRows[d]=new Set}if(!this._editedRows[d].has(s)){this._editedRows[d].add(s)}this.updateTotalField(d,s,c.PMJ,e,4)}else{console.error(`No hay configuraci√≥n definida para el valor seleccionado: ${i}`)}},token:async function(){try{let e=await fetch("/odata/v4/datos-cdo",{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!e.ok){throw new Error("Error al obtener el CSRF Token")}let t=e.headers.get("x-csrf-token");if(!t){throw new Error("No se recibi√≥ un CSRF Token")}localStorage.setItem("csrfToken",t);this._sCsrfToken=t}catch(e){console.error("Error en la llamada al servicio:",e)}},getCsrfToken:function(){return localStorage.getItem("csrfToken")},sendRequest:async function(){const e=this.getCsrfToken();if(!e){console.log("No hay CSRF Token disponible, obteniendo uno...");await this.token()}const t=await fetch("/odata/v4/datos-cdo",{method:"GET",headers:{"x-csrf-token":e}});if(t.ok){const e=await t.json();console.log(e)}else{console.error("Error en la solicitud:",t.status)}},onSave:async function(){console.log("Entre al ONSAVE ");const e=this._usuarioActual;let t=this.getView().getModel("viewModel").getProperty("/mode");if(!this._oBusyDialog){this._oBusyDialog=new sap.m.BusyDialog({title:"Procesando",text:"Procesando su solicitud, por favor espere un momento..."})}if(!t){t=this._mode||""}if(!t){t=this._sProjectID?"edit":"create"}console.log("MODO FINAL USADO EN onSave:",t);let o=0;let a=[];const s=[];const n=this._sProjectID;const r=parseFloat(this.byId("input0").getValue(),10);const i=this.byId("dddtg").getText();const l=this.byId("23d3").getText();const c=parseFloat(this.byId("inputCambioEu").getValue());const d=this.byId("input1").getValue();const u=this.byId("idDescripcion").getValue();const h=parseFloat(this.byId("input0_1725625161348").getValue());const f=this.byId("box_pluriAnual").getSelected();const p=this.byId("id_Cfactur").getValue();const g=this.byId("box_multiJuridica").getSelected();const x=this.byId("ofertaCheckBox").getSelected();const y=this.byId("idCheckMensual").getSelected();const I=this.byId("int_clienteFun").getValue();const b=this.byId("idObje").getValue();const m=this.byId("idAsunyRestri").getValue();const v=this.byId("area0").getValue();const T=this.byId("date_inico").getDateValue();const C=this.byId("date_fin").getDateValue();const F=this.byId("input_ipc").getValue();const _=this.byId("idTextComProve").getValue();const E=this.byId("idComenpVd").getValue();let w=F.replace("%","").replace(",",".");let S=parseFloat(w);const V=this.byId("idComentarioTipo").getValue();const D=this.byId("idComentariosFac").getValue();var P=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss"});const N=T?P.format(T):null;const j=C?P.format(C):null;const $=this.byId("idNatu").getSelectedKey();const R=this.byId("slct_area");const O=R.getSelectedKey();const A=R.getSelectedItem()?R.getSelectedItem().getText():"";const k=this.byId("slct_Jefe");const M=k.getSelectedKey();const G=k.getSelectedItem()?k.getSelectedItem().getText():"";const J=this.byId("select_tipoCom").getSelectedKey();const L=this.byId("selectMotivo").getSelectedKey();const K=this.byId("slct_inic").getSelectedKey();const H=this.byId("selc_Segui").getSelectedKey();const B=this.byId("selc_ejcu").getSelectedKey();const q=this.byId("slct_client").getSelectedKey();const z=this.byId("slct_verti").getSelectedKey();const U=this.byId("selct_Amrecp").getSelectedKey();function W(e,t,a,n="text"){if(n==="boolean"){if(!t){o++;s.push(a)}}else if(n==="date"){if(!t){if(e.setValueState){e.setValueState("Error")}o++;s.push(a)}else{if(e.setValueState){e.setValueState("None")}}}else{if(!t){if(e.setValueState){e.setValueState("Error")}o++;s.push(a)}else{if(e.setValueState){e.setValueState("None")}}}}const Y=this.validateRecursosInternos();const X=this.validateServicioInterno();const Q=this.validateGastoViajeInterno();const Z=this.validateChartData();const ee=this.validateConsumoExterno();const te=this.validateServiConsu();const oe=this.validateGastoConsu();const ae=this.validateRecursoExterno();const se=this.validateServicioRecuExter();const ne=this.validateGastoViajeExterno();const re=this.validateOtrosConceptos();const ie=this.validateLicencia();if(!Z.success){a.push(...Z.errors)}if(!Y.success){a.push(...Y.errors)}if(!X.success){a.push(...X.errors)}if(!Q.success){a.push(...Q.errors)}if(!ee.success){a.push(...ee.errors)}if(!te.success){a.push(...te.errors)}if(!oe.success){a.push(...oe.errors)}if(!ae.success){a.push(...ae.errors)}if(!se.success){a.push(...se.errors)}if(!ne.success){a.push(...ne.errors)}if(!re.success){a.push(...re.errors)}if(!ie.success){a.push(...ie.errors)}W(this.byId("input1"),d,"Nombre del Proyecto");W(this.byId("idDescripcion"),u,"Descripcion");W(this.byId("box_multiJuridica"),g,"Multijuridica");W(this.byId("date_inico"),T,"Inicio","date");W(this.byId("date_fin"),C,"Fin","date");if(o>0||a.length>0){let e="";if(s.length>0){e+="Por favor, complete los siguientes campos:\n- "+s.join("\n- ")}if(a.length>0){if(e.length>0){e+="\n\n"}e+="Errores en los datos ingresados:\n- "+a.join("\n- ")}sap.m.MessageBox.warning(e,{title:"Advertencia"});return}const le=new Date;const ce=new Date(le.getTime()-le.getTimezoneOffset()*6e4);const de=await this.mostrarDialogoModalidad();let ue="Online";let he=null;if(de.modalidad==="Comit√©"){ue="Comit√©";he=de.fechaComite?de.fechaComite.toISOString().split("T")[0]:null}const fe={codigoProyect:"1",nameProyect:d,Email:i,Empleado:l,pluriAnual:f,Total:h,Oferta:x,descripcion:u,mensual:y,comentarioTipoCompra:V,comentarioFacturacion:D,comentarioProveedor:_,comentarioPvD:E,funcionalString:I,clienteFacturacion:p,multijuridica:g,Naturaleza_ID:$,TipoCompra_ID:J,TipoCompra:{ID:J},MotivoCondi:{ID:L},Area_ID:O,Iniciativa_ID:K,jefeProyectID_ID:M,objetivoAlcance:b,AsuncionesyRestricciones:m,Vertical_ID:z,Fechainicio:N,FechaFin:j,Seguimiento_ID:H,EjecucionVia_ID:B,AmReceptor_ID:U,clienteFuncional_ID:q,Estado:"Pendiente",modalidad:ue,Usuarios_ID:e,datosExtra:v,IPC_apli:S,CambioEuRUSD:c};if(!n){fe.fechaCreacion=ce}console.log("RESULTADO ----\x3e "+ue);console.log("DEBUG resultadoDialogo.modalidad --\x3e",de.modalidad);let pe=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});const ge=new Date;const xe=pe.format(ge);if(n){fe.FechaModificacion=xe}if(!fe.descripcion||!fe.nameProyect){console.error("Validaci√≥n fallida: Falta c√≥digo o nombre del proyecto",fe);return}console.log("Payload a enviar:",JSON.stringify(fe,null,2));try{let e=this.getView().getModel();let t=e.sServiceUrl;let o;let a="/odata/v4/datos-cdo/DatosProyect";let s="POST";this._oBusyDialog.open();if(this._mode==="edit"){if(!n){sap.m.MessageBox.error("Error: No hay ProjectID para editar.");return}console.log("ID DEL WORK "+this._idWorkIniciado);if(this._idWorkIniciado){try{const e=this.getView().getModel();const t=e.bindContext("/cancelWorkflow(...)");t.setParameter("workflowInstanceId",this._idWorkIniciado);await t.execute()}catch(e){sap.m.MessageBox.error("Error al cancelar workflow anterior: "+e.message);return}}a=`/odata/v4/datos-cdo/DatosProyect(${n})`;s="PATCH"}else if(this._mode==="create"){s="POST";a="/odata/v4/datos-cdo/DatosProyect"}let r=await fetch(t,{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!r.ok){throw new Error("Error al obtener el CSRF Token")}let i=r.headers.get("x-csrf-token");if(!i){throw new Error("No se recibi√≥ un CSRF Token")}o=await fetch(a,{method:s,headers:{"Content-Type":"application/json","x-csrf-token":i},body:JSON.stringify(fe)});if(!o.ok){const e=await o.text();console.error(`Error en ${s} (${o.status}):`,e);if(o.status===400){sap.m.MessageToast.show("Error 400: Datos incorrectos o incompletos.")}else if(o.status===404){sap.m.MessageToast.show("Error 404: Endpoint no encontrado.")}else if(o.status===500){sap.m.MessageToast.show("Error 500: Problema en el servidor o base de datos.")}else{sap.m.MessageToast.show(`Error ${o.status}: ${e}`)}throw new Error(`HTTP ${o.status} - ${e}`)}if(o.ok){const e=await o.json();console.log("Respuesta completa de la API:",e);const t=e.ID||e.data?.ID;if(t){const e=await Promise.all([this.insertFacturacion(t),this.inserChart(t,i),this.insertarProveedor(t),this.insertClientFactura(t),this.insertRecursosInternos(t),this.insertCosumoExterno(t),this.insertRecursoExterno(t),this.insertarOtrosConceptos(t),this.insertServicioInterno(t),this.insertGastoViajeInterno(t),this.insertServiConsu(t),this.insertGastoConsu(t),this.insertServicioRecuExter(t),this.insertGastoViajeExterno(t),this.insertarLicencia(t),this.insertPerfilJornadas(t,i),this.insertTotalRecuInterno(t,i),this.insertTotalConsuExt(t,i),this.insertTotalRecuExterTotal(t,i),this.insertTotalInfraestrLicencia(t,i),this.insertResumenCostesTotal(t,i),this.onUploadFile(t,i)]);const o="https://telefonica-global-technology--s-a--j8z80lwx-sp-shc-dev-16bb931b.cfapps.eu20-001.hana.ondemand.com/project1/index.html#/app/";const a=this.getView().getModel();const s=a.bindContext("/startWorkflow(...)");const n={codigoproyect:0,nameproyect:d,generatedid:t,urlapp:o,descripcion:u,jefeProyecto:G,area:A,usuario:l,Modalidad:ue};if(ue==="Comit√©"&&he){n.fechaComite=he}s.setParameter("payload",JSON.stringify(n));try{await s.execute();const e=s.getBoundContext().getObject();this.workflowInstanceId=e.workflowInstanceId;console.log("Resultado del flujo de trabajo:",e);if(e&&e.workflowInstanceId){const o=e.workflowInstanceId;this.insertWorkflow(o,l,t,i);this._oBusyDialog.close()}else{sap.m.MessageBox.error("No se recibi√≥ el ID del flujo de trabajo.")}this.getOwnerComponent().getRouter().navTo("app",{newId:t})}catch(e){sap.m.MessageBox.error("Error al iniciar el workflow: "+e.message)}}else{console.error("No se gener√≥ un ID v√°lido.")}}}catch(e){console.error("Error en la llamada al servicio:",e)}},validateChartData:function(){const e=[];function t(e){if(!e)return null;const t=new Date(e);t.setHours(0,0,0,0);return t}const o=t(this.byId("date_inico").getDateValue());const a=t(this.byId("date_fin").getDateValue());if(!o||!a){e.push("Debes seleccionar las fechas Inicio y Fin en el formulario.")}let s=null;let n=null;if(this._aChartData&&this._aChartData.length>0){this._aChartData.forEach(e=>{const o=e.fechaInicio?t(new Date(e.fechaInicio)):null;const a=e.fechaFin?t(new Date(e.fechaFin)):null;if(o){if(!s||o<s){s=o}}if(a){if(!n||a>n){n=a}}})}else{e.push("El gr√°fico est√° vac√≠o. Debes ingresar al menos un hito.")}if(s&&o){if(s.getTime()!==o.getTime()){e.push(`La fecha de inicio m√°s temprana (${s.toLocaleDateString()}) no coincide con la fecha seleccionada en el formulario (${o.toLocaleDateString()}).`)}}if(n&&a){if(n.getTime()!==a.getTime()){e.push(`La fecha de fin m√°s tard√≠a (${n.toLocaleDateString()}) no coincide con la fecha seleccionada en el formulario (${a.toLocaleDateString()}).`)}}return{success:e.length===0,errors:e}},validateRecursosInternos:function(){const e=this.byId("table_dimicFecha");const t=e.getItems();const o=[];let a=false;let s=false;for(let e=0;e<t.length;e++){const n=t[e];const r=n.getCells()[0];const i=n.getCells()[1];const l=n.getCells()[2];const c=n.getCells()[3];const d=r?.getSelectedKey()||"";const u=i?.getSelectedKey()||"";const h=l?.getSelectedKey()||"";const f=c?.getValue()?.trim()||"";const p=!d&&!u&&!h&&!f;r?.setValueState("None");i?.setValueState("None");l?.setValueState("None");c?.setValueState("None");if(!p){a=true;const t=[];if(!d){t.push("Debe seleccionar la Vertical");r?.setValueState("Error");r?.setValueStateText("Campo obligatorio")}if(!u){t.push("Debe seleccionar el Tipo de Servicio");i?.setValueState("Error");i?.setValueStateText("Campo obligatorio")}if(!h){t.push("Debe seleccionar el Perfil");l?.setValueState("Error");l?.setValueStateText("Campo obligatorio")}if(!f){t.push("El campo Concepto es obligatorio");c?.setValueState("Error");c?.setValueStateText("Campo obligatorio")}if(t.length>0){o.push(`Fila ${e+1}: ${t.join(", ")}`)}else{s=true}}}if(a&&!s){o.push("Debe completar correctamente al menos una fila de Recursos Internos.")}return{success:o.length===0,errors:o}},validateServicioInterno:function(){const e=this.byId("tableServicioInterno");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=n.getSelectedKey();const u=r.getSelectedKey();const h=i.getValue()?.trim();const f=parseInt(l.getText(),10);const p=parseInt(c.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const g=!d&&!u&&!h&&isNaN(f)&&isNaN(p);if(g){continue}const x=[];if(!d){x.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!u){x.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!h){x.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(x.length>0){o.push(`Fila ${e+1}: ${x.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},validateGastoViajeInterno:function(){const e=this.byId("tablGastoViajeInterno");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=s.getCells()[12];const u=n.getSelectedKey();const h=r.getSelectedKey();const f=i.getValue()?.trim();const p=parseInt(l.getText(),10);const g=parseInt(c.getText(),10);const x=parseInt(d.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const y=!u&&!h&&!f&&isNaN(p)&&isNaN(g)&&isNaN(x);if(y){continue}const I=[];if(!u){I.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!h){I.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!f){I.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(I.length>0){o.push(`Fila ${e+1}: ${I.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},validateConsumoExterno:function(){const e=this.byId("tablaConsuExter");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[2];const l=s.getCells()[3];const c=s.getCells()[4];const d=n?.getSelectedKey()||"";const u=r?.getSelectedKey()||"";const h=i?.getSelectedKey()||"";const f=l?.getValue()?.trim()||"";const p=parseFloat(c?.getText())||0;const g=parseFloat(s.getCells()[11]?.getText())||0;const x=parseFloat(s.getCells()[12]?.getText())||0;const y=d||u||h||f||p>0||g>0||x>0;n?.setValueState("None");r?.setValueState("None");i?.setValueState("None");l?.setValueState("None");if(y){a=true;const t=[];if(!d){t.push("Debe seleccionar la Vertical");n?.setValueState("Error");n?.setValueStateText("Campo obligatorio")}if(!u){t.push("Debe seleccionar el Tipo de Servicio");r?.setValueState("Error");r?.setValueStateText("Campo obligatorio")}if(!h){t.push("Debe seleccionar el Perfil");i?.setValueState("Error");i?.setValueStateText("Campo obligatorio")}if(!f){t.push("El campo Concepto es obligatorio");l?.setValueState("Error");l?.setValueStateText("Campo obligatorio")}if(t.length>0){o.push(`Fila ${e+1}: ${t.join(", ")}`)}}}if(a&&o.length>0){return{success:false,errors:o}}return{success:true,errors:[]}},validateServiConsu:function(){const e=this.byId("idOtroserConsu");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=s.getCells()[12];const u=n.getSelectedKey();const h=r.getSelectedKey();const f=i.getValue()?.trim();const p=parseInt(l.getText(),10);const g=parseInt(c.getText(),10);const x=parseInt(d.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const y=!u&&!h&&!f&&isNaN(p)&&isNaN(g)&&isNaN(x);if(y){continue}const I=[];if(!u){I.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!h){I.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!f){I.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(I.length>0){o.push(`Fila ${e+1}: ${I.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},validateGastoConsu:function(){const e=this.byId("idGastoViajeConsu");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=s.getCells()[12];const u=n.getSelectedKey();const h=r.getSelectedKey();const f=i.getValue()?.trim();const p=parseInt(l.getText(),10);const g=parseInt(c.getText(),10);const x=parseInt(d.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const y=!u&&!h&&!f&&isNaN(p)&&isNaN(g)&&isNaN(x);if(y){continue}const I=[];if(!u){I.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!h){I.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!f){I.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(I.length>0){o.push(`Fila ${e+1}: ${I.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},validateRecursoExterno:function(){const e=this.byId("tablaRecExterno");const t=e.getItems();const o=[];for(let e=0;e<t.length;e++){const a=t[e];const s=a.getCells()[0];const n=a.getCells()[1];const r=a.getCells()[2];const i=a.getCells()[3];const l=a.getCells()[4];const c=s.getSelectedKey()||"";const d=n.getSelectedKey()||"";const u=r.getValue()||"";const h=i.getValue()||"";const f=parseFloat(l.getValue());const p=parseFloat(a.getCells()[11].getText());const g=parseFloat(a.getCells()[12].getText());const x=c||d||u||h||!isNaN(f)||!isNaN(p)||!isNaN(g);s.setValueState("None");n.setValueState("None");r.setValueState("None");i.setValueState("None");l.setValueState("None");if(x){const t=[];if(!c){t.push("Debe seleccionar la Vertical");s.setValueState("Error");s.setValueStateText("Campo obligatorio")}if(!d){t.push("Debe seleccionar el Tipo de Servicio");n.setValueState("Error");n.setValueStateText("Campo obligatorio")}if(!u){t.push("Debe seleccionar el Perfil");r.setValueState("Error");r.setValueStateText("Campo obligatorio")}if(!h){t.push("El campo Concepto es obligatorio");i.setValueState("Error");i.setValueStateText("Campo obligatorio")}if(isNaN(f)){t.push("El campo PMJ no es v√°lido");l.setValueState("Error");l.setValueStateText("Debe ser un n√∫mero v√°lido")}if(t.length>0){o.push(`Fila ${e+1}: ${t.join(", ")}`)}}}if(o.length>0){return{success:false,errors:o}}return{success:true,errors:[]}},validateServicioRecuExter:function(){const e=this.byId("idServiExterno");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=s.getCells()[12];const u=n.getSelectedKey();const h=r.getSelectedKey();const f=i.getValue()?.trim();const p=parseInt(l.getText(),10);const g=parseInt(c.getText(),10);const x=parseInt(d.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const y=!u&&!h&&!f&&(isNaN(p)||p===0)&&(isNaN(g)||g===0)&&(isNaN(x)||x===0);if(y){continue}const I=[];if(!u){I.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!h){I.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!f){I.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(I.length>0){o.push(`Fila ${e+1}: ${I.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o,hasValidRow:a}},validateGastoViajeExterno:function(){const e=this.byId("idGastoRecuExter");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[1];const i=s.getCells()[3];const l=s.getCells()[4];const c=s.getCells()[11];const d=s.getCells()[12];const u=n.getSelectedKey();const h=r.getSelectedKey();const f=i.getValue()?.trim();const p=parseInt(l.getText(),10);const g=parseInt(c.getText(),10);const x=parseInt(d.getText(),10);n.setValueState("None");r.setValueState("None");i.setValueState("None");const y=!u&&!h&&!f&&(isNaN(p)||p===0)&&(isNaN(g)||g===0)&&(isNaN(x)||x===0);if(y){continue}const I=[];if(!u){I.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!h){I.push("Debe seleccionar el Tipo de Servicio");r.setValueState("Error")}if(!f){I.push("El campo Concepto es obligatorio");i.setValueState("Error")}if(I.length>0){o.push(`Fila ${e+1}: ${I.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o,hasValidRow:a}},validateLicencia:function(){const e=this.byId("tablaLicencia");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[2];const i=n.getSelectedKey();const l=r.getValue()?.trim();n.setValueState("None");r.setValueState("None");const c=!i&&!l;if(c){continue}const d=[];if(!i){d.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!l){d.push("El campo Concepto es obligatorio");r.setValueState("Error")}if(d.length>0){o.push(`Fila ${e+1}: ${d.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},validateOtrosConceptos:function(){const e=this.byId("tablaInfrestuctura");const t=e.getItems();const o=[];let a=false;for(let e=0;e<t.length;e++){const s=t[e];const n=s.getCells()[0];const r=s.getCells()[2];const i=n.getSelectedKey();const l=r.getValue()?.trim();n.setValueState("None");r.setValueState("None");const c=!i&&!l;if(c){continue}const d=[];if(!i){d.push("Debe seleccionar la Vertical");n.setValueState("Error")}if(!l){d.push("El campo Concepto es obligatorio");r.setValueState("Error")}if(d.length>0){o.push(`Fila ${e+1}: ${d.join(", ")}`)}else{a=true}}return{success:o.length===0,errors:o}},mostrarDialogoModalidad:function(){return new Promise((e,t)=>{if(!this._oComiteDialog){this._oComiteDialog=sap.ui.xmlfragment("project1.view.ComiteDialog",this);this.getView().addDependent(this._oComiteDialog)}var o=sap.ui.getCore().byId("radioGroupModalidad");o.setSelectedIndex(0);var a=sap.ui.getCore().byId("datePickerComite");var s=sap.ui.getCore().byId("infoText");a.setVisible(false);s.setVisible(false);a.setDateValue(null);this._modalidadResolve=e;this._modalidadReject=t;this._oComiteDialog.open()})},onCancelarComiteDialog:function(){if(this._oComiteDialog){this._oComiteDialog.close()}if(this._modalidadReject){this._modalidadReject("cancelado");this._modalidadReject=null;this._modalidadResolve=null}},onConfirmModalidad:function(){const e=sap.ui.getCore().byId("radioGroupModalidad").getSelectedIndex();const t=e===0?"Online":"Comit√©";const o=sap.ui.getCore().byId("datePickerComite");const a=o.getDateValue();if(t==="Comit√©"&&!a){sap.m.MessageToast.show("Por favor, selecciona una fecha para Comit√©.");return}this._oComiteDialog.close();if(this._modalidadResolve){this._modalidadResolve({modalidad:t,fechaComite:a||null})}},onSelectModalidad:function(e){var t=e.getParameter("selectedIndex");var o=this._oComiteDialog;var a=sap.ui.getCore().byId("datePickerComite");var s=sap.ui.getCore().byId("infoText");if(t===1){a.setVisible(true);s.setVisible(true)}else{a.setVisible(false);s.setVisible(false)}},getUsuario:async function(){try{const e=this._user;if(!e){throw new Error("El email del usuario no est√° disponible. Aseg√∫rate de haber ejecutado getUserInfo primero.")}const t=`/odata/v4/datos-cdo/Usuarios`;const o=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!o.ok){const e=await o.text();throw new Error("Error en la respuesta de la red: "+e)}const a=await o.json();const s=a.value.find(t=>t.email?.toLowerCase()===e.toLowerCase());if(s){this._usuarioActual=s.ID;return s.ID}else{throw new Error("‚ùå No se encontr√≥ el usuario con el email logueado.")}}catch(e){console.error("Error al obtener el usuario:",e);return null}},onBorrador:async function(){console.log("ENTRANDO A onBorrador");const e=this._usuarioActual;let t=this.getView().getModel("viewModel").getProperty("/mode");if(!t){t=this._mode||""}if(!t){t=this._sProjectID?"edit":"create"}console.log("MODO FINAL USADO EN onSave:",t);let o=0;const a=[];const s=this._sProjectID;const n=parseFloat(this.byId("input0").getValue(),10);const r=this.byId("ofertaCheckBox").getSelected();const i=this.byId("dddtg").getText();const l=this.byId("23d3").getText();const c=parseFloat(this.byId("inputCambioEu").getValue());const d=this.byId("input1").getValue();const u=this.byId("idDescripcion").getValue();const h=parseFloat(this.byId("input0_1725625161348").getValue());const f=this.byId("box_pluriAnual").getSelected();const p=this.byId("id_Cfactur").getValue();const g=this.byId("box_multiJuridica").getSelected();const x=this.byId("idCheckMensual").getSelected();const y=this.byId("int_clienteFun").getValue();const I=this.byId("idObje").getValue();const b=this.byId("idAsunyRestri").getValue();const m=this.byId("area0").getValue();const v=this.byId("date_inico").getDateValue();const T=this.byId("date_fin").getDateValue();const C=this.byId("input_ipc").getValue();let F=C.replace("%","").replace(",",".");let _=parseFloat(F);const E=this.byId("idTextComProve").getValue();const w=this.byId("idComenpVd").getValue();const S=this.byId("idComentarioTipo").getValue();const V=this.byId("idComentariosFac").getValue();console.log("Objeto comentarioProveedor:",E);console.log("Objeto comentarioPvD:",w);var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss"});const P=v?D.format(v):null;const N=T?D.format(T):null;const j=this.byId("idNatu").getSelectedKey();const $=this.byId("slct_area").getSelectedKey();const R=this.byId("slct_Jefe").getSelectedKey();const O=this.byId("select_tipoCom").getSelectedKey();const A=this.byId("selectMotivo").getSelectedKey();const k=this.byId("slct_inic").getSelectedKey();const M=this.byId("selc_Segui").getSelectedKey();const G=this.byId("selc_ejcu").getSelectedKey();const J=this.byId("slct_client").getSelectedKey();const L=this.byId("slct_verti").getSelectedKey();const K=this.byId("selct_Amrecp").getSelectedKey();const H=(e,t,s)=>{if(!t||typeof t==="string"&&t.trim()===""){e.setValueState("Error");e.setValueStateText("Este campo es obligatorio");o++;if(!a.includes(s)){a.push(s)}}else{e.setValueState("None")}};H(this.byId("input1"),d,"Nombre del Proyecto");H(this.byId("idDescripcion"),u,"Descripcion");if(o>0){sap.m.MessageBox.warning(`Por favor, complete los siguientes campos: ${a.join(", ")}`,{title:"Advertencia"});return}const B=new Date;const q=new Date(B.getTime()-B.getTimezoneOffset()*6e4);console.log(q);const z={codigoProyect:"1",nameProyect:d,Email:i,Empleado:l,Oferta:r,pluriAnual:f,Total:h,descripcion:u,mensual:x,comentarioTipoCompra:S,comentarioFacturacion:V,comentarioProveedor:E,comentarioPvD:w,funcionalString:y,clienteFacturacion:p,multijuridica:g,Naturaleza_ID:j,TipoCompra_ID:O,TipoCompra:{ID:O},MotivoCondi:{ID:A},Area_ID:$,Iniciativa_ID:k,jefeProyectID_ID:R,objetivoAlcance:I,AsuncionesyRestricciones:b,Vertical_ID:L,Fechainicio:P,FechaFin:N,Seguimiento_ID:M,EjecucionVia_ID:G,AmReceptor_ID:K,clienteFuncional_ID:J,Estado:"Borrador",datosExtra:m,IPC_apli:_,Usuarios_ID:e,CambioEuRUSD:c};if(!s){z.fechaCreacion=q}let U=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});const W=new Date;const Y=U.format(W);if(s){z.FechaModificacion=Y}if(!z.descripcion||!z.nameProyect){console.error("Validaci√≥n fallida: Falta c√≥digo o nombre del proyecto",z);return}console.log("Payload a enviar:",JSON.stringify(z,null,2));try{let e=this.getView().getModel();let t=e.sServiceUrl;let o;let a="/odata/v4/datos-cdo/DatosProyect";let n="POST";if(this._mode==="edit"){if(!s){sap.m.MessageBox.error("Error: No hay ProjectID para editar.");return}a=`/odata/v4/datos-cdo/DatosProyect(${s})`;n="PATCH"}else if(this._mode==="create"){n="POST";a="/odata/v4/datos-cdo/DatosProyect"}let r=await fetch(t,{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!r.ok){throw new Error("Error al obtener el CSRF Token")}let i=r.headers.get("x-csrf-token");if(!i){throw new Error("No se recibi√≥ un CSRF Token")}console.log(" CSRF Token obtenido:",i);o=await fetch(a,{method:n,headers:{"Content-Type":"application/json","x-csrf-token":i},body:JSON.stringify(z)});if(!o.ok){const e=await o.text();console.error(`Error en ${n} (${o.status}):`,e);if(o.status===400){sap.m.MessageToast.show("Error 400: Datos incorrectos o incompletos.")}else if(o.status===404){sap.m.MessageToast.show("Error 404: Endpoint no encontrado.")}else if(o.status===500){sap.m.MessageToast.show("Error 500: Problema en el servidor o base de datos.")}else{sap.m.MessageToast.show(`Error ${o.status}: ${e}`)}throw new Error(`HTTP ${o.status} - ${e}`)}if(o.ok){const e=await o.json();console.log("Respuesta completa de la API:",e);const t=e.ID||e.data?.ID;if(t){this.getOwnerComponent().getRouter().navTo("app",{newId:t});await Promise.all([this.insertFacturacion(t),this.inserChart(t,i),this.insertarProveedor(t),this.insertClientFactura(t),this.insertRecursosInternos(t),this.insertCosumoExterno(t),this.insertRecursoExterno(t),this.insertarOtrosConceptos(t),this.insertServicioInterno(t),this.insertGastoViajeInterno(t),this.insertServiConsu(t),this.insertGastoConsu(t),this.insertServicioRecuExter(t),this.insertGastoViajeExterno(t),this.insertarLicencia(t),this.insertPerfilJornadas(t,i),this.insertTotalRecuInterno(t,i),this.insertTotalConsuExt(t,i),this.onUploadFile(t,i)])}else{console.error("No se gener√≥ un ID v√°lido.")}}}catch(e){console.error("Error en la llamada al servicio:",e)}},onFileSelected:function(e){const t=e.getParameter("files")[0];if(t){this._selectedFile=t;console.log("Archivo seleccionado:",t.name)}},onUploadFile:async function(e,t){const o=this._archivoIds;const a=this._selectedFile;if(!a){return}const s=crypto.randomUUID();const n=a.name;const r=a.type||"application/octet-stream";try{const i={ID:s,nombre:n,tipoMime:r,datosProyect_ID:e};if(o){const e=await fetch(`/odata/v4/datos-cdo/Archivos('${o}')`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});e=await fetch(`/odata/v4/datos-cdo/Archivos('${o}')/contenido/$value`,{method:"PUT",headers:{"X-CSRF-Token":t,"Content-Type":r},body:a})}else{putRes=await fetch(`/odata/v4/datos-cdo/Archivos`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});putRes=await fetch(`/odata/v4/datos-cdo/Archivos('${s}')/contenido/$value`,{method:"PUT",headers:{"X-CSRF-Token":t,"Content-Type":r},body:a})}if(!putRes.ok){const e=await putRes.text();throw new Error("‚ùå Error subiendo archivo: "+e)}}catch(e){console.error("üí• Error total en upload:",e);sap.m.MessageToast.show(e.message)}},insertWorkflow:async function(e,t,o,a){var s=this._idWorkflowInstancias;console.log("ID ANTES DE ACTUALIZAR"+s);var n={workflowId:e,estado:"Pendiente",creadoEn:(new Date).toISOString(),actualizadoEn:(new Date).toISOString(),creadoPor:t,datosProyect_ID:o};let r="/odata/v4/datos-cdo/WorkflowInstancias";let i="POST";if(s){r+=`(${s})`;i="PATCH"}try{const e=await fetch(r,{method:i,headers:{"Content-Type":"application/json","X-CSRF-Token":a},body:JSON.stringify(n)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertPerfilJornadas:async function(e,t){var o=this._idJornadas;var a=parseFloat(this.byId("inputReInter").getValue());var s=parseFloat(this.byId("inputConsuEx").getValue());var n=parseFloat(this.byId("inputRcurExtern").getValue());var r=parseFloat(this.byId("inputTotalJor").getValue());var i={totalJorRI:a,totalJorCE:s,totalJorRE:n,Total:r,datosProyect_ID:e};let l="/odata/v4/datos-cdo/PerfilTotal";let c="POST";if(o){l+=`(${o})`;c="PATCH"}try{const e=await fetch(l,{method:c,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertTotalRecuInterno:async function(e,t){var o=this._idTotalRecInter;var a=parseFloat(this.byId("inputServi1").getValue(),10);var s=parseFloat(this.byId("inputOtrosServi1").getValue(),10);var n=parseFloat(this.byId("inputGastoVia1").getValue(),10);var r=parseFloat(this.byId("totalRecuInter").getValue(),10);var i={servicios:a,OtrosServicios:s,GastosdeViaje:n,Total:r,datosProyect_ID:e};let l="/odata/v4/datos-cdo/RecurInterTotal";let c="POST";if(o){l+=`(${o})`;c="PATCH"}try{const e=await fetch(l,{method:c,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertTotalConsuExt:async function(e,t){var o=this._idTotalRecInter;var a=parseFloat(this.byId("inputServi2").getValue());var s=parseFloat(this.byId("inputOtroSer2").getValue());var n=parseFloat(this.byId("inptGastoVi2").getValue());var r=parseFloat(this.byId("totalConsuExternot").getValue());var i={servicios:a,OtrosServicios:s,GastosdeViaje:n,Total:r,datosProyect_ID:e};let l="/odata/v4/datos-cdo/ConsuExterTotal";let c="POST";if(o){l+=`(${o})`;c="PATCH"}try{const e=await fetch(l,{method:c,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertTotalRecuExterTotal:async function(e,t){var o=this._idtotalRecurExter;var a=parseFloat(this.byId("inputServi").getValue(),10);var s=parseFloat(this.byId("input10_1724757017406").getValue(),10);var n=parseFloat(this.byId("input9_1724757015442").getValue(),10);var r=parseFloat(this.byId("totaRecurExterno").getValue(),10);console.log("ID RECIBIDO DEL INSERT "+o);var i={servicios:a,OtrosServicios:s,GastosdeViaje:n,Total:r,datosProyect_ID:e};let l="/odata/v4/datos-cdo/RecuExterTotal";let c="POST";if(o){l+=`(${o})`;c="PATCH"}try{const e=await fetch(l,{method:c,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(i)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertTotalInfraestrLicencia:async function(e,t){var o=this._idInfraLicencia;var a=parseFloat(this.byId("totalInfraestruc").getValue());var s=parseFloat(this.byId("input0_1724758359").getValue());console.log("ID RECIBIDO DEL INSERT "+o);var n={totalInfraestruc:a,totalLicencia:s,datosProyect_ID:e};let r="/odata/v4/datos-cdo/InfraestrLicencia";let i="POST";if(o){r+=`(${o})`;i="PATCH"}try{const e=await fetch(r,{method:i,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(n)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},insertResumenCostesTotal:async function(e,t){var o=this._ResumenTotal;var a=parseFloat(this.byId("totalSubtotal").getValue());var s=parseFloat(this.byId("input2_172475612").getValue());var n=parseFloat(this.byId("input2_1724756105").getValue());var r=parseFloat(this.byId("input2_17221205").getValue());var i=parseFloat(this.byId("input2_1756121205").getValue());var l=parseFloat(this.byId("input0_1725625161348").getValue());console.log("ID RECIBIDO DEL INSERT "+o);var c={Subtotal:a,CosteEstruPorce:s,Costeestructura:n,MargenPorce:r,Margeingresos:i,total:l,datosProyect_ID:e};let d="/odata/v4/datos-cdo/ResumenCostesTotal";let u="POST";if(o){d+=`(${o})`;u="PATCH"}try{const e=await fetch(d,{method:u,headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify(c)});if(e.ok){}else{const t=await e.json();console.error("Error:",t)}}catch(e){console.error("Error en fetch:",e)}},inserChart:async function(e,t){const o=this._aChartData;const a=this._idPlani;const s=function(e){const t=String(Math.floor(e/60)).padStart(2,"0");const o=String(e%60).padStart(2,"0");return`${t}:${o}:00`};const n=o.map(t=>({hito:t.fase,fecha_inicio:t.fechaInicio,fecha_fin:t.fechaFin,duracion:s(t.duracion),datosProyect_ID:e}));try{const o=await fetch(`/odata/v4/datos-cdo/planificacion?$filter=datosProyect_ID eq '${e}'`,{headers:{"x-csrf-token":t}});const a=await o.json();const s=a.value.map(e=>e.hito);for(const e of n){if(s.includes(e.hito)){const o=a.value.find(t=>t.hito===e.hito);if(o&&o.id){const a=await fetch(`/odata/v4/datos-cdo/planificacion(${o.id})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(e)});if(a.ok){const e=await a.json();console.log("Planificaci√≥n actualizada con √©xito:",e)}else{const e=await a.text();console.log("Error al actualizar la planificaci√≥n:",e)}}else{console.log("ID no v√°lido para el registro a actualizar:",o)}}else{const o=await fetch("/odata/v4/datos-cdo/planificacion",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(e)});if(o.ok){const e=await o.json();console.log("Planificaci√≥n guardada con √©xito:",e)}else{const e=await o.text();console.log("Error al guardar la planificaci√≥n:",e)}}}}catch(e){console.error("Error en la operaci√≥n:",e)}},insertFacturacion:async function(e){console.log("ID RECIBIDOOO   "+e);const t=this._sCsrfToken;const o=this.byId("table0");const a=o.getItems();const s=[];const n=parseFloat(this.byId("text73_172746565340569997").getText());const r=this._FacturacionID;a.forEach(function(t){const o=t.getCells();let a="";if(o[0]){if(typeof o[0].getDateValue==="function"){const e=o[0].getDateValue();if(e&&!isNaN(e.getTime())){a=e.toISOString().split("T")[0]}}else if(typeof o[0].getValue==="function"){const e=o[0].getValue();const t=e.split("/");if(t.length===3){const e=new Date(t[2],t[1]-1,t[0]);if(!isNaN(e.getTime())){a=e.toISOString().split("T")[0]}}}}const r=o[1]&&o[1].getValue?o[1].getValue():"";const i=o[2]&&o[2].getValue?parseFloat(o[2].getValue(),10):0;if(a){s.push({fechaEstimida:a,descripcionHito:r,facturacion:i,total:n,datosProyect_ID:e})}});for(let e of s){let o="POST";let a="/odata/v4/datos-cdo/Facturacion";let s={...e};console.log("Enviando datos: ",JSON.stringify(s));if(r){if(r&&typeof r==="string"){o="PATCH";a=`/odata/v4/datos-cdo/Facturacion(${r})`}else{console.error("ID de facturaci√≥n no v√°lido:",r);return}}const n=await fetch(a,{method:o,headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(s)});if(n.ok){const e=await n.json();console.log("Facturaci√≥n guardada/actualizada:",e)}else{const e=await n.text();console.error("Error al guardar la Facturaci√≥n:",e)}}},insertarProveedor:async function(e,t){const o=this._sCsrfToken;var a=this.byId("table2");var s=a.getItems();for(let t=0;t<s.length;t++){var n=s[t];var r=n.getCells();var i=this.byId("box_condi").getSelected();var l=this.byId("box_prove").getSelected();var c={checkCondi:i,checkProveedor:l,valueCondi:r[0].getValue(),valueProvee:r[1].getValue(),datosProyect_ID:e};if(this._proveedoresIDs&&this._proveedoresIDs[t]){var d=this._proveedoresIDs[t];await fetch(`/odata/v4/datos-cdo/ProveedoresC(${d})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(c)})}else{await fetch(`/odata/v4/datos-cdo/ProveedoresC`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(c)})}}},insertRecursosInternos:async function(e){const t=this._sCsrfToken;const o=this.byId("table_dimicFecha");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._recursosIDs&&this._recursosIDs[o]?this._recursosIDs[o]:null;const r=s.getCells()[0]?.getSelectedKey()||"";const i=s.getCells()[1]?.getSelectedKey()||"";const l=s.getCells()[2]?.getSelectedKey()||"";const c=s.getCells()[3]?.getValue()||"";const d=parseFloat(s.getCells()[4]?.getText()||"0");const u=parseFloat(s.getCells()[5]?.getText()||"0",10);const h=parseFloat(s.getCells()[6]?.getText()||"0",10);const f=parseFloat(s.getCells()[7]?.getText()||"0",10);const p=parseFloat(s.getCells()[8]?.getText()||"0",10);const g=parseFloat(s.getCells()[9]?.getText()||"0",10);const x=parseFloat(s.getCells()[10]?.getText()||"0",10);const y=parseFloat(s.getCells()[11]?.getText()||"0");const I=parseFloat(s.getCells()[12]?.getText()||"0");if(!r||!i||!l||!c||isNaN(d)||isNaN(y)||isNaN(I)){return}const b={Vertical_ID:r,ConceptoOferta:c,PMJ:d,year1:Number(u.toFixed(2)),year2:Number(h.toFixed(2)),year3:Number(f.toFixed(2)),year4:Number(p.toFixed(2)),year5:Number(g.toFixed(2)),year6:Number(x.toFixed(2)),total:Number(y.toFixed(2)),totalE:Number(I.toFixed(2)),tipoServicio_ID:i,PerfilServicio_ID:l,datosProyect_ID:e};console.log("ID DE ACTUALIZACION -----\x3e>>>>",n);let m;if(n){m=await fetch(`/odata/v4/datos-cdo/RecursosInternos(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}else{m=await fetch("/odata/v4/datos-cdo/RecursosInternos",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}if(m.ok){const e=await m.json();console.log("üìå Respuesta completa de la API:",e);const t=e.ID;console.log("üìå ID de Recurso obtenido:",t);if(!t){console.error("‚ö†Ô∏è La API no devolvi√≥ un ID v√°lido.");return}this._RecursoInt=t;await this.InsertMesA√±oRecurInterno(s);console.log("TERMINANDO  RECURSOS------");console.log("Fila "+(o+1)+" guardada con √©xito: RECURSOS INTERNOS",e)}else{const e=await m.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}},"InsertMesA√±oRecurInterno":async function(e){console.log("ids recibidos  "+JSON.stringify(this._IdFechasPorMes));const t=this._RecursoInt;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuReInter?$filter=mesAno eq '${e}' and RecursosInternos_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMes[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={RecursosInternos_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuReInter(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuReInter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuReInter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±oServRecurInterno":async function(e){const t=this._idOtrosGastos;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=13;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuServReInter?$filter=mesAno eq '${e}' and otrosGastoRecu_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesServInt=this._IdFechasPorMesServInt||{};this._IdFechasPorMesServInt[a]=n}}else{console.warn(`‚ö†Ô∏è Error al verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={otrosGastoRecu_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);try{let t;if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuServReInter(${n})`);t=await fetch(`/odata/v4/datos-cdo/ValorMensuServReInter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);t=await fetch("/odata/v4/datos-cdo/ValorMensuServReInter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!t.ok){const e=await t.text();console.error(`‚ùå Error ${t.status} - ${t.statusText}:`,e);throw new Error(`Error al enviar: ${t.statusText}`)}else{console.log("‚úÖ Datos enviados correctamente para el mes:",e)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±oGastoViajRecuInterno":async function(e){const t=this._idOtrosRecu;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=13;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuGastViaReInter?$filter=mesAno eq '${e}' and otrosRecursos_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesGVinter[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={otrosRecursos_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuGastViaReInter(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuGastViaReInter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuGastViaReInter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},convertToInt:function(e){const t=parseFloat(e,10);return isNaN(t)?0:t},"InsertmesA√±oConsumoExterno":async function(e){const t=this._ConsuExt;const o=this._sCsrfToken;const a=this._idleeConsu;const s={};const n=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let a;if(typeof o.getValue==="function"){a=o.getValue()}else if(typeof o.getText==="function"){a=o.getText()}else{console.warn(`Tipo de celda inesperado en la columna din√°mica (√≠ndice ${t}):`,o);continue}if(a===null||a===undefined||a===""){console.warn(`Celda vac√≠a o nula en columna ${t}, se omite el env√≠o para esta columna.`);continue}let r=`Columna_${t}`;if(n[t]){const e=n[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("No se pudo obtener el texto del encabezado en la columna",t)}}else{console.warn(`No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`Se omite la columna ${r} porque es un total.`);continue}console.log(`Encabezado obtenido (columnHeader) para columna ${t}:`,r);console.log(`Valor de la celda (dynamicValue) para columna ${t}:`,a);s[r]=this.convertToInt(a)}console.log("Datos a enviar:",s);for(const[e,a]of Object.entries(s)){if(a===null||a===undefined){console.warn(`No se puede enviar un valor nulo para mes ${e}.`);continue}const s=`${e}_${t}`;let n=null;try{const a=await fetch(`/odata/v4/datos-cdo/ValorMensuConsuEx?$filter=mesAno eq '${e}' and ConsumoExternos_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(a.ok){const e=await a.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesConsuEx[s]=n}}else{console.warn(`No se pudo verificar existencia. C√≥digo: ${a.status}`)}}catch(e){console.error("Error al verificar existencia del registro:",e)}const r={ConsumoExternos_ID:t,mesAno:e,valor:a};console.log(`Payload preparado para enviar para mes '${e}' con idFecha: ${n}`,r);try{let t;if(n){console.log(`Haciendo PATCH a ValorMensuConsuEx(${n})`);t=await fetch(`/odata/v4/datos-cdo/ValorMensuConsuEx(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("Haciendo POST para nuevo mes:",e);t=await fetch("/odata/v4/datos-cdo/ValorMensuConsuEx",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!t.ok){const e=await t.text();throw new Error(`Error en la llamada al servicio: ${t.statusText}, Detalles: ${e}`)}else{console.log("Datos enviados con √©xito para el mes:",e)}}catch(e){console.error("Error al enviar los datos:",e)}}},"InsertmesA√±oServConExterno":async function(e){const t=this._idSerConsu;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=13;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=`/odata/v4/datos-cdo/ValorMensuServConsuEx?$filter=mesAno eq '${e}' and otrosServiciosConsu_ID eq '${t}'`;const r=await fetch(s,{headers:{Accept:"application/json","x-csrf-token":o}});if(r.ok){const e=await r.json();if(e.value.length>0){n=e.value[0].ID;this._IdFechasPorMesServiConsu=this._IdFechasPorMesServiConsu||{};this._IdFechasPorMesServiConsu[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${r.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={otrosServiciosConsu_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mesA√±o '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuServConsuEx(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuServConsuEx(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mesA√±o:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuServConsuEx",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log(`‚úÖ Datos enviados con √©xito para el mesA√±o: ${e}`)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertmesA√±oGViajeConExterno":async function(e){const t=this._idGasViaConsu;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=13;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en la columna din√°mica (√≠ndice ${t}):`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, se omite el env√≠o para esta columna.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en la columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Se omite la columna ${r} porque es un total.`);continue}console.log(`‚úÖ Encabezado obtenido (columnHeader) para columna ${t}:`,r);console.log(`‚úÖ Valor de la celda (dynamicValue) para columna ${t}:`,n);a[r]=this.convertToInt(n)}console.log("üì¶ Datos a enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è No se puede enviar un valor nulo para mes ${e}.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuGastoViaConsuEx?$filter=mesAno eq '${e}' and GastoViajeConsumo_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesGasViaConsuEx=this._IdFechasPorMesGasViaConsuEx||{};this._IdFechasPorMesGasViaConsuEx[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={GastoViajeConsumo_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuGastoViaConsuEx(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuGastoViaConsuEx(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuGastoViaConsuEx",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log("‚úÖ Datos enviados con √©xito para el mes:",e)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±oRecursoExterno":async function(e){const t=this._idRecursoEx;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, se omite.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuRecuExter?$filter=mesAno eq '${e}' and RecursosExternos_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesREExt[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={RecursosExternos_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuRecuExter(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuRecuExter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuRecuExter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log(`‚úÖ Datos enviados correctamente para el mes: ${e}`)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±osSerRecursoExterno":async function(e){console.log("ids recibidos  "+JSON.stringify(this._idleeSerRExt));const t=this._idServiExterno;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=13;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuSerExter?$filter=mesAno eq '${e}' and ServiRecurExterno_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesSerReEx[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={ServiRecurExterno_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuSerExter(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuSerExter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuSerExter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log("‚úÖ Datos enviados con √©xito para el mes:",e)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±osGastoRecursoExterno":async function(e){const t=this._idGastoRecuExter;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuGastoViExter?$filter=mesAno eq '${e}' and GastoViajeRecExter_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesReEx[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={GastoViajeRecExter_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuGastoViExter(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuGastoViExter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuGastoViExter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log(`‚úÖ Datos enviados con √©xito para '${e}'`)}}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±osOtrosConceptos":async function(e){const t=this._idOtrosConcep;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar:",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensuOtrConcep?$filter=mesAno eq '${e}' and otrosConceptos_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesOtConp=this._IdFechasPorMesOtConp||{};this._IdFechasPorMesOtConp[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={otrosConceptos_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar:",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensuOtrConcep(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensuOtrConcep(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensuOtrConcep",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}console.log(`‚úÖ Enviado con √©xito para mes: ${e}`)}catch(e){console.error("üö® Error durante env√≠o de datos:",e)}}},"InsertMesA√±osLicencia":async function(e){const t=this._idLicencia;const o=this._sCsrfToken;const a={};const s=e.getParent().getColumns();for(let t=12;t<e.getCells().length;t++){const o=e.getCells()[t];let n;if(typeof o.getValue==="function"){n=o.getValue()}else if(typeof o.getText==="function"){n=o.getText()}else{console.warn(`‚ö†Ô∏è Tipo de celda inesperado en columna ${t}:`,o);continue}if(n===null||n===undefined||n===""){console.warn(`‚ö†Ô∏è Celda vac√≠a o nula en columna ${t}, omitida.`);continue}let r=`Columna_${t}`;if(s[t]){const e=s[t].getHeader();if(e&&typeof e.getText==="function"){r=e.getText()||r}else{console.warn("‚ö†Ô∏è No se pudo obtener el texto del encabezado en columna",t)}}else{console.warn(`‚ö†Ô∏è No se puede acceder a la columna en √≠ndice ${t}`)}if(r.toLowerCase().includes("total")){console.warn(`üõë Columna ${r} omitida por ser TOTAL.`);continue}console.log(`‚úÖ Columna din√°mica: '${r}' con valor: ${n}`);a[r]=this.convertToInt(n)}console.log("üì¶ Datos recolectados para enviar (Licencias):",a);for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){console.warn(`‚ö†Ô∏è Valor nulo/undefined para '${e}', se omite.`);continue}const a=`${e}_${t}`;let n=null;try{const s=await fetch(`/odata/v4/datos-cdo/ValorMensulicencia?$filter=mesAno eq '${e}' and licencia_ID eq '${t}'`,{headers:{Accept:"application/json","x-csrf-token":o}});if(s.ok){const e=await s.json();const t=e.value;if(t.length>0){n=t[0].ID;this._IdFechasPorMesLicencia=this._IdFechasPorMesLicencia||{};this._IdFechasPorMesLicencia[a]=n}}else{console.warn(`‚ö†Ô∏è No se pudo verificar existencia. C√≥digo: ${s.status}`)}}catch(e){console.error("üö® Error al verificar existencia del registro:",e)}const r={licencia_ID:t,mesAno:e,valor:s};console.log(`üïì Procesando mes '${e}' con idFecha: ${n}`);console.log("üì§ Payload a enviar (Licencia):",r);let i;try{if(n){console.log(`üîÅ Haciendo PATCH a ValorMensulicencia(${n})`);i=await fetch(`/odata/v4/datos-cdo/ValorMensulicencia(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}else{console.log("üÜï Haciendo POST para nuevo mes:",e);i=await fetch("/odata/v4/datos-cdo/ValorMensulicencia",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},body:JSON.stringify(r)})}if(!i.ok){const e=await i.text();console.error(`‚ùå Error ${i.status} - ${i.statusText}:`,e);throw new Error(`Error al enviar: ${i.statusText}`)}else{console.log("‚úÖ Datos enviados con √©xito para el mes:",e)}}catch(e){console.error("üö® Error durante env√≠o de datos (Licencia):",e)}}},insertServicioInterno:async function(e){const t=this._sCsrfToken;let o;const a=this.byId("tableServicioInterno");const s=a.getItems();for(let a=0;a<s.length;a++){const n=s[a];const r=this._idServiInterno&&this._idServiInterno[a]?this._idServiInterno[a]:null;const i=n.getCells()[0].getSelectedKey();const l=n.getCells()[1].getSelectedKey();const c=n.getCells()[3].getValue();const d=this.convertToInt(n.getCells()[4].getText());const u=parseFloat(n.getCells()[5]?.getText()||"0");const h=parseFloat(n.getCells()[6]?.getText()||"0");const f=parseFloat(n.getCells()[7]?.getText()||"0");const p=parseFloat(n.getCells()[8]?.getText()||"0");const g=parseFloat(n.getCells()[9]?.getText()||"0");const x=parseFloat(n.getCells()[10]?.getText()||"0");const y=this.convertToInt(n.getCells()[11].getText());const I=this.convertToInt(n.getCells()[12].getText());if(!i||!l||!c||isNaN(d)||isNaN(y)){return}const b={Vertical_ID:i,ConceptoOferta:c,PMJ:d,year1:Number(u.toFixed(2)),year2:Number(h.toFixed(2)),year3:Number(f.toFixed(2)),year4:Number(p.toFixed(2)),year5:Number(g.toFixed(2)),year6:Number(x.toFixed(2)),total:Number(y),totalE:I,tipoServicio_ID:l,datosProyect_ID:e};try{if(r){o=await fetch(`/odata/v4/datos-cdo/otrosGastoRecu(${r})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}else{o=await fetch("/odata/v4/datos-cdo/otrosGastoRecu",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}if(o.ok){const e=await o.json();const t=e.ID;this._idOtrosGastos=t;await this.InsertMesA√±oServRecurInterno(n,t);console.log("Fila "+(a+1)+" guardada con √©xito: INSERT OTROS GASTOS ",e)}else{const e=await o.text();console.error("Error al guardar la fila "+(a+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(a+1)+":",e)}}},insertGastoViajeInterno:async function(e){const t=this._sCsrfToken;const o=this.byId("tablGastoViajeInterno");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._IdGastoViajInter&&this._IdGastoViajInter[o]?this._IdGastoViajInter[o]:null;const r=s.getCells()[0].getSelectedKey();const i=s.getCells()[1].getSelectedKey();const l=s.getCells()[3].getValue();const c=this.convertToInt(s.getCells()[4].getText());const d=parseFloat(s.getCells()[5]?.getText()||"0");const u=parseFloat(s.getCells()[6]?.getText()||"0");const h=parseFloat(s.getCells()[7]?.getText()||"0");const f=parseFloat(s.getCells()[8]?.getText()||"0");const p=parseFloat(s.getCells()[9]?.getText()||"0");const g=parseFloat(s.getCells()[10]?.getText()||"0");const x=this.convertToInt(s.getCells()[11].getText());const y=this.convertToInt(s.getCells()[12].getText());if(!r||!i||!l||isNaN(c)||isNaN(x)||isNaN(y)){return}const I={Vertical_ID:r,ConceptoOferta:l,PMJ:c,year1:Number(d.toFixed(2)),year2:Number(u.toFixed(2)),year3:Number(h.toFixed(2)),year4:Number(f.toFixed(2)),year5:Number(p.toFixed(2)),year6:Number(g.toFixed(2)),total:Number(x.toFixed(2)),totalE:y,tipoServicio_ID:i,datosProyect_ID:e};let b;try{if(n){b=await fetch(`/odata/v4/datos-cdo/otrosRecursos(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}else{b=await fetch("/odata/v4/datos-cdo/otrosRecursos",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}if(b.ok){const e=await b.json();const t=e.ID;this._idOtrosRecu=t;await this.InsertMesA√±oGastoViajRecuInterno(s);console.log("Fila "+(o+1)+" guardada con √©xito: OTROS RECURSOS ",e)}else{const e=await b.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},insertCosumoExterno:async function(e){const t=this._sCsrfToken;const o=this.byId("tablaConsuExter");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._consumoExternosIDs&&this._consumoExternosIDs[o]?this._consumoExternosIDs[o]:null;const r=s.getCells()[0].getSelectedKey()||"ValorPorDefecto";const i=s.getCells()[1].getSelectedKey()||"ValorPorDefecto";const l=s.getCells()[2].getSelectedKey()||"ValorPorDefecto";const c=s.getCells()[3].getValue()||"";const d=this.convertToInt(s.getCells()[4].getText())||0;const u=parseFloat(s.getCells()[5]?.getText()||"0");const h=parseFloat(s.getCells()[6]?.getText()||"0");const f=parseFloat(s.getCells()[7]?.getText()||"0");const p=parseFloat(s.getCells()[8]?.getText()||"0");const g=parseFloat(s.getCells()[9]?.getText()||"0");const x=parseFloat(s.getCells()[10]?.getText()||"0");const y=parseFloat(s.getCells()[11].getText())||0;const I=parseFloat(s.getCells()[12].getText())||0;if(!r||!i||!l||!c||isNaN(d)||isNaN(y)||isNaN(I)){return}const b={Vertical_ID:r,ConceptoOferta:c,PMJ:d,year1:Number(u.toFixed(2)),year2:Number(h.toFixed(2)),year3:Number(f.toFixed(2)),year4:Number(p.toFixed(2)),year5:Number(g.toFixed(2)),year6:Number(x.toFixed(2)),total:y,totalC:I,tipoServicio_ID:i,PerfilConsumo_ID:l,datosProyect_ID:e};console.log("-----\x3e>>>> DATOS TRAIDOS CONSUMO EXTERNO ----- ",b);let m;if(n){console.log("Entrando a PATCH");m=await fetch(`/odata/v4/datos-cdo/ConsumoExternos(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}else{m=await fetch("/odata/v4/datos-cdo/ConsumoExternos",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}if(m.ok){const e=await m.json();const t=e.ID;this._ConsuExt=t;await this.InsertmesA√±oConsumoExterno(s);console.log("Fila "+(o+1)+" guardada con √©xito: CONSUMO EXTERNO",e)}else{const e=await m.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}},insertServiConsu:async function(e){const t=this._sCsrfToken;const o=this._idConOS;const a=this.byId("idOtroserConsu");const s=a.getItems();for(let o=0;o<s.length;o++){const a=s[o];const n=this._idConsuOtrser&&this._idConsuOtrser[o]?this._idConsuOtrser[o]:null;const r=a.getCells()[0].getSelectedKey();const i=a.getCells()[1].getSelectedKey();const l=a.getCells()[3].getValue();const c=this.convertToInt(a.getCells()[4].getText());const d=parseFloat(a.getCells()[5]?.getText()||"0");const u=parseFloat(a.getCells()[6]?.getText()||"0");const h=parseFloat(a.getCells()[7]?.getText()||"0");const f=parseFloat(a.getCells()[8]?.getText()||"0");const p=parseFloat(a.getCells()[9]?.getText()||"0");const g=parseFloat(a.getCells()[10]?.getText()||"0");const x=this.convertToInt(a.getCells()[11].getText());const y=this.convertToInt(a.getCells()[12].getText());if(!r||!i||!l||isNaN(c)||isNaN(x)){return}const I={Vertical_ID:r,ConceptoOferta:l,PMJ:c,year1:Number(d.toFixed(2)),year2:Number(u.toFixed(2)),year3:Number(h.toFixed(2)),year4:Number(f.toFixed(2)),year5:Number(p.toFixed(2)),year6:Number(g.toFixed(2)),total:Number(x.toFixed(2)),totalE:y,tipoServicio_ID:i,datosProyect_ID:e};let b;try{if(n){b=await fetch(`/odata/v4/datos-cdo/otrosServiciosConsu(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}else{b=await fetch("/odata/v4/datos-cdo/otrosServiciosConsu",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}if(b.ok){const e=await b.json();const t=e.ID;this._idSerConsu=t;await this.InsertmesA√±oServConExterno(a);console.log("Fila "+(o+1)+" guardada con √©xito: INSERT SERVI ",e)}else{const e=await b.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},insertGastoConsu:async function(e){const t=this._sCsrfToken;const o=this.byId("idGastoViajeConsu");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._idGastoViajeCOnsu&&this._idGastoViajeCOnsu[o]?this._idGastoViajeCOnsu[o]:null;const r=s.getCells()[0].getSelectedKey();const i=s.getCells()[1].getSelectedKey();const l=s.getCells()[3].getValue();const c=this.convertToInt(s.getCells()[4].getText());const d=parseFloat(s.getCells()[5]?.getText()||"0");const u=parseFloat(s.getCells()[6]?.getText()||"0");const h=parseFloat(s.getCells()[7]?.getText()||"0");const f=parseFloat(s.getCells()[8]?.getText()||"0");const p=parseFloat(s.getCells()[9]?.getText()||"0");const g=parseFloat(s.getCells()[10]?.getText()||"0");const x=this.convertToInt(s.getCells()[11].getText());const y=this.convertToInt(s.getCells()[12].getText());if(!r||!i||!l||isNaN(c)||isNaN(x)){return}const I={Vertical_ID:r,ConceptoOferta:l,PMJ:c,year1:Number(d.toFixed(2)),year2:Number(u.toFixed(2)),year3:Number(h.toFixed(2)),year4:Number(f.toFixed(2)),year5:Number(p.toFixed(2)),year6:Number(g.toFixed(2)),total:x,totalE:y,tipoServicio_ID:i,datosProyect_ID:e};let b;try{if(n){b=await fetch(`/odata/v4/datos-cdo/GastoViajeConsumo(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}else{b=await fetch("/odata/v4/datos-cdo/GastoViajeConsumo",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}if(b.ok){const e=await b.json();const t=e.ID;this._idGasViaConsu=t;await this.InsertmesA√±oGViajeConExterno(s);console.log("Fila "+(o+1)+" guardada con √©xito: INSERTVIAJES CONSUMO ",e)}else{const e=await b.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},insertRecursoExterno:async function(e){const t=this._sCsrfToken;const o=this.byId("tablaRecExterno");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._RecursoExterno&&this._RecursoExterno[o]?this._RecursoExterno[o]:null;const r=s.getCells()[0].getSelectedKey()||"";const i=s.getCells()[1].getSelectedKey()||"";const l=s.getCells()[2].getValue()||"";const c=s.getCells()[3].getValue()||"";const d=parseFloat(s.getCells()[4].getValue())||0;const u=parseFloat(s.getCells()[5]?.getText()||"0");const h=parseFloat(s.getCells()[6]?.getText()||"0");const f=parseFloat(s.getCells()[7]?.getText()||"0");const p=parseFloat(s.getCells()[8]?.getText()||"0");const g=parseFloat(s.getCells()[9]?.getText()||"0");const x=parseFloat(s.getCells()[10]?.getText()||"0");const y=parseFloat(s.getCells()[11].getText())||0;const I=parseFloat(s.getCells()[12].getText())||0;if(!r&&!i&&!l&&!c&&d===0&&y===0&&I===0){console.warn("Fila",o+1,"est√° vac√≠a, se omite.");continue}const b={Vertical_ID:r,ConceptoOferta:c,PMJ:d,year1:Number(u.toFixed(2)),year2:Number(h.toFixed(2)),year3:Number(f.toFixed(2)),year4:Number(p.toFixed(2)),year5:Number(g.toFixed(2)),year6:Number(x.toFixed(2)),total:y,totalR:I,tipoServicio_ID:i,PerfilServicio:l,datosProyect_ID:e};console.log("Payload enviado:",JSON.stringify(b,null,2));console.log("DATOS RECU EXTRA  "+JSON.stringify(b,null,2));let m;try{if(n){m=await fetch(`/odata/v4/datos-cdo/RecursosExternos(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}else{m=await fetch("/odata/v4/datos-cdo/RecursosExternos",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(b)})}if(m.ok){const e=await m.json();const t=e.ID;this._idRecursoEx=t;await this.InsertMesA√±oRecursoExterno(s);console.log("Fila "+(o+1)+" guardada con √©xito:RECURSO EXTERNO",e)}else{const e=await m.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},insertServicioRecuExter:async function(e){const t=this._sCsrfToken;const o=this.byId("idServiExterno");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._idOtroSerEx&&this._idOtroSerEx[o]?this._idOtroSerEx[o]:null;const r=s.getCells()[0].getSelectedKey();const i=s.getCells()[1].getSelectedKey();const l=s.getCells()[3].getValue();const c=this.convertToInt(s.getCells()[4].getText());const d=parseFloat(s.getCells()[5]?.getText()||"0");const u=parseFloat(s.getCells()[6]?.getText()||"0");const h=parseFloat(s.getCells()[7]?.getText()||"0");const f=parseFloat(s.getCells()[8]?.getText()||"0");const p=parseFloat(s.getCells()[9]?.getText()||"0");const g=parseFloat(s.getCells()[10]?.getText()||"0");const x=this.convertToInt(s.getCells()[11].getText());const y=this.convertToInt(s.getCells()[12].getText());if(!r||!i||!l||isNaN(c)||isNaN(x)){return}const I={Vertical_ID:r,ConceptoOferta:l,PMJ:c,year1:Number(d.toFixed(2)),year2:Number(u.toFixed(2)),year3:Number(h.toFixed(2)),year4:Number(f.toFixed(2)),year5:Number(p.toFixed(2)),year6:Number(g.toFixed(2)),total:x,totalE:y,tipoServicio_ID:i,datosProyect_ID:e};let b;if(n){b=await fetch(`/odata/v4/datos-cdo/serviRecurExter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}else{b=await fetch("/odata/v4/datos-cdo/serviRecurExter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}if(b.ok){const e=await b.json();const t=e.ID;this._idServiExterno=t;await this.InsertMesA√±osSerRecursoExterno(s);console.log("Fila "+(o+1)+" guardada con √©xito: SERVICIO EXTERNO  ",e)}else{const e=await b.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}},insertGastoViajeExterno:async function(e){const t=this._sCsrfToken;const o=this._idReExGas;const a=this.byId("idGastoRecuExter");const s=a.getItems();for(let o=0;o<s.length;o++){const a=s[o];const n=this._idGasViaReEx&&this._idGasViaReEx[o]?this._idGasViaReEx[o]:null;const r=a.getCells()[0].getSelectedKey();const i=a.getCells()[1].getSelectedKey();const l=a.getCells()[3].getValue();const c=this.convertToInt(a.getCells()[4].getText());const d=parseFloat(a.getCells()[5]?.getText()||"0");const u=parseFloat(a.getCells()[6]?.getText()||"0");const h=parseFloat(a.getCells()[7]?.getText()||"0");const f=parseFloat(a.getCells()[8]?.getText()||"0");const p=parseFloat(a.getCells()[9]?.getText()||"0");const g=parseFloat(a.getCells()[10]?.getText()||"0");const x=this.convertToInt(a.getCells()[11].getText());const y=this.convertToInt(a.getCells()[12].getText());if(!r||!i||!l||isNaN(c)||isNaN(x)){return}const I={Vertical_ID:r,ConceptoOferta:l,PMJ:c,year1:Number(d.toFixed(2)),year2:Number(u.toFixed(2)),year3:Number(h.toFixed(2)),year4:Number(f.toFixed(2)),year5:Number(p.toFixed(2)),year6:Number(g.toFixed(2)),total:x,totalE:y,tipoServicio_ID:i,datosProyect_ID:e};console.log("Payload de Gasto Externo:",I);console.log("PAYLOAD DE GASTO EXTERNO "+JSON.stringify(I,null,2));let b;if(n){b=await fetch(`/odata/v4/datos-cdo/GastoViajeRecExter(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}else{b=await fetch("/odata/v4/datos-cdo/GastoViajeRecExter",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(I)})}if(b.ok){const e=await b.json();const t=e.ID;this._idGastoRecuExter=t;await this.InsertMesA√±osGastoRecursoExterno(a);console.log("Fila "+(o+1)+" guardada con √©xito: INSERTVIAJES RECURSO EXTERNO  ",e)}else{const e=await b.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}},insertarOtrosConceptos:async function(e){const t=this._sCsrfToken;const o=this.byId("tablaInfrestuctura");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._OtrosConceptos&&this._OtrosConceptos[o]?this._OtrosConceptos[o]:null;const r=s.getCells()[0].getSelectedKey();const i=s.getCells()[2].getValue();const l=parseFloat(s.getCells()[3]?.getText());const c=parseFloat(s.getCells()[4]?.getText()||"0");const d=parseFloat(s.getCells()[5]?.getText()||"0");const u=parseFloat(s.getCells()[6]?.getText()||"0");const h=parseFloat(s.getCells()[7]?.getText()||"0");const f=parseFloat(s.getCells()[8]?.getText()||"0");const p=parseFloat(s.getCells()[9]?.getText()||"0");const g=parseFloat(s.getCells()[10]?.getText());const x=parseFloat(s.getCells()[11]?.getText());if(!r||!i){return}const y={Vertical_ID:r,ConceptoOferta:i,PMJ:l,year1:Number(c.toFixed(2)),year2:Number(d.toFixed(2)),year3:Number(u.toFixed(2)),year4:Number(h.toFixed(2)),year5:Number(f.toFixed(2)),year6:Number(p.toFixed(2)),total:g,totalC:x,datosProyect_ID:e};let I;try{if(n){I=await fetch(`/odata/v4/datos-cdo/otrosConceptos(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(y)})}else{I=await fetch("/odata/v4/datos-cdo/otrosConceptos",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(y)})}if(I.ok){const e=await I.json();const t=e.ID;this._idOtrosConcep=t;await this.InsertMesA√±osOtrosConceptos(s);console.log("Fila "+(o+1)+" guardada con √©xito: INSERTVIAJES RECURSO EXTERNO  ",e)}else{const e=await I.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},insertarLicencia:async function(e){const t=this._sCsrfToken;const o=this.byId("tablaLicencia");const a=o.getItems();for(let o=0;o<a.length;o++){const s=a[o];const n=this._idLicencia&&this._idLicencia[o]?this._idLicencia[o]:null;const r=s.getCells()[0].getSelectedKey();const i=s.getCells()[2].getValue();const l=parseFloat(s.getCells()[3]?.getText());const c=parseFloat(s.getCells()[5]?.getText()||"0");const d=parseFloat(s.getCells()[6]?.getText()||"0");const u=parseFloat(s.getCells()[7]?.getText()||"0");const h=parseFloat(s.getCells()[8]?.getText()||"0");const f=parseFloat(s.getCells()[9]?.getText()||"0");const p=parseFloat(s.getCells()[10]?.getText()||"0");const g=parseFloat(s.getCells()[4]?.getText());const x=parseFloat(s.getCells()[5]?.getText());if(!r||!i){return}const y={Vertical_ID:r,ConceptoOferta:i,PMJ:l,year1:Number(c.toFixed(2)),year2:Number(d.toFixed(2)),year3:Number(u.toFixed(2)),year4:Number(h.toFixed(2)),year5:Number(f.toFixed(2)),year6:Number(p.toFixed(2)),total:g,totalC:x,datosProyect_ID:e};let I;try{if(n){I=await fetch(`/odata/v4/datos-cdo/LicenciasCon(${n})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(y)})}else{I=await fetch("/odata/v4/datos-cdo/LicenciasCon",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(y)})}if(I.ok){const e=await I.json();const t=e.ID;this._idLicencia=t;await this.InsertMesA√±osLicencia(s);console.log("Fila "+(o+1)+" guardada con √©xito: INSERTAR LICENCIA ",e)}else{const e=await I.text();console.error("Error al guardar la fila "+(o+1)+":",e)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(o+1)+":",e)}}},convertToInt:function(e){const t=parseFloat(e,10);return isNaN(t)?null:t},insertClientFactura:async function(e){const t=this._sCsrfToken;var o=this.byId("table_clienteFac");var a=o.getItems();var s=[];var n=0;a.forEach(function(t){var o=t.getCells();var a=o[0]?o[0].getMetadata().getName()==="sap.m.Input"?o[0].getValue():o[0].getText():"";var r=o[1]?o[1].getMetadata().getName()==="sap.m.Input"?o[1].getValue():o[1].getText():"";if(a.trim()==="Total"){return}var i=this.byId("text73_172746565340567").getText();var i=parseFloat(i.replace("%","").replace(",","."))||0;if(a===""&&r===""){return}s.push({juridica:a,oferta:r,total:i,datosProyect_ID:e});n+=parseFloat(r)||0}.bind(this));try{const o=await fetch(`/odata/v4/datos-cdo/ClientFactura?$filter=datosProyect_ID eq '${e}'`,{method:"GET",headers:{Accept:"application/json","x-csrf-token":t}});if(!o.ok)throw new Error("Error al verificar existencia de las Facturas");const a=await o.json();const n=a.value||[];for(let e of s){let o=n.find(t=>t.juridica===e.juridica);if(o){const a=await fetch(`/odata/v4/datos-cdo/ClientFactura(${o.ID})`,{method:"PATCH",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(e)});if(a.ok){console.log(`Factura actualizada:`,await a.json())}else{console.log("Error al actualizar Factura:",await a.text())}}else{const o=await fetch("/odata/v4/datos-cdo/ClientFactura",{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify(e)});if(o.ok){console.log("Factura insertada:",await o.json())}else{console.log("Error al insertar Factura:",await o.text())}}}}catch(e){console.error("Error en la operaci√≥n:",e)}},metodoSumar:function(){var e=this.byId("table_clienteFac");var t=e.getItems();var o=0;t.forEach(function(e,a){if(a<t.length-1){var s=e.getCells();var n="";var r=s[1];if(r.getMetadata().getName()==="sap.m.Input"){n=r.getValue()}n=n.trim();var i=parseFloat(n);if(!isNaN(i)){o+=i;console.log("Total acumulado hasta ahora:",o)}}});this.byId("text73_172746565340567").setText(o.toFixed(2)+"%");this._totalOferta=o},metodoSumarFac:function(){var e=this.byId("table0");var t=e.getItems();var o=0;console.log("Cantidad de filas en la tabla:",t.length);t.forEach(function(e,a){if(a<t.length-1){var s=e.getCells();var n="";var r=s[2];if(r.getMetadata().getName()==="sap.m.Input"){n=r.getValue()}n=n.trim();var i=parseFloat(n);console.log("Fila:",a,"Valor de la celda:",n,"-> Valor num√©rico:",i);if(!isNaN(i)){o+=i;console.log("Total acumulado hasta ahora:",o)}}});this.byId("text73_172746565340569997").setText(o.toFixed(2));console.log("Total de la columna oferta:",o)},formatDuration:function(e){const t=Math.floor(e);const o=Math.floor((e-t)*60);const a=0;return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`},onClearFields:function(){var e=this.getView();function t(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}if(e.getAggregation){const o=e.getMetadata().getAllAggregations();for(let a in o){const o=e.getAggregation(a);if(Array.isArray(o)){o.forEach(t)}else if(o instanceof sap.ui.core.Control){t(o)}}}}e.findAggregatedObjects(false,t)},onSelectIniMethod:function(e){this.onInputChange(e);this.onSelectOpx(e)},onselectmethodsetinfo:function(e){this.onInputChange(e);this.fechasDinamicas(e);this.CaseAno()},CaseAno:function(e){var t=this.getView().byId("date_inico");var o=this.getView().byId("date_fin");var a=t.getDateValue();var s=o.getDateValue();if(a&&s){var n=a.getFullYear();var r=s.getFullYear();if(n>r){sap.m.MessageToast.show("La fecha de inicio no puede ser mayor que la fecha de fin.");return}var i=[];for(var l=n;l<=r;l++){i.push(l)}let e=this.calcularDistribucionInput();if(!e||!e.valoresDistribuidos)return;let t=e.valoresDistribuidos;let o=e.acumuladoTextPorTablaYAnio;if(!t||Object.keys(t).length===0){return}var c=this;var d=0;var u={};var h={};var f={};i.forEach(e=>{u[e]=0;h[e]={}});Object.keys(t).forEach(function(e){i.forEach(function(o){if(t[e]&&t[e][o]){t[e][o].forEach(e=>{var t=e.elemento;var a=parseFloat(e.valor)||0;u[o]+=a;d+=a;if(!h[o][t]){h[o][t]=0}h[o][t]+=a;if(!f[t]){f[t]=0}f[t]+=a})}})});i.forEach(e=>{switch(e){case 2025:c.getView().byId("tipoS2025").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteT2025").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("cellCostesTotales_1_1").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecurso2025").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteD2025").setText((h[e]["Input2"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("costes_indirectos2025").setText((h[e]["Input3"]||0).toFixed(2)+"‚Ç¨");this.getView().byId("text129CosteDi").setText((o[e]?.table_dimicFecha??0).toFixed(2)+"‚Ç¨");this.getView().byId("text130CosteDi").setText((o[e]?.tablaConsuExter??0).toFixed(2)+"‚Ç¨");this.getView().byId("text210").setText((o[e]?.tablGastoViajeInterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text400").setText((o[e]?.tablaRecExterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text133").setText((o[e]?.tablaLicencia??0).toFixed(2)+"‚Ç¨");this.getView().byId("text200").setText((o[e]?.tablaInfrestuctura??0).toFixed(2)+"‚Ç¨");let t=(o[2025]?.table_dimicFecha||0)+(o[2025]?.tablaConsuExter||0)+(o[2025]?.tablGastoViajeInterno||0)+(o[2025]?.tablaRecExterno||0)+(o[2025]?.tablaLicencia||0)+(o[2025]?.tablaInfrestuctura||0);c.getView().byId("text75_1729073618729").setText(t.toFixed(2)+"‚Ç¨");break;case 2026:c.getView().byId("tipoS2026").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecurso2026").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteT2026").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("cellCostesTotales_1_2").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteD2026").setText((h[e]["Input2"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("costes_indirectos2026").setText((h[e]["Input3"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text128CosteDi").setText((o[e]?.table_dimicFecha??0).toFixed(2)+"‚Ç¨");c.getView().byId("text134CosteDi").setText((o[e]?.tablaConsuExter??0).toFixed(2)+"‚Ç¨");this.getView().byId("text211").setText((o[e]?.tablGastoViajeInterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text401").setText((o[e]?.tablaRecExterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text1341").setText((o[e]?.tablaLicencia??0).toFixed(2)+"‚Ç¨");this.getView().byId("text201").setText((o[e]?.tablaInfrestuctura??0).toFixed(2)+"‚Ç¨");let a=(o[2026]?.table_dimicFecha||0)+(o[2026]?.tablaConsuExter||0)+(o[2026]?.tablGastoViajeInterno||0)+(o[2026]?.tablaRecExterno||0)+(o[2026]?.tablaLicencia||0)+(o[2026]?.tablaInfrestuctura||0);c.getView().byId("text76_1729073618732").setText(a.toFixed(2)+"‚Ç¨");break;case 2027:c.getView().byId("tipoS2027").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecurso2027").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteT2027").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteD2027").setText((h[e]["Input2"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("costes_indirectos2027").setText((h[e]["Input3"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text135").setText((o[e]?.tablaConsuExter??0).toFixed(2)+"‚Ç¨");c.getView().byId("text140CosteDi").setText((o[e]?.table_dimicFecha??0).toFixed(2)+"‚Ç¨");this.getView().byId("text212").setText((o[e]?.tablGastoViajeInterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text402").setText((o[e]?.tablaRecExterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text1352").setText((o[e]?.tablaLicencia??0).toFixed(2)+"‚Ç¨");this.getView().byId("text202").setText((o[e]?.tablaInfrestuctura??0).toFixed(2)+"‚Ç¨");let s=(o[2027]?.table_dimicFecha||0)+(o[2027]?.tablaConsuExter||0)+(o[2027]?.tablGastoViajeInterno||0)+(o[2027]?.tablaRecExterno||0)+(o[2027]?.tablaLicencia||0)+(o[2027]?.tablaInfrestuctura||0);c.getView().byId("text77_1729073618734").setText(s.toFixed(2)+"‚Ç¨");break;case 2028:c.getView().byId("tipoS2028").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecurso2027").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteT2028").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text141CosteDi").setText((o[e]?.table_dimicFecha??0).toFixed(2)+"‚Ç¨");c.getView().byId("text136").setText((o[e]?.tablaConsuExter??0).toFixed(2)+"‚Ç¨");this.getView().byId("text213").setText((o[e]?.tablGastoViajeInterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text403").setText((o[e]?.tablaRecExterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text1363").setText((o[e]?.tablaLicencia??0).toFixed(2)+"‚Ç¨");this.getView().byId("text203").setText((o[e]?.tablaInfrestuctura??0).toFixed(2)+"‚Ç¨");let n=(o[2028]?.table_dimicFecha||0)+(o[2028]?.tablaConsuExter||0)+(o[2028]?.tablGastoViajeInterno||0)+(o[2028]?.tablaRecExterno||0)+(o[2028]?.tablaLicencia||0)+(o[2028]?.tablaInfrestuctura||0);c.getView().byId("text300").setText(n.toFixed(2)+"‚Ç¨");break;case 2029:c.getView().byId("tipoS2029").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecurso2027").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteT2029").setText((h[e]["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text143CosteDi").setText((o[e]?.table_dimicFecha??0).toFixed(2)+"‚Ç¨");this.getView().byId("text214").setText((o[e]?.tablGastoViajeInterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text138").setText((o[e]?.tablaConsuExter??0).toFixed(2)+"‚Ç¨");this.getView().byId("text404").setText((o[e]?.tablaRecExterno??0).toFixed(2)+"‚Ç¨");this.getView().byId("text1374").setText((o[e]?.tablaLicencia??0).toFixed(2)+"‚Ç¨");this.getView().byId("text204").setText((o[e]?.tablaInfrestuctura??0).toFixed(2)+"‚Ç¨");let r=(o[2029]?.table_dimicFecha||0)+(o[2029]?.tablaConsuExter||0)+(o[2029]?.tablGastoViajeInterno||0)+(o[2029]?.tablaRecExterno||0)+(o[2029]?.tablaLicencia||0)+(o[2029]?.tablaInfrestuctura||0);c.getView().byId("text301").setText(r.toFixed(2)+"‚Ç¨");break}});c.getView().byId("tipoSTotal").setText((f["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TRecursoTotal").setText((f["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteTotalD").setText((f["Input2"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("TSCosteTotal").setText((f["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("cellCostesTotales_1_7").setText((f["Input1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("costes_indirectosTotal").setText((f["Input3"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text70_1729079344938").setText((f["Text1"]||0).toFixed(2)+"‚Ç¨");c.getView().byId("text137").setText((f["Text4"]||0).toFixed(2)+"‚Ç¨")}else{}},onDateChange:function(){this.updateVizFrame()},fechasDinamicas:function(){var e=this.getView().getModel("dynamicInputs");var t=null;if(!e){e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"dynamicInputs")}else{t=e.getData()}this._inputsDinamicos={};this._tableValues={};this._yearlySums={};this._monthlySums={};var o=this.getView().byId("date_inico");var a=this.getView().byId("date_fin");if(!o||!a){console.error("Error: No se pudieron obtener los DatePickers.");return}var s=o.getDateValue();var n=a.getDateValue();if(!s||!n){return}var r=this.getMonthsDifference(s,n);var i=["box0_1714747137718","box0_1727879568594","box0_1727879817594","box0_1721815443829","box0_1727948724833","box0_1727950351451","box0_17218154429","box0_1727953252765","box1_1727953468615","box0_17254429","box0_1727955568380"];i.forEach(e=>{var t=this.getView().byId(e);if(t){t.setWidth(r>3?"3000px":"100%")}});var l=["tablaConsuExter","table_dimicFecha","tablaRecExterno","idOtroserConsu","idGastoViajeConsu","idServiExterno","idGastoRecuExter","tablaInfrestuctura","tablaLicencia","tableServicioInterno","tablGastoViajeInterno"];var c={};l.forEach(e=>{var o=this.getView().byId(e);if(!o){console.error("Error: No se pudo obtener la tabla con ID "+e);return}var a=o.getColumns().length;for(var n=a-1;n>=0;n--){var i=o.getColumns()[n].getHeader();if(i&&/\d{4}-\w+/.test(i.getText())){o.removeColumn(o.getColumns()[n])}}o.getItems().forEach(e=>{var t=e.getCells();var a=o.getColumns().filter(e=>{var t=e.getHeader();return!(t&&/\d{4}-\w+/.test(t.getText()))}).length;while(e.getCells().length>a){e.removeCell(e.getCells().length-1)}});var l=this.findTotalColumnIndex(o);c[e]={};for(var d=0;d<=r;d++){var u=new Date(s.getFullYear(),s.getMonth()+d,1);var h=u.getFullYear();var f=u.toLocaleString("default",{month:"long"});var p=h+"-"+f;var g=new sap.m.Column({header:new sap.m.Label({text:p}),width:"100px"});o.insertColumn(g,l+1+d);o.getItems().forEach((o,a)=>{c[e][a]=c[e][a]||{};var s="";if(t&&t[e]&&t[e][a]){s=t[e][a][p]||""}var n=new sap.m.Input({placeholder:"0.00",value:s,change:this.handleInputChange.bind(this,e,a,d,h)});n.attachBrowserEvent("paste",this._onPasteValues.bind(this));o.addCell(n);this._inputsDinamicos=this._inputsDinamicos||{};this._inputsDinamicos[e]=this._inputsDinamicos[e]||{};this._inputsDinamicos[e][a]=this._inputsDinamicos[e][a]||{};this._inputsDinamicos[e][a][p]=n;c[e][a][p]=s;if(s!==""){this.handleInputChange(e,a,d,h,{getParameter:()=>s})}})}var x=this.getView().byId("scroll_container_"+e);if(x){x.setHorizontal(true);x.setVertical(false);x.setWidth("100%")}});e.setData(c);console.log("Modelo dynamicInputs actualizado tras regenerar:",e.getData())},_onPasteValues:function(e){e.preventDefault();var t=e.originalEvent.clipboardData;if(!t)return;var o=t.getData("text");console.log(" Datos pegados:",o);var a=o.split(/\t/);var s=e.target;console.log(" DOM del input donde se peg√≥:",s);var n=false;for(var r in this._inputsDinamicos){console.log(" Explorando _inputsDinamicos...");var i=this._inputsDinamicos[r];for(var l in i){for(var c in i[l]){var d=i[l][c];if(!d||typeof d.getDomRef!=="function")continue;var u=d.getDomRef();if(!u)continue;if(u.contains(s)){console.log(" Input encontrado:",{tableId:r,rowIndex:l,columnKey:c});var h=jQuery(s).closest("td");var f=jQuery(s).closest("tr");if(!h.length||!f.length)return;var p=f.find("td");var g=p.index(h);for(var x=0;x<a.length;x++){var y=g+x;var I=p[y];if(!I)continue;var b=jQuery(I).find("input")[0];if(b){b.value=a[x].trim();b.dispatchEvent(new Event("input",{bubbles:true}));b.dispatchEvent(new Event("change",{bubbles:true}))}}n=true;break}}if(n)break}if(n)break}if(!n){console.warn("‚ùå No se pudo identificar el input en _inputsDinamicos.")}},resetTableAccumulations:function(e){if(!this._yearlySums[e]){this._yearlySums[e]={}}if(!this._yearlySums[e][this.currentRow]){this._yearlySums[e][this.currentRow]={}}},handleInputChange:function(e,t,o,a,s){this._handleInputChangeCounter=(this._handleInputChangeCounter||0)+1;var n=parseFloat(s.getParameter("value"))||0;if(!this._tableValues)this._tableValues={};if(!this._tableValues[e])this._tableValues[e]={};if(!this._tableValues[e][t])this._tableValues[e][t]={};var r=this._tableValues[e][t][o]||0;if(n!==r){this._tableValues[e][t][o]=n;if(!this._editedRows)this._editedRows={};if(!this._editedRows[e])this._editedRows[e]=new Set;this._editedRows[e].add(t);this._tableChanged=true;if(!this._yearlySums)this._yearlySums={};if(!this._yearlySums[t])this._yearlySums[t]={};if(this._yearlySums[t][a]!==undefined){this._yearlySums[t][a]-=r}this._yearlySums[t][a]=(this._yearlySums[t][a]||0)+n;if(!this._yearlySums[e])this._yearlySums[e]={};if(!this._yearlySums[e][t])this._yearlySums[e][t]={};if(!this._yearlySums[e][t][a])this._yearlySums[e][t][a]=0;this._yearlySums[e][t][a]-=r;this._yearlySums[e][t][a]+=n;console.log("TOTAL YEAR JSON",JSON.stringify(this._yearlySums));this.updateTotalField(e,t,n);if(!this._insercionesPorAnoYTabla)this._insercionesPorAnoYTabla={};if(!this._insercionesPorAnoYTabla[a])this._insercionesPorAnoYTabla[a]={};if(!this._insercionesPorAnoYTabla[a][e])this._insercionesPorAnoYTabla[a][e]=0;this._insercionesPorAnoYTabla[a][e]++;console.log(`Reclutado hasta ahora en a√±o ${a} para tabla ${e}:`,this._insercionesPorAnoYTabla[a][e]);if(!this._insercionesPorTabla)this._insercionesPorTabla={};if(!this._insercionesPorTabla[e])this._insercionesPorTabla[e]=0;this._insercionesPorTabla[e]++;console.log("TOTAL YEAR JSON",JSON.stringify(this._insercionesPorTabla));this.calcularPorcentajeInserciones();this.CaseAno(e);var i=this.getView().getModel("dynamicInputs");var l=i.getData();if(!l[e]){l[e]={}}if(!l[e][t]){l[e][t]={}}var c=new Date(this.getView().byId("date_inico").getDateValue().getFullYear(),this.getView().byId("date_inico").getDateValue().getMonth()+o,1);var d=c.getFullYear();var u=c.toLocaleString("default",{month:"long"});var h=d+"-"+u;l[e][t][h]=n;i.setData(l);i.refresh();console.log("Modelo dynamicInputs actualizado: ",i.getData())}else{console.log("No hay cambio de valor, no actualizo nada.")}},calcularPorcentajeInserciones:function(){let e=0;for(let t in this._insercionesPorTabla){e+=this._insercionesPorTabla[t]}if(e===0){return}this._porcentajesPorTabla={};for(let t in this._insercionesPorTabla){let o=this._insercionesPorTabla[t]/e*100;this._porcentajesPorTabla[t]=o}if(this._insercionesPorAnoYTabla){for(let t in this._insercionesPorAnoYTabla){for(let o in this._insercionesPorAnoYTabla[t]){const a=this._insercionesPorAnoYTabla[t][o]||0;let s=a/e*100}}}},calcularDistribucionInput:function(){let e=[{id:"input0_1725625161348",nombre:"Input1",tipo:"input"},{id:"totalSubtotal",nombre:"Input2",tipo:"input"},{id:"input2_1724756105",nombre:"Input3",tipo:"input"},{id:"text33",nombre:"Text1",tipo:"text",tabla:"table_dimicFecha"},{id:"text32_1723542481599",nombre:"Text2",tipo:"text",tabla:"table_dimicFecha"},{id:"text32_172341599",nombre:"Text3",tipo:"text",tabla:"table_dimicFecha"},{id:"text560",nombre:"Text4",tipo:"text",tabla:"tablaConsuExter"},{id:"text56",nombre:"Text5",tipo:"text",tabla:"tablaConsuExter"},{id:"text50006",nombre:"Text6",tipo:"text",tabla:"tablaConsuExter"},{id:"text32_172354299",nombre:"Text7",tipo:"text",tabla:"tableServicioInterno"},{id:"text3888",nombre:"Text8",tipo:"text",tabla:"tablGastoViajeInterno"},{id:"text32_172354299",nombre:"text40",tipo:"text",tabla:"tablGastoViajeInterno"},{id:"text56000",nombre:"Text8",tipo:"text",tabla:"tablaRecExterno"},{id:"text5644",nombre:"text9",tipo:"text",tabla:"tablaRecExterno"},{id:"text500406",nombre:"text10",tipo:"text",tabla:"tablaRecExterno"},{id:"text90_1729173466313",nombre:"text11",tipo:"text",tabla:"tablaLicencia"},{id:"text75_1729177384465",nombre:"text12",tipo:"text",tabla:"tablaLicencia"},{id:"text78_1729173199360",nombre:"t ext13",tipo:"text",tabla:"tablaInfrestuctura"},{id:"text32_171145299",nombre:"text14",tipo:"text",tabla:"tablaInfrestuctura"}];let t={};let o={};e.forEach(e=>{let a=this.byId(e.id);if(!a){console.error(`‚ùå No se encontr√≥ el elemento con ID '${e.id}'`);return}let s=e.tipo==="input"?parseFloat(a.getValue())||0:parseFloat(a.getText())||0;if(s===0){return}for(let a in this._porcentajesPorTabla){if(e.tipo==="text"&&a!==e.tabla){continue}let n=this._porcentajesPorTabla[a];let r=e.tipo==="text"?s:s*n/100;if(!t[a]){t[a]={}}let i=Object.entries(this._insercionesPorAnoYTabla).filter(([e,t])=>t[a]).map(([e])=>e);i.forEach(n=>{let r=this._insercionesPorAnoYTabla[n][a];if(!this._insercionesPorTabla[a]||this._insercionesPorTabla[a]===0){return}if(!t[a][n]){t[a][n]=[]}if(!o[n]){o[n]={}}if(!o[n][a]){o[n][a]=0}if(e.tipo==="text"){let r=i.length;if(r>1){let i=100/r;let l=s*i/100;t[a][n].push({elemento:e.nombre,porcentaje:i.toFixed(2),valor:l.toFixed(2)});o[n][a]+=parseFloat(l.toFixed(2))}else{t[a][n].push({elemento:e.nombre,porcentaje:100,valor:s.toFixed(2)});o[n][a]+=parseFloat(s.toFixed(2))}}else{let o=r/this._insercionesPorTabla[a]*100;let i=s*o/100;t[a][n].push({elemento:e.nombre,porcentaje:o.toFixed(2),valor:i.toFixed(2)})}})}});return{valoresDistribuidos:t,acumuladoTextPorTablaYAnio:o}},updateTotalField:function(e,t,o,a,s){var n=0;var r=0;var i=0;var l=0;var c=0;let d=0;var u,h,f;var p=this.getTotalForYear(2025,t,e);var g=this.getTotalForYear(2026,t,e);var x=this.getTotalForYear(2027,t,e);var y=this.getTotalForYear(2028,t,e);var I=this.getTotalForYear(2029,t,e);var b=this.getTotalForYear(2030,t,e);if(e==="tablaConsuExter"){var m=this.byId("tablaConsuExter");if(!m){console.error(" 2. La tabla 'tablaConsuExter' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){n=o[4].getText();o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");r=p+g+x+y+I+b;var a=n*r;o[11].setText(r.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="table_dimicFecha"){var m=this.byId("table_dimicFecha");if(!m){console.error("3. La tabla 'table_dimicFecha' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){var a=o[4].getText();o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");i=p+g+x+y+I+b;var s=a*i;o[11].setText(i.toFixed(2));o[12].setText(s.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="tablaRecExterno"){var m=this.byId("tablaRecExterno");if(!m){console.error("4. La tabla 'tablaRecExterno' no fue encontrada.");return}this._editedRows[e].forEach(function(t){var o=m.getItems()[t];if(o){var a=o.getCells();if(a&&a.length>=13){var s=parseFloat(a[4].getValue().replace(",","."));if(isNaN(s)){s=0}a[5].setText(p.toFixed(2)+"‚Ç¨");a[6].setText(g.toFixed(2)+"‚Ç¨");a[7].setText(x.toFixed(2)+"‚Ç¨");a[8].setText(y.toFixed(2)+"‚Ç¨");a[9].setText(I.toFixed(2)+"‚Ç¨");a[10].setText(b.toFixed(2)+"‚Ç¨");var n=p+g+x+y+I+b;a[11].setText(n.toFixed(2)+"‚Ç¨");var r=s*n;a[12].setText(r.toFixed(2)+"‚Ç¨");a[4].attachLiveChange(function(t){var o=parseFloat(t.getSource().getValue().replace(",","."));if(!isNaN(o)){var s=o*n;a[12].setText(s.toFixed(2)+"‚Ç¨")}else{a[12].setText("0.00‚Ç¨")}this.onSumarColumna(e)}.bind(this))}}}.bind(this));this.onSumarColumna(e)}else if(e==="idOtroserConsu"){var m=this.byId("idOtroserConsu");if(!m){console.error("La tabla 'idOtroserConsu' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="idGastoViajeConsu"){var m=this.byId("idGastoViajeConsu");if(!m){console.error("La tabla 'idGastoViajeConsu' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="idServiExterno"){var m=this.byId("idServiExterno");if(!m){console.error("La tabla 'idServiExterno' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="idGastoRecuExter"){var m=this.byId("idGastoRecuExter");if(!m){console.error("La tabla 'idGastoRecuExter' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="tablaInfrestuctura"){var m=this.byId("tablaInfrestuctura");if(!m){console.error("La tabla 'tablaInfrestuctura' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[4].setText(p.toFixed(2)+"‚Ç¨");o[5].setText(g.toFixed(2)+"‚Ç¨");o[6].setText(x.toFixed(2)+"‚Ç¨");o[7].setText(y.toFixed(2)+"‚Ç¨");o[8].setText(I.toFixed(2)+"‚Ç¨");o[9].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[10].setText(a.toFixed(2)+"‚Ç¨");o[11].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="tablaLicencia"){var m=this.byId("tablaLicencia");if(!m){console.error("La tabla 'tablaLicencia' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=12){o[4].setText(p.toFixed(2)+"‚Ç¨");o[5].setText(g.toFixed(2)+"‚Ç¨");o[6].setText(x.toFixed(2)+"‚Ç¨");o[7].setText(y.toFixed(2)+"‚Ç¨");o[8].setText(I.toFixed(2)+"‚Ç¨");o[9].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[10].setText(a.toFixed(2)+"‚Ç¨");o[11].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="tableServicioInterno"){var m=this.byId("tableServicioInterno");if(!m){console.error("La tabla 'tableServicioInterno' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else if(e==="tablGastoViajeInterno"){var m=this.byId("tablGastoViajeInterno");if(!m){console.error("La tabla 'tablGastoViajeInterno' no fue encontrada.");return}this._editedRows[e].forEach(function(e){var t=m.getItems()[e];if(t){var o=t.getCells();if(o&&o.length>=11){o[5].setText(p.toFixed(2)+"‚Ç¨");o[6].setText(g.toFixed(2)+"‚Ç¨");o[7].setText(x.toFixed(2)+"‚Ç¨");o[8].setText(y.toFixed(2)+"‚Ç¨");o[9].setText(I.toFixed(2)+"‚Ç¨");o[10].setText(b.toFixed(2)+"‚Ç¨");var a=p+g+x+y+I+b;o[11].setText(a.toFixed(2)+"‚Ç¨");o[12].setText(a.toFixed(2)+"‚Ç¨")}}});this.onSumarColumna(e)}else{console.error("Tabla no reconocida: "+e)}if(this._editedRows&&this._editedRows[e]&&typeof this._editedRows[e].clear==="function"){this._editedRows[e].clear()}else{console.warn("No es un Set, se reinicia correctamente");this._editedRows[e]=new Set}},getTotalForYear:function(e,t,o){if(Number(t)!==Number(this.currentRow)||o!==this.currentTableId){this.resetTableAccumulations(o);this.currentRow=Number(t);this.currentTableId=o}if(!this._yearlySums[o]){console.warn(`‚ö†Ô∏è No hay datos para la tabla ${o}. Creando estructura.`);this._yearlySums[o]={}}if(!this._yearlySums[o][t]){console.warn(`‚ö†Ô∏è No hay datos para la fila ${t} en la tabla ${o}. Creando estructura.`);this._yearlySums[o][t]={}}if(this._yearlySums[o][t][e]===undefined){this._yearlySums[o][t][e]=0}return this._yearlySums[o][t][e]},onSumarColumna:function(e){var t=this.byId(e);var o=t.getItems();var a=0;var s=0;var n=0;var r=0;var i=0;o.forEach(function(e){var t=e.getCells();var o=t.length>11&&t[11].getText?t[11].getText():"0";var l=t.length>12&&t[12].getText?t[12].getText():"0";a+=parseFloat(o)||0;s+=parseFloat(l)||0;n+=parseFloat(o)||0;r+=parseFloat(o)||0;i+=parseFloat(o)||0});if(e==="table_dimicFecha"){this.byId("inputReInter").setValue(a.toFixed(2));this.byId("inputServi1").setValue(s.toFixed(2)+"‚Ç¨")}else if(e==="tableServicioInterno"){this.byId("inputOtrosServi1").setValue(n.toFixed(2)+"‚Ç¨")}else if(e==="tablGastoViajeInterno"){this.byId("inputGastoVia1").setValue(r.toFixed(2)+"‚Ç¨")}else if(e==="tablaLicencia"){this.byId("input0_1724758359").setValue(n.toFixed(2)+"‚Ç¨")}else if(e==="tablaRecExterno"){this.byId("inputRcurExtern").setValue(a.toFixed(2)+"‚Ç¨");this.byId("inputServi").setValue(s.toFixed(2)+"‚Ç¨")}else if(e==="idServiExterno"){this.byId("input10_1724757017406").setValue(a.toFixed(2)+"‚Ç¨")}else if(e==="idGastoRecuExter"){this.byId("input9_1724757015442").setValue(a.toFixed(2)+"‚Ç¨")}else if(e==="tablaConsuExter"){this.byId("inputServi2").setValue(s.toFixed(2));this.byId("inputConsuEx").setValue(a.toFixed(2))}else if(e==="idOtroserConsu"){this.byId("inputOtroSer2").setValue(n.toFixed(2)+"‚Ç¨")}else if(e==="idGastoViajeConsu"){this.byId("inptGastoVi2").setValue(n.toFixed(2)+"‚Ç¨")}else if(e==="tablaInfrestuctura"){this.byId("totalInfraestruc").setValue(a.toFixed(2)+"‚Ç¨")}this.onColumnTotales();return a},onColumnTotales:function(){var e=0;var t=0;var o=0;var a=0;var s=0;var n=parseFloat(this.byId("inputReInter").getValue())||0;var r=parseFloat(this.byId("inputConsuEx").getValue())||0;var i=parseFloat(this.byId("inputRcurExtern").getValue())||0;e=n+r+i;this.byId("inputTotalJor").setValue(e.toFixed(2));var l=parseFloat(this.byId("inputServi1").getValue())||0;var c=parseFloat(this.byId("inputOtrosServi1").getValue())||0;var d=parseFloat(this.byId("inputGastoVia1").getValue())||0;t=l+c+d;this.byId("totalRecuInter").setValue(t.toFixed(2));var u=parseFloat(this.byId("inputServi2").getValue())||0;var h=parseFloat(this.byId("inputOtroSer2").getValue())||0;var f=parseFloat(this.byId("inptGastoVi2").getValue())||0;o=u+h+f;this.byId("totalConsuExternot").setValue(o.toFixed(2));var p=parseFloat(this.byId("inputServi").getValue())||0;var g=parseFloat(this.byId("input10_1724757017406").getValue())||0;var x=parseFloat(this.byId("input9_1724757015442").getValue())||0;a=p+g+x;this.byId("totaRecurExterno").setValue(a.toFixed(2));var y=parseFloat(this.byId("totalInfraestruc").getValue())||0;var I=parseFloat(this.byId("input0_1724758359").getValue())||0;s=t+o+a+y+I;var b=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(s);this.byId("totalSubtotal").setValue(b);var m=parseFloat(this.byId("input2_172475612").getValue())||0;var v=s*(m/100);this.byId("input2_1724756105").setValue(v.toFixed(2));var T=parseFloat(this.byId("input2_17221205").getValue())/100||0;var C=s+v;var F=C/(1-T)-C;this.byId("input2_1756121205").setValue(F.toFixed(2));var _=C+F;var E=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(_);var w=E+" ‚Ç¨";this.byId("input0_1725625161348").setValue(w);this.CaseAno();if(this._insercionesPorAnoYTabla){this.CaseAno()}var S=this.byId("inputCambioEu").getValue().trim();var V=this.byId("input0_1725625132423424361348");if(S!==""){var D=parseFloat(parseFloat(S).toFixed(4));var P=_*D;var E=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(P);V.setVisible(true);V.setValue(E+" $")}else{V.setVisible(false);V.setValue("")}},findTotalColumnIndex:function(e){var t=e.getColumns();var o=t.length-1;for(var a=0;a<t.length;a++){var s=t[a].getHeader();if(s&&(s.getText()==="Total ‚Ç¨"||s.getText()==="")){return a}}return o+1},getMonthsDifference:function(e,t){var o=(t.getFullYear()-e.getFullYear())*12;o-=e.getMonth();o+=t.getMonth();return o<0?0:o},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("appNoparame")},onSelectOpx:function(e){var t=this.byId("slct_inic").getSelectedItem();if(!t){console.warn("No se ha seleccionado ning√∫n item en slct_inic");return}var o=t.getText();var a=this.getView().byId("table0");if(o==="Opex Servicios"||o==="Proyecto/Servicio de Inversi√≥n"){this.byId("input2_172475612").setValue("0.00");this.byId("text67_1728582763477").setText("Opex Servicios  - El Margen debe ser establecido al 0%")}else{this.byId("input2_172475612").setValue("0.00");this.byId("text67_1728582763477").setText("0.00")}if(o==="Proyecto/Servicio a Cliente Externo"){a.setVisible(true);this.byId("idCheckMensual").setVisible(true);this.byId("idComentarioTipo").setVisible(true);this.byId("TextoCon").setVisible(true);this.byId("input2_17221205").setValue("20.00");this.byId("text67_1728582763477").setText("Margen por defecto 20%, si es inferior al 14,29% la propuesta debe pasar por comit√©")}else if(o==="Proyecto/Servicio Interno PdV"){this.byId("idComenpVd").setEditable(true);this.byId("input2_17221205").setValue("10.00");this.byId("text67_1728582763477").setText("Margen por defecto 10%, si el Margen es inferior al 5% la propuesta debe pasar por comit√©")}else if(o==="Proyecto/Servicio de Inversi√≥n"){this.byId("input2_17221205").setValue("0.00");this.byId("text67_1728582763477").setText("Proyecto/Servicio de Inversi√≥n - El Margen debe ser establecido al 0%")}else if(o==="Opex Servicios"){this.byId("input2_17221205").setValue("0.00");this.byId("text67_1728582763477").setText("Opex Servicios - El Margen debe ser establecido al 0%")}else{a.setVisible(false);this.byId("idComenpVd").setEditable(false);this.byId("idComentarioTipo").setVisible(false);this.byId("TextoCon").setVisible(false);this.byId("idCheckMensual").setVisible(false);this.byId("input2_17221205").setValue("")}},onCheckBoxSelectMulti:function(e){var t=e.getSource();var o=t.getSelected();var a=this.byId("table_clienteFac");if(a){a.setVisible(o)}},onInputChange:function(){var e=this.getView();var t=this.byId("input0").getValue();var o=this.byId("input1").getValue();var a=this.byId("id_Cfactur").getValue();var s=this.byId("int_clienteFun").getValue();var n=this.byId("slct_area");var r="";var i="";if(n&&n.getSelectedItem()){r=n.getSelectedItem().getText();i=n.getSelectedItem().getKey()}var l=this.byId("slct_Jefe");var c="";if(l&&l.getSelectedItem()){c=l.getSelectedItem().getText()}var d=this.byId("slct_client");var u="";if(d&&d.getSelectedItem()){u=d.getSelectedItem().getText()}var h=this.byId("date_inico");var f=h?h.getDateValue():null;var p="";if(f){p=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(f)}var g=this.byId("slct_inic");var x="";if(g&&g.getSelectedItem()){x=g.getSelectedItem().getText()}var y=this.byId("idNatu");var I="";if(y&&y.getSelectedItem()){I=y.getSelectedItem().getText()}var b=this.byId("date_fin");var m=b?b.getDateValue():null;var v="";if(m){v=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(m)}this.byId("txt_codig").setText(t);this.byId("txt_nomPro").setText(o);this.byId("txt_area").setText(r);this.byId("txt_NomJefe").setText(c);this.byId("txt_funcio").setText(s);this.byId("txt_feIni").setText(p);this.byId("txt_feFin").setText(v);this.byId("txt_ini").setText(x);this.byId("text72_1731325324246").setText(x);this.byId("text73_1731325328049").setText(I);this.byId("txt_client").setText(s);this.byId("txt_cFactura").setText(a);this.byId("txt_Codi2").setText(t);this.byId("txt_Nombre2").setText(o);this.byId("txt_area2").setText(r);this.byId("txt_Fe_ini2").setText(p);this.byId("txt_Fe_fin2").setText(v);this.byId("textClitFu3").setText(s);this.byId("textCliFac3").setText(a);this.byId("textCodigo3").setText(t);this.byId("textNatural3").setText(I);this.byId("txtNombre3").setText(o);this.byId("txtAre3").setText(r);this.byId("txtFechInici3").setText(p);this.byId("txtFechFin3").setText(v)},onSelectCheckbox:function(e){try{var t=this.byId("table2");if(!t){console.error("Tabla no encontrada.");return}var o=t.getItems();var a=e.getSource().getSelected();if(a===undefined){console.error("Error al obtener el estado del checkbox.");return}var s=e.getSource().getParent().getParent().indexOfColumn(e.getSource().getParent());var n=s===0?"box_prove":"box_condi";var r=this.byId(n);if(!r){console.error("El otro checkbox no se encontr√≥.");return}if(n==="box_condi"){this.byId("idTextComProve").setEditable(true)}else{this.byId("idTextComProve").setEditable(false)}r.setEnabled(!a);o.forEach(function(e){var t=e.getCells();t.forEach(function(e,t){if(e.setEditable){e.setEditable(t===s?a:!a)}})})}catch(e){console.error("Error en la funci√≥n onSelectCheckbox:",e)}}});function u(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0,o=e==="x"?t:t&3|8;return o.toString(16)})}},function e(t){return+(Math.round(t+"e+2")+"e-2")});
//# sourceMappingURL=View1.controller.js.map