sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/format/DateFormat","sap/viz/ui5/controls/VizFrame","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/json/JSONModel"],function(e,t,a,o,s,n,r,i,c){"use strict";return e.extend("project1.controller.View1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({milestones:[{fase:"Kick off",fechaInicio:null,fechaFin:null},{fase:"Diseño",fechaInicio:null,fechaFin:null},{fase:"Construcción",fechaInicio:null,fechaFin:null},{fase:"Pruebas TQ",fechaInicio:null,fechaFin:null},{fase:"Go live",fechaInicio:null,fechaFin:null},{fase:"Paso AM",fechaInicio:null,fechaFin:null},{fase:"Server post/prod",fechaInicio:null,fechaFin:null}],chartData:[]});this.getView().setModel(e,"planning");var t=this.byId("idVizFrame");t.setVizProperties({title:{text:"Planificacion"}});var a=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:"2024-09-01",fechaFinPruebasTQ:"2024-09-30"}]});this.getView().setModel(a,"fechasModel");var o=this.byId("idVizFrame2");o.setVizProperties({title:{text:"Plan"}});console.log(e);this.updateVizFrame1();this.updateVizFrame3();var s=sap.ui.core.UIComponent.getRouterFor(this);s.getRoute("view").attachPatternMatched(this._onObjectMatched,this);this.updateVizFrame2()},_onObjectMatched:async function(e){var t=e.getParameter("arguments").sProjectID;this._sProjectID=t;var a=`/odata/v4/datos-cdo/DatosProyect(${t})`;try{const e=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const o=await e.json();console.log("Datos del proyecto:",o);if(o){this.byId("input0").setValue(o.codigoProyect||"");this.byId("input1").setValue(o.nameProyect||"");this.byId("int_clienteFun").setValue(o.clienteFuncional||"");this.byId("id_Cfactur").setValue(o.clienteFacturacion||"");this.byId("idObje").setValue(o.objetivoAlcance||"");this.byId("idAsunyRestri").setValue(o.AsuncionesyRestricciones||"");this.byId("box_multiJuridica").setSelected(!!o.multijuridica);this.byId("box_pluriAnual").setSelected(!!o.pluriAnual);this.byId("slct_area").setSelectedKey(o.Area_ID||"");this.byId("slct_Jefe").setSelectedKey(o.jefeProyectID_ID||"");this.byId("slct_verti").setSelectedKey(o.Vertical_ID||"");this.byId("slct_inic").setSelectedKey(o.Iniciativa_ID||"");this.byId("idNatu").setSelectedKey(o.Naturaleza_ID||"");this.byId("date_inico").setDateValue(o.fechaInicio?new Date(o.fechaInicio):null);this.byId("date_fin").setDateValue(o.fechaInicio?new Date(o.fechaFin):null);this.byId("input0").setValue(o.codigoProyect);this.byId("input1").setValue(o.nameProyect);this.byId("box_pluriAnual").setSelected(o.pluriAnual);this.byId("id_Cfactur").setValue(o.clienteFacturacion);this.byId("box_multiJuridica").setSelected(o.multijuridica);await this.fetchMilestones(t);await this.leerProveedor(t);await this.leerFacturacion(t);await this.leerClientFactura(t);const e=this.byId("564433");e.setText("Guardar");sap.m.MessageToast.show("Datos cargados correctamente")}}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}},fetchMilestones:async function(e){var t=`/odata/v4/datos-cdo/planificacion?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const o=await e.json();console.log("Datos de planificación:",o);if(o&&o.value){o.value.sort((e,t)=>new Date(e.fecha_inicio)-new Date(t.fecha_inicio));var a=this.getView().getModel("planning");o.value.forEach((e,t)=>{var o="/milestones/"+t;var s=e.fecha_inicio?new Date(e.fecha_inicio).toISOString().split("T")[0]:null;var n=e.fecha_fin?new Date(e.fecha_fin).toISOString().split("T")[0]:null;a.setProperty(o+"/fechaInicio",s);a.setProperty(o+"/fechaFin",n)})}this.updateVizFrame1(o)}catch(e){console.error("Error al obtener los datos de planificación:",e);sap.m.MessageToast.show("Error al cargar los datos de planificación")}},leerProveedor:async function(e){var t=`/odata/v4/datos-cdo/ProveedoresC?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const n=await e.json();console.log("Datos de proveedor:",n);var a=this.byId("table2");var o=a.getItems();if(n.value&&n.value.length>0){var s=n.value[0];o.forEach(function(e){var t=e.getCells();if(t.length>1){t[0].setValue(s.valueCondi||"");t[1].setValue(s.valueProvee||"")}this.byId("box_condi").setSelected(s.checkCondi||false);this.byId("box_prove").setSelected(s.checkProveedor||false)}.bind(this))}else{console.log("No hay datos de proveedores disponibles.")}}catch(e){console.error("Error al obtener los datos de proveedor:",e);sap.m.MessageToast.show("Error al cargar los datos de proveedor")}},leerFacturacion:async function(e){var t=`/odata/v4/datos-cdo/Facturacion?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const n=await e.json();console.log("Datos de proveedor:",n);var a=this.byId("table0");var o=a.getItems();if(n.value&&n.value.length>0){var s=n.value[0];o.forEach(function(e){var t=e.getCells();if(t.length>1){t[0].setValue(s.fechaEstimida||"");t[1].setValue(s.descripcionHito||"");t[2].setValue(s.facturacion||"")}}.bind(this))}else{console.log("No hay datos de proveedores disponibles.")}}catch(e){console.error("Error al obtener los datos de Facturacion:",e);sap.m.MessageToast.show("Error al cargar los datos de Facturacion")}},leerClientFactura:async function(e){var t=`/odata/v4/datos-cdo/ClientFactura?$filter=datosProyect_ID eq ${e}`;try{const e=await fetch(t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const d=await e.json();console.log("Datos de Cliente factura:",d);var a=this.byId("table_clienteFac");var o=a.getItems();if(d.value&&d.value.length>0){for(let e=0;e<Math.min(o.length,d.value.length);e++){var s=o[e];var n=s.getCells();var r=d.value[e];if(n[0].getMetadata().getName()==="sap.m.Input"){n[0].setValue(r.juridica||"")}else if(n[0].getMetadata().getName()==="sap.m.Text"){n[0].setText(r.juridica||"")}if(n[1].getMetadata().getName()==="sap.m.Input"){n[1].setValue(r.oferta||"")}else if(n[1].getMetadata().getName()==="sap.m.Text"){n[1].setText(r.oferta||"")}var i=this.byId("text73_172746565340567");if(i.getMetadata().getName()==="sap.m.Input"){i.setValue(r.oferta||"")}else if(i.getMetadata().getName()==="sap.m.Text"){i.setText(r.oferta||"")}}}else{console.log("No hay datos de cliente factura disponibles.")}var c=this.byId("box_multiJuridica");var l=c.getSelected();this.onCheckBoxSelectMulti({getSource:()=>c,getSelected:()=>l})}catch(e){console.error("Error al obtener los datos de cliente Facturacion:",e);sap.m.MessageToast.show("Error al cargar los datos de cliente Facturacion")}},leerRecursos:async function(e){},updateVizFrame1:function(e){var t=this.getView();var a=t.getModel("planning");if(!a){console.error("El modelo 'planning' no está definido.");return}if(!e||!e.value){console.error("Los datos del modelo son inválidos o no contienen 'value'.",e);return}var o=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var s=e.value.map(function(e){var t=e.fecha_inicio?new Date(e.fecha_inicio):null;var a=e.fecha_fin?new Date(e.fecha_fin):null;if(t&&!isNaN(t.getTime())&&a&&!isNaN(a.getTime())){var s=(a-t)/(1e3*60*60*24);return{fase:e.hito,fechaInicio:o.format(t),fechaFin:o.format(a),duracion:s,label:`Inicio: ${o.format(t)}, Fin: ${o.format(a)}, Duración: ${s} días`}}else{console.warn("Fechas no válidas para el hito:",e);return null}}).filter(Boolean);a.setProperty("/chartData",s);console.log(s);this._aChartData=s;var n={};s.forEach(function(e){if(e.fase==="Kick off"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Server post/prod"){n.fechaFinPruebasTQ=e.fechaFin}});var r=new sap.ui.model.json.JSONModel({fechas:[{fase:"Plan",fechaInicioConstruccion:n.fechaInicioConstruccion||"No definida",fechaFinPruebasTQ:n.fechaFinPruebasTQ||"No definida"}]});t.setModel(r,"fechasModel");this.updateVizFrame2(r)},updateVizFrame2:function(e){var t=this.getView();var a=t.getModel("planning");if(!(e instanceof sap.ui.model.json.JSONModel)||!e.getData){console.error("El modelo 'fechasModel' no está definido.");return}var o=e.getData().fechas;var s=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var n=o.map(function(e){var t=e.fechaInicioConstruccion&&e.fechaInicioConstruccion!=="No definida"?new Date(e.fechaInicioConstruccion):null;var a=e.fechaFinPruebasTQ&&e.fechaFinPruebasTQ!=="No definida"?new Date(e.fechaFinPruebasTQ):null;if(t&&!isNaN(t.getTime())&&a&&!isNaN(a.getTime())){var o=(a-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:s.format(t),fechaFin:s.format(a),duracion:o,label:`Inicio: ${s.format(t)}, Fin: ${s.format(a)}, Duración: ${o} días`}}else{console.warn("Fechas no válidas para la fase:",e);return null}}).filter(Boolean);a.setProperty("/chartModel",n);console.log("Datos del gráfico:",n)},updateVizFrame3:function(){var e=this.getView();var t=e.getModel("planning");var a=t.getData();var o=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});var s=a.milestones.map(function(e){var t=e.fechaInicio?new Date(e.fechaInicio):null;var a=e.fechaFin?new Date(e.fechaFin):null;if(t&&a&&!isNaN(t)&&!isNaN(a)){var s=(a-t)/(1e3*60*60*24);return{fase:e.fase,fechaInicio:o.format(t),fechaFin:o.format(a),duracion:s,label:`Inicio: ${o.format(t)}, Fin: ${o.format(a)}, Duración: ${s} días`}}else{return null}}).filter(Boolean);t.setProperty("/chartData",s);console.log(s);this._aChartData=s;var n={};s.forEach(function(e){if(e.fase==="Kick off"){n.fechaInicioConstruccion=e.fechaInicio}if(e.fase==="Server post/prod"){n.fechaFinPruebasTQ=e.fechaFin}});var r=new sap.ui.model.json.JSONModel({fechas:[{fase:"Fechas Importantes",fechaInicioConstruccion:n.fechaInicioConstruccion,fechaFinPruebasTQ:n.fechaFinPruebasTQ}]});e.setModel(r,"fechasModel");this.updateVizFrame2(r)},onFechaChange:function(){this.updateVizFrame1();this.updateVizFrame3()},onPerfilChangeTabla1:function(e){this.updateRowData(e,"table_dimicFecha")},updateRowData:function(e,t){const a=e.getSource();var o=this.byId(t);var s=a.getParent();var n=o.indexOfItem(s);if(n===-1){console.error("Índice de la fila no encontrado. Verifica la estructura de la tabla.");return}var r=o.getItems();var i=r[n].getCells();if(!i||i.length===0){console.error("Datos de la fila no encontrados.");return}var c=a.getSelectedItem().getText();var l={Director:{PMJ:1370.88,2024:41,2025:15,2026:0,2027:0,2028:0,2029:0},"CG4.C":{PMJ:182.72,2024:5,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.A":{PMJ:331.24,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0},"CG4.B":{PMJ:225.11,2024:51.93,2025:0,2026:0,2027:0,2028:0,2029:0}};var d=l[c];if(d){i[4].setText(d.PMJ);i[5].setText(d["2024"]);i[6].setText(d["2025"]);i[7].setText(d["2026"]);i[8].setText(d["2027"]);i[9].setText(d["2028"]);i[10].setText(d["2029"]);var f=d["2024"]+d["2025"];i[11].setText(f);var u=d.PMJ+f;i[12].setText(u);var h=["junio","julio","agosto"];var g=o.getColumns();for(var p=9;p<i.length;p++){var m=g[p].getHeader().getText().toLowerCase();if(h.some(e=>m.includes(e))){i[p].setText("4.00")}}}else{console.error(`No hay configuración definida para el valor seleccionado: ${c}`)}},onSave:async function(e){let t=0;const a=this._sProjectID;const o=this._aChartData;const s=parseInt(this.byId("input0").getValue(),10);const n=this.byId("input1").getValue();const r=this.byId("box_pluriAnual").getSelected();const i=this.byId("id_Cfactur").getValue();const c=this.byId("box_multiJuridica").getSelected();const l=this.byId("int_clienteFun").getValue();const d=this.byId("idObje").getValue();const f=this.byId("idAsunyRestri").getValue();const u=this.byId("idNatu").getSelectedKey();const h=this.byId("slct_area").getSelectedKey();const g=this.byId("slct_Jefe").getSelectedKey();const p=this.byId("slct_inic").getSelectedKey();const m=this.byId("selc_Segui").getSelectedKey();const v=this.byId("selc_ejcu").getSelectedKey();const I=this.byId("slct_verti").getSelectedKey();const y=this.byId("selct_Amrecp").getSelectedKey();const b=(e,a)=>{if(!a||typeof a==="string"&&a.trim()===""){e.setValueState("Error");e.setValueStateText("Este campo es obligatorio");t++}else{e.setValueState("None")}};b(this.byId("input0"),s);b(this.byId("input1"),n);b(this.byId("id_Cfactur"),i);b(this.byId("int_clienteFun"),l);b(this.byId("idNatu"),u);if(t>0){const e=this.byId("idIniu");e.setCount(t);return}const T={codigoProyect:s,nameProyect:n,pluriAnual:r,clienteFacturacion:i,multijuridica:c,Naturaleza_ID:u,Area_ID:h,Iniciativa_ID:p,jefeProyectID_ID:g,objetivoAlcance:d,AsuncionesyRestricciones:f,Vertical_ID:I};try{let e;if(a){e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${a})`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)});if(e.ok){sap.m.MessageToast.show("Actualización realizada con éxito");this.getOwnerComponent().getRouter().navTo("appNoparame")}}else{e=await fetch("/odata/v4/datos-cdo/DatosProyect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)});if(e.ok){const t=await e.json();const a=t.ID;console.log("Guardado con éxito. ID:",a);await this.inserChart(a);await this.insertarProveedor(a);await this.insertFacturacion(a);await this.insertClientFactura(a);await this.insertRecursosInternos(a);await this.insertCosumoExterno(a);const o=this.getOwnerComponent().getRouter();o.navTo("app",{newId:a})}else{const t=await e.text();console.log("Error al guardar el proyecto:",t);sap.m.MessageToast.show("Error al guardar el proyecto: "+t)}}}catch(e){console.log("Error en la llamada al servicio:",e);sap.m.MessageToast.show("Error en la llamada al servicio: "+e.message)}},inserChart:async function(e){const t=this._aChartData;const a=t.map(t=>({hito:t.fase,fecha_inicio:t.fechaInicio,fecha_fin:t.fechaFin,duracion:this.formatDuration(t.duracion),datosProyect_ID:e}));for(const e of a){const t=await fetch("/odata/v4/datos-cdo/planificacion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const e=await t.json();console.log("Planificación guardada con éxito:",e)}else{const e=await t.text();console.log("Error al guardar la planificación:",e);sap.m.MessageToast.show("Error al guardar la planificación: "+e)}}},insertFacturacion:async function(e){var t=this.byId("table0");var a=t.getItems();var o=[];a.forEach(function(t){var a=t.getCells();var s=a[0]&&a[0].getValue?a[0].getValue():"";var n=a[1]&&a[1].getValue?a[1].getValue():"";var r=a[2]&&a[2].getValue?parseInt(a[2].getValue(),10):0;if(s){var i=s.split("/");if(i.length===3){var c=new Date(i[2],i[1]-1,i[0]);if(!isNaN(c.getTime())){var l=c.toISOString().split("T")[0];o.push({fechaEstimida:l,descripcionHito:n,facturacion:r,total:0,datosProyect_ID:e})}else{console.error("Fecha inválida:",s)}}else{console.error("Formato de fecha incorrecto:",s)}}});for(let t of o){t.datosProyect_ID=e;const a=await fetch("/odata/v4/datos-cdo/Facturacion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(a.ok){const e=await a.json();console.log("Facturacion guardada con éxito:",e)}else{const e=await a.text();console.log("Error al guardar la Facturacion:",e);sap.m.MessageToast.show("Error al guardar la Facturacion: "+e)}}},insertarProveedor:async function(e){var t=this.byId("table2");var a=t.getItems();var o=[];a.forEach(function(t){var a=t.getCells();var s=a[0].getValue();var n=a[1].getValue();var r=this.byId("box_condi").getSelected();var i=this.byId("box_prove").getSelected();o.push({checkCondi:r,checkProveedor:i,valueCondi:s,valueProvee:n,datosProyect_ID:e})}.bind(this));for(let t of o){t.datosProyect_ID=e;await fetch("/odata/v4/datos-cdo/ProveedoresC",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}},insertRecursosInternos:async function(e){const t=this.byId("table_dimicFecha");const a=t.getItems();for(let t=0;t<a.length;t++){const o=a[t];const s=o.getCells()[0].getSelectedKey();const n=o.getCells()[1].getSelectedKey();const r=o.getCells()[2].getSelectedKey();const i=o.getCells()[3].getValue();const c=this.convertToInt(o.getCells()[4].getText());const l=this.convertToInt(o.getCells()[5].getText());const d=this.convertToInt(o.getCells()[6].getText());if(!s||!n||!r||!i||isNaN(c)||isNaN(l)||isNaN(d)){sap.m.MessageToast.show("Por favor, rellena todos los campos en la fila "+(t+1)+" correctamente.");return}const f={Vertical_ID:s,ConceptoOferta:i,PMJ:c,total:l,totalE:d,tipoServicio_ID:n,PerfilServicio_ID:r,datosProyect_ID:e};try{const e=await fetch("/odata/v4/datos-cdo/RecursosInternos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(e.ok){const a=await e.json();const o=a.ID;await this.insertOtrosGastos(o);await this.insertOtrosRecursos(o);console.log("Fila "+(t+1)+" guardada con éxito: RECUROSOS INTERNOS",a)}else{const a=await e.text();console.error("Error al guardar la fila "+(t+1)+":",a);sap.m.MessageToast.show("Error al guardar la fila "+(t+1)+": "+a)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(t+1)+":",e);sap.m.MessageToast.show("Error en la llamada al servicio para la fila "+(t+1)+": "+e.message)}}},insertOtrosGastos:async function(e){const t=this.byId("table0_1727879576857");const a=t.getItems();for(let t=0;t<a.length;t++){const o=a[t];const s=o.getCells()[0].getSelectedKey();const n=o.getCells()[1].getSelectedKey();const r=o.getCells()[3].getValue();const i=this.convertToInt(o.getCells()[4].getText());const c=this.convertToInt(o.getCells()[5].getText());const l=this.convertToInt(o.getCells()[6].getText());if(!s||!n||!r||isNaN(i)||isNaN(c)||isNaN(l)){sap.m.MessageToast.show("Por favor, rellena todos los campos en la fila "+(t+1)+" correctamente.");return}const d={Vertical_ID:s,ConceptoOferta:r,PMJ:i,total:c,totalE:l,tipoServicio_ID:n,RecursosInternos_ID:e};try{const e=await fetch("/odata/v4/datos-cdo/otrosGastoRecu",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(e.ok){const a=await e.json();console.log("Fila "+(t+1)+" guardada con éxito: INSERT OTROS GASTOS ",a)}else{const a=await e.text();console.error("Error al guardar la fila "+(t+1)+":",a);sap.m.MessageToast.show("Error al guardar la fila "+(t+1)+": "+a)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(t+1)+":",e);sap.m.MessageToast.show("Error en la llamada al servicio para la fila "+(t+1)+": "+e.message)}}},insertOtrosRecursos:async function(e){const t=this.byId("table0_1727879940116");const a=t.getItems();for(let t=0;t<a.length;t++){const o=a[t];const s=o.getCells()[0].getSelectedKey();const n=o.getCells()[1].getSelectedKey();const r=o.getCells()[3].getValue();const i=this.convertToInt(o.getCells()[4].getText());const c=this.convertToInt(o.getCells()[5].getText());const l=this.convertToInt(o.getCells()[6].getText());if(!s||!n||!r||isNaN(i)||isNaN(c)||isNaN(l)){sap.m.MessageToast.show("Por favor, rellena todos los campos en la fila "+(t+1)+" correctamente.");return}const d={Vertical_ID:s,ConceptoOferta:r,PMJ:i,total:c,totalE:l,tipoServicio_ID:n,RecursosInternos_ID:e};try{const e=await fetch("/odata/v4/datos-cdo/otrosRecursos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(e.ok){const a=await e.json();console.log("Fila "+(t+1)+" guardada con éxito: OTROS RECURSOS ",a)}else{const a=await e.text();console.error("Error al guardar la fila "+(t+1)+":",a);sap.m.MessageToast.show("Error al guardar la fila "+(t+1)+": "+a)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(t+1)+":",e);sap.m.MessageToast.show("Error en la llamada al servicio para la fila "+(t+1)+": "+e.message)}}},insertCosumoExterno:async function(e){const t=this.byId("tablaConsuExter");const a=t.getItems();for(let t=0;t<a.length;t++){const o=a[t];const s=o.getCells()[0].getSelectedKey();const n=o.getCells()[1].getSelectedKey();const r=o.getCells()[2].getSelectedKey();const i=o.getCells()[3].getValue();const c=this.convertToInt(o.getCells()[4].getText());const l=this.convertToInt(o.getCells()[5].getText());const d=this.convertToInt(o.getCells()[6].getText());if(!s||!n||!r||!i||isNaN(c)||isNaN(l)||isNaN(d)){sap.m.MessageToast.show("Por favor, rellena todos los campos en la fila "+(t+1)+" correctamente.");return}const f={Vertical_ID:s,ConceptoOferta:i,PMJ:c,total:l,totalC:d,tipoServicio_ID:n,PerfilServicio_ID:r,datosProyect_ID:e};try{const e=await fetch("/odata/v4/datos-cdo/ConsumoExternos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(e.ok){const a=await e.json();const o=a.ID;console.log("Fila "+(t+1)+" guardada con éxito:CONSUMO EXTERNO",a)}else{const a=await e.text();console.error("Error al guardar la fila "+(t+1)+":",a);sap.m.MessageToast.show("Error al guardar la fila "+(t+1)+": "+a)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(t+1)+":",e);sap.m.MessageToast.show("Error en la llamada al servicio para la fila "+(t+1)+": "+e.message)}}},insertServiConsu:async function(e){const t=this.byId("idOtroserConsu");const a=t.getItems();for(let t=0;t<a.length;t++){const o=a[t];const s=o.getCells()[0].getSelectedKey();const n=o.getCells()[1].getSelectedKey();const r=o.getCells()[3].getValue();const i=this.convertToInt(o.getCells()[4].getText());const c=this.convertToInt(o.getCells()[5].getText());const l=this.convertToInt(o.getCells()[6].getText());if(!s||!n||!r||isNaN(i)||isNaN(c)||isNaN(l)){sap.m.MessageToast.show("Por favor, rellena todos los campos en la fila "+(t+1)+" correctamente.");return}const d={Vertical_ID:s,ConceptoOferta:r,PMJ:i,total:c,totalE:l,tipoServicio_ID:n,RecursosInternos_ID:e};try{const e=await fetch("/odata/v4/datos-cdo/otrosServiciosConsu",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(e.ok){const a=await e.json();console.log("Fila "+(t+1)+" guardada con éxito: INSERT OTROS GASTOS ",a)}else{const a=await e.text();console.error("Error al guardar la fila "+(t+1)+":",a);sap.m.MessageToast.show("Error al guardar la fila "+(t+1)+": "+a)}}catch(e){console.error("Error en la llamada al servicio para la fila "+(t+1)+":",e);sap.m.MessageToast.show("Error en la llamada al servicio para la fila "+(t+1)+": "+e.message)}}},insertGastoConsu:async function(e){},convertToInt:function(e){const t=parseInt(e,10);return isNaN(t)?null:t},insertClientFactura:async function(e){var t=this.byId("table_clienteFac");var a=t.getItems();var o=[];var s=0;a.forEach(function(t,s){if(s===a.length-1){return}var n=t.getCells();var r="";var i="";if(n[0]&&n[0].getMetadata().getName()==="sap.m.Input"){r=n[0].getValue()}else if(n[0]&&n[0].getMetadata().getName()==="sap.m.Text"){r=n[0].getText()}if(n[1]&&n[1].getMetadata().getName()==="sap.m.Input"){i=n[1].getValue()}else if(n[1]&&n[1].getMetadata().getName()==="sap.m.Text"){i=n[1].getText()}var c=this.byId("text73_172746565340567").getText();if(r!==""||i!==""){o.push({juridica:r,oferta:i,total:c,datosProyect_ID:e})}}.bind(this));console.log("Total de la columna oferta: ",s);for(let e of o){const t=await fetch("/odata/v4/datos-cdo/ClientFactura",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const e=await t.json()}else{const e=await t.text();console.log("Error al guardar la Facturacion:",e);sap.m.MessageToast.show("Error al guardar la Facturacion: "+e)}}sap.m.MessageToast.show("El total de la columna oferta es: "+s)},metodoSumar:function(){var e=this.byId("table_clienteFac");var t=e.getItems();var a=0;t.forEach(function(e){var t=e.getCells();var o="";var s=t[1];if(s.getMetadata().getName()==="sap.m.Input"){o=s.getValue()}else if(s.getMetadata().getName()==="sap.m.Text"){o=s.getText()}var n=parseFloat(o);if(!isNaN(n)){a+=n}});this.byId("text73_172746565340567").setText(a.toFixed(2));console.log("Total de la columna oferta:",a)},formatDuration:function(e){const t=Math.floor(e);const a=Math.floor((e-t)*60);const o=0;return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`},onClearFields:function(){var e=this.getView();function t(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}if(e.getAggregation){const a=e.getMetadata().getAllAggregations();for(let o in a){const a=e.getAggregation(o);if(Array.isArray(a)){a.forEach(t)}else if(a instanceof sap.ui.core.Control){t(a)}}}}e.findAggregatedObjects(false,t)},onSelectIniMethod:function(e){this.onInputChange(e);this.onSelectOpx(e)},onselectmethodsetinfo:function(e){this.onInputChange(e);this.fechasDinamicas(e)},onAddRowPress:function(e){console.log(e);var t=this.byId(e);if(t){var a=new sap.m.ColumnListItem({cells:[new sap.m.Select({selectedKey:"{Vertical>valueVertical}",forceSelection:false,items:{path:"/Vertical",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreVertical}"})}}),new sap.m.Select({selectedKey:"{TipoServicio>valueTipoServ}",forceSelection:false,items:{path:"/TipoServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombreTipoServ}"})}}),new sap.m.Select({selectedKey:"{PerfilServicio>valuePerfil}",forceSelection:false,items:{path:"/PerfilServicio",template:new sap.ui.core.Item({key:"{ID}",text:"{NombrePerfil}"})}}),new sap.m.Input({value:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""}),new sap.m.Text({text:""})]});t.addItem(a)}else{console.error("No se encontró la tabla con ID: "+e)}},onDateChange:function(){this.updateVizFrame()},fechasDinamicas:function(e){var t=this.getView().byId("date_inico");var a=this.getView().byId("date_fin");if(!t||!a){console.error("Error: No se pudieron obtener los DatePickers.");return}var o=t.getDateValue();var s=a.getDateValue();if(!o||!s){console.log("Esperando a que se seleccionen ambas fechas.");return}var n=this.getMonthsDifference(o,s);var r=["tablaConsuExter","table_dimicFecha","tablaRecExterno"];r.forEach(function(e){var t=this.getView().byId(e);if(!t){console.error("Error: No se pudo obtener la tabla con ID "+e);return}var a=this.findTotalColumnIndex(t);if(a===-1){console.error("Error: No se encontró la columna 'Total1' en la tabla "+e);return}var r=t.getColumns().length;for(var i=r-1;i>a;i--){t.removeColumn(i)}for(var c=0;c<=n;c++){var l=new Date(o.getFullYear(),o.getMonth()+c,1);var d=l.getFullYear();var f=l.toLocaleString("default",{month:"long"});var u=d+"-"+f;var h=new sap.m.Column({header:new sap.m.Label({text:u}),width:"100px"});t.insertColumn(h,a+1+c)}var g=this.getView().byId("scroll_container_"+e);if(g){g.setHorizontal(true);g.setVertical(false);g.setWidth("100%")}console.log("startDate:",o);console.log("endDate:",s)},this)},findTotalColumnIndex:function(e){var t=e.getColumns();for(var a=0;a<t.length;a++){var o=t[a].getHeader();if(o&&o.getText()==="Total1"){return a}}return-1},getMonthsDifference:function(e,t){var a=(t.getFullYear()-e.getFullYear())*12;a-=e.getMonth();a+=t.getMonth();return a},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);console.log("Navigating to View1");e.navTo("appNoparame")},onSelectOpx:function(e){var t=e.getParameter("selectedItem").getKey();console.log(t);var a=this.getView().byId("table0");if(t==="Opex Servicios"){a.setVisible(false)}else{a.setVisible(true)}},onCheckBoxSelectMulti:function(e){console.log("onCheckBoxSelect called");var t=e.getSource();var a=t.getSelected();console.log("Checkbox selected: ",a);var o=this.byId("table_clienteFac");console.log("Table found: ",!!o);if(o){o.setVisible(a)}},onInputChange:function(){var e=this.getView();var t=this.byId("input0").getValue();var a=this.byId("input1").getValue();var o=this.byId("id_Cfactur").getValue();var s=this.byId("int_clienteFun").getValue();console.log(t,a);var n=this.byId("slct_area");var r="";var i="";if(n&&n.getSelectedItem()){r=n.getSelectedItem().getText();i=n.getSelectedItem().getKey();console.log("Selected Key:",i);console.log("Selected Text:",r)}var c=this.byId("slct_Jefe");var l="";if(c&&c.getSelectedItem()){l=c.getSelectedItem().getText();console.log("Selected Jefe Text:",l)}var d=this.byId("slct_client");var f="";if(d&&d.getSelectedItem()){f=d.getSelectedItem().getText();console.log("Selected Function Text:",f)}var u=this.byId("date_inico");var h=u?u.getDateValue():null;var g="";if(h){g=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(h)}var p=this.byId("slct_inic");var m="";if(p&&p.getSelectedItem()){m=p.getSelectedItem().getText();console.log("Selected Function Text:",m)}var v=this.byId("idNatu");var I="";if(v&&v.getSelectedItem()){I=v.getSelectedItem().getText();console.log("Selected Function Text:",I)}var y=this.byId("date_fin");var b=y?y.getDateValue():null;var T="";if(b){T=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"}).format(b)}console.log("Formatted Start Date: ",g);console.log("Formatted End Date: ",T);this.byId("txt_codig").setText(t);this.byId("txt_nomPro").setText(a);this.byId("txt_area").setText(r);this.byId("txt_NomJefe").setText(l);this.byId("txt_funcio").setText(s);this.byId("txt_feIni").setText(g);this.byId("txt_feFin").setText(T);this.byId("txt_ini").setText(m);this.byId("txt_client").setText(s);this.byId("txt_cFactura").setText(o);this.byId("txt_Codi2").setText(t);this.byId("txt_Nombre2").setText(a);this.byId("txt_area2").setText(r);this.byId("txt_Fe_ini2").setText(g);this.byId("txt_Fe_fin2").setText(T);this.byId("textClitFu3").setText(s);this.byId("textCliFac3").setText(o);this.byId("textCodigo3").setText(t);this.byId("textNatural3").setText(I);this.byId("txtNombre3").setText(a);this.byId("txtAre3").setText(r);this.byId("txtFechInici3").setText(g);this.byId("txtFechFin3").setText(T)},onSelectCheckbox:function(e){try{var t=this.byId("table2");if(!t){console.error("Tabla no encontrada.");return}var a=t.getItems();var o=e.getSource().getSelected();if(o===undefined){console.error("Error al obtener el estado del checkbox.");return}var s=e.getSource().getParent().getParent().indexOfColumn(e.getSource().getParent());var n=s===0?"box_prove":"box_condi";var r=this.byId(n);if(!r){console.error("El otro checkbox no se encontró.");return}r.setEnabled(!o);a.forEach(function(e){var t=e.getCells();t.forEach(function(e,t){if(e.setEditable){e.setEditable(t===s?o:!o)}})})}catch(e){console.error("Error en la función onSelectCheckbox:",e)}}})});
//# sourceMappingURL=View1.controller.js.map