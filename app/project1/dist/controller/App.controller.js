sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/CustomData","sap/ui/core/format/DateFormat","sap/m/MessageBox"],function(e,t,o,a){"use strict";return e.extend("project1.controller.App",{onInit:function(){this._loadProjectData();const e=this.getOwnerComponent().getRouter();e.getRoute("app").attachPatternMatched(this._onObjectMatched,this);this.bProcessFlowAllowed=false;this.loadFilteredData();this.loadFilteredDataPend();this.getUserInfo();this.filterEstado()},pressFichas:function(){},filterEstado:async function(){try{const e=await fetch("/odata/v4/datos-cdo/DatosProyect?$expand=Area,jefeProyectID");const t=await e.json();const o=t.value;const a=await Promise.all(o.map(async e=>{const t=e.ID;const o=e=>{if(!e)return null;const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getFullYear()}`};e.FechaCreacionFormateada=o(e.fechaCreacion);e.FechaModificacionFormateada=o(e.FechaModificacion);e.NombreArea=e.Area?.NombreArea||"Sin área";e.NombreJefe=e.jefeProyectID?.name||"Sin jefe";if(e.Estado==="Borrador"){e.workflowId=null;e.actualizadoEn=null;e.actualizadoEnFormateada="No aplica";return e}const a=await fetch(`/odata/v4/datos-cdo/WorkflowInstancias?$filter=datosProyect_ID eq '${t}'&$orderby=creadoEn desc&$top=1&$select=estado,workflowId,actualizadoEn`);const s=await a.json();const n=s.value[0];e.Estado=n?.estado||"Pendiente";e.workflowId=n?.workflowId||null;e.actualizadoEn=n?.actualizadoEn||null;e.actualizadoEnFormateada=o(e.actualizadoEn)||"Fecha no disponible";return e}));const s=a.filter(e=>e.Estado==="Aprobado");const n=a.filter(e=>e.Estado==="Pendiente");const i=a.filter(e=>e.Estado==="Borrador");const r=this.byId("status0");if(n.length>0){r.setText("Pendiente");r.setState("Warning")}else if(i.length>0){r.setText("Borrador");r.setState("None")}else{r.setText("Aprobado");r.setState("Success")}const c=new sap.ui.model.json.JSONModel({DatosProyect:s,Count:s.length});const l=new sap.ui.model.json.JSONModel({DatosProyect:n,Count:n.length});const d=new sap.ui.model.json.JSONModel({DatosProyect:i,Count:i.length});const u=new sap.ui.model.json.JSONModel({Count:a.length});this.getView().setModel(c,"modelAprobados");this.getView().setModel(l,"modelPendientes");this.getView().setModel(d,"modelBorrador");this.getView().setModel(u,"modelTotal");console.log(n[0]?.NombreArea);console.log(n[0]?.NombreJefe)}catch(e){console.error("Error al cargar los proyectos con estado:",e)}},onVerHistorial:async function(e){try{const t=e.getSource();let o=t.getBindingContext("modelPendientes");let a="modelPendientes";if(!o){o=t.getBindingContext("modelAprobados");a="modelAprobados"}if(!o){sap.m.MessageBox.warning("No se pudo determinar el modelo de origen.");return}const s=o.getObject();const n=s.workflowId;if(!n){sap.m.MessageToast.show("Este proyecto no tiene un workflow asociado.");return}const i=this.getOwnerComponent().getModel();const r=i.bindContext("/getWorkflowTimeline(...)");r.setParameter("ID",n);await r.execute();const c=r.getBoundContext().getObject();console.log(` Historial del workflow (${a}):`,c);await this.onActivityPress(e,c);sap.m.MessageBox.information(JSON.stringify(c,null,2))}catch(e){console.error(" Error al obtener el historial del workflow:",e);sap.m.MessageBox.error("No se pudo obtener el historial del workflow.")}},onActivityPress:function(e,t){this.byId("ma77").setVisible(true);var o=e.getSource();var a=o.getCustomData()[0].getValue();var s=o.getCustomData()[1].getValue();const n=t.value;var i=this.byId("processflow1");if(!i){console.error("No se encontró el ProcessFlow con ID 'processflow1'");return}i.removeAllNodes();this.createProcessFlowNodes(n,i,a);i.attachNodePress(this.onNodePress.bind(this));this.byId("idTitleProceso").setText("Proceso de solicitud: "+a);this.byId("text1881").setText("PEP de solicitud: "+s);this.byId("itb1").setSelectedKey("people")},createProcessFlowNodes:function(e,t,o){const a={CDO:"0","APROBACIÓN":"1","NOTIFICACIÓN":"1","CONFIRMAR ENTRADAS":"2",BASIS:"2","LEER ENTRADAS":"3","REVISION PMO":"3","APROBADO PMO":"4",APROBADO:"4",CONTROL:"5",GESTION:"6","REVISION DIRECCION":"8",DIRECCION:"8","APROBACIÓN DIRECCIÓN":"9",RECHAZO:"99",FINALIZADO:"99"};const s={COMPLETED:"Positive",APPROVED:"Positive",RECHAZO:"Negative",REJECTED:"Negative",PENDIENTE:"Critical",EMAIL:"Neutral",CREATED:"Neutral",TRIGGERED:"Neutral",REACHED:"Neutral"};const n=["Condición de Espera","Esperar a terminar el flujo","Espera respuesta"];const i=e.filter(e=>{const t=(e.paso||"").trim().toUpperCase();return!n.some(e=>t.includes(e.toUpperCase()))});const r=new Map;i.forEach(e=>{const t=`${e.instancia}-${(e.paso||"").trim()}`;const o=r.get(t);if(!o||new Date(e.timestamp)>new Date(o.timestamp)){r.set(t,e)}});const c=Array.from(r.values()).sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp));if(c.length===0){console.warn("No hay eventos válidos para mostrar en el flujo.");return}c.forEach((e,n)=>{if(!e.id)e.id="evento_"+n;if(n===0&&(e.paso||"").toUpperCase().includes("INICIALIZAR VARIABLE")){e.paso="Solicitud enviada correctamente "+o}let i=(e.paso||"Paso desconocido").trim();if(n===c.length-1&&i==="Paso desconocido"&&(e.descripcion||"").toUpperCase().includes("FINALIZACIÓN DEL WORKFLOW")){i="Fin del proceso de aprobación"}const r=i.toUpperCase();const l=e.descripcion||"";let d="0";for(let e in a){if(r.includes(e)){d=a[e];break}}let u="Neutral";for(let t in s){if((e.tipo||"").toUpperCase().includes(t)){u=s[t];break}}if((e.tipo||"").toUpperCase()==="INTERMEDIATE_TIMER_EVENT_TRIGGERED"){u="Critical"}if((e.tipo||"").toUpperCase()==="EXCLUSIVE_GATEWAY_REACHED"){u="Critical"}const p=c[n+1];const f=p?[p.id]:[];const m=new sap.suite.ui.commons.ProcessFlowNode({nodeId:e.id,laneId:d,title:i,titleAbbreviation:i.substring(0,3),state:u,stateText:l,children:f,isTitleClickable:true,focused:false,highlighted:false,texts:[i,l]});m.addCustomData(new sap.ui.core.CustomData({key:"eventoOriginal",value:JSON.stringify(e)}));m.data("eventoOriginal",e);t.addNode(m)})},onNodePress:function(e){const t=e.getParameters();if(!t){console.warn("Nodo no encontrado (evento vacío)");return}const o=t.data("eventoOriginal");if(!o){console.warn("El nodo no tiene data 'eventoOriginal'");return}if(!this._oPopover){this._oPopover=new sap.m.Popover({title:"Detalles del Paso",placement:sap.m.PlacementType.Auto,contentWidth:"300px",content:[new sap.m.VBox({items:[new sap.m.HBox({alignItems:"Center",items:[new sap.ui.core.Icon({src:"sap-icon://hint",color:"#0070f2"}),new sap.m.Label({text:" Información del Paso ",design:"Bold",class:"sapUiSmallMarginBegin"})],class:"sapUiSmallMarginBottom"}),new sap.m.ObjectStatus({title:"Paso ",text:"{/eventoPaso}",state:"Success",id:"statusPaso"}),new sap.m.ObjectStatus({title:"Descripción ",text:"{/eventoDescripcion}",state:"Information",id:"statusDescripcion"}),new sap.m.ObjectStatus({title:"Fecha ",text:"{/eventoFecha}",state:"Warning",id:"statusFecha"}),new sap.m.Button({text:"Cerrar",type:"Emphasized",icon:"sap-icon://decline",press:function(){this._oPopover.close()}.bind(this),class:"sapUiSmallMarginTop"})],class:"sapUiContentPadding"})]})}sap.ui.getCore().byId("statusPaso").setText(o.paso);sap.ui.getCore().byId("statusDescripcion").setText(o.descripcion);sap.ui.getCore().byId("statusFecha").setText(o.timestamp);this._oPopover.openBy(t)},getUserInfo:function(){fetch("/odata/v4/datos-cdo/getUserInfo").then(e=>{if(!e.ok){throw new Error("No se pudo obtener la información del usuario.")}return e.json()}).then(e=>{const t=e.value;if(t){this.byId("dddtg")?.setText(t.email);this.byId("233")?.setText(t.fullName)}else{console.error("No se encontró la información del usuario.")}}).catch(e=>{console.error(" Error obteniendo datos del usuario:",e)})},loadFilteredData:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var t=this.byId("idProductsTable");var o=t.getBinding("items");if(o){o.filter([e]);this.updateIconTabFilterCount(o)}else{t.attachEventOnce("updateFinished",function(){var o=t.getBinding("items");o.filter([e]);this.updateIconTabFilterCount(o)}.bind(this))}},updateIconTabFilterCount:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma55").setCount(t.toString())}.bind(this))},loadFilteredDataPend:function(){var e=this.byId("idPendientes");var t=e.getBinding("items");if(t){var o=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");t.filter([o]);var a=t.getContexts();var s=a.map(e=>e.getObject());console.log("Datos filtrados (Pendientes):",s);this.updateIconTabFilterCountPen(t)}else{e.attachEventOnce("updateFinished",function(){var t=e.getBinding("items");var o=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");t.filter([o]);var a=t.getContexts();var s=a.map(e=>e.getObject());console.log("Datos filtrados (Pendientes):",s);this.updateIconTabFilterCountPen(t)}.bind(this))}},updateIconTabFilterCountPen:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma3").setCount(t.toString())}.bind(this))},onSearch:function(e){var t=e.getParameter("newValue");var o=this.byId("idPendientes");var a=o.getBinding("items");var s=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");var n=[s];if(t&&t.length>0){var i=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:t.toLowerCase(),caseSensitive:false});n.push(i)}var r=new sap.ui.model.Filter({filters:n,and:true});a.filter(r)},onSearchApro:function(e){var t=e.getParameter("newValue");var o=this.byId("idProductsTable");var a=o.getBinding("items");var s=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var n=[s];if(t&&t.length>0){var i=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:t.toLowerCase(),caseSensitive:false});n.push(i)}var r=new sap.ui.model.Filter({filters:n,and:true});a.filter(r)},onAfterShow:function(){this._loadProjectData()},_loadProjectData:function(){const e=this.byId("idPendientes");const t=e.getBinding("items");if(t){t.refresh()}},_onObjectMatched:async function(e){const t=e.getParameter("arguments").newId;console.log("ids comtenriofg");if(!t){console.error("No se recibió un ID válido");return}await this.filterEstado()},_refreshTableData:function(){const e=this.byId("idPendientes");if(e){e.getBinding("items")?.refresh()}},formatDate:function(e){if(!e){return""}if(typeof e==="object"&&typeof e.getTime==="function"){e=e}else{e=new Date(e)}if(isNaN(e.getTime())){return""}var t=a.getInstance({pattern:"dd MMM yyyy",UTC:true});return t.format(e)},onEditPress:function(e){var t=e.getSource();var o=t.getBindingContext("modelPendientes");var a=t.getBindingContext("modelAprobados");var s=t.getBindingContext("modelBorrador");var n=o||a||s;if(!n){console.error("No se pudo obtener el contexto del ítem.");return}var i=n.getProperty("ID");if(!i){console.error("El ID del proyecto es nulo o indefinido");return}console.log("edit id "+i);var r=n.getProperty("nameProyect");var c=this;var l=this.getView().getModel("mainService");if(l){l.setData({});l.refresh(true)}var d=o?"modelPendientes":a?"modelAprobados":"modelBorrador";var u=new sap.m.Dialog({title:"Confirmar Edición",type:"Message",state:"Warning",content:new sap.m.Text({text:"¿Estás seguro de que quieres editar el proyecto '"+r+"'?"}),beginButton:new sap.m.Button({text:"Confirmar",press:function(){u.close();var e=sap.ui.core.UIComponent.getRouterFor(c);e.navTo("view",{sProjectID:i,sourceModel:d},true)}}),endButton:new sap.m.Button({text:"Cancelar",press:function(){u.close()}})});u.open()},onView:function(e){if(!this.Dialog){this.Dialog=this.loadFragment({name:"project1.view.Dialog"})}this.Dialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},DialogInfo:async function(e){this.onView();var t=e.getSource();var o=t.getCustomData().find(function(e){return e.getKey()==="projectId"}).getValue();console.log("Metodo project "+o);const a=this._sCsrfToken;var s=this.getView().getModel("mainService");if(s){s.setData({});s.refresh(true)}var n=`/odata/v4/datos-cdo/DatosProyect(${o})`;try{const e=await fetch(n,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":a}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const t=await e.json();console.log(JSON.stringify(t));this.byId("idNombreProyecto").setText(t.nameProyect);this.byId("idDescripcion1").setText(t.descripcion);this.byId("idCreador").setText(t.Empleado);this.byId("idEMail").setText(t.Email);this.byId("idModifi").setText(t.FechaModificacion);this.byId("fechainitProyect").setText(t.Fechainicio);const o=sap.ui.core.format.DateFormat.getDateTimeInstance({style:"medium"});const s=new Date(t.fechaCreacion);const u=o.format(s);this.byId("idCreacion").setText(u);var i=t.FechaFin.split("T")[0];var r=i.split("-");var c=r[2]+"-"+r[1]+"-"+r[0];this.byId("idFechaFinProyect").setText(c);this.byId("idEstadoProyect").setText(t.Estado);this.byId("idArea").setText(t.Area_ID.NombreArea);var l=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t.Total);var d=l+" €";this.byId("idtotal").setText(d)}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}},onEmailPress2:function(e){const t=e.getSource().getText();window.location.href="mailto:"+t},onDeletePress:async function(e){let t=e.getSource();let o=t.getCustomData()[0].getValue();if(!o){console.error("No se encontró un ID válido para eliminar.");sap.m.MessageToast.show("Error: No se encontró un ID válido.");return}console.log("🔴 Eliminando Proyecto con ID:",o);try{let e=await fetch("/odata/v4/datos-cdo/",{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!e.ok)throw new Error("Error al obtener el CSRF Token");let t=e.headers.get("x-csrf-token");if(!t)throw new Error("No se recibió un CSRF Token");console.log("✅ CSRF Token obtenido:",t);sap.m.MessageBox.confirm("¿Deseas eliminar este proyecto y todos sus registros relacionados?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async e=>{if(e!==sap.m.MessageBox.Action.YES)return;try{const e=["planificacion","Facturacion","ClientFactura","ProveedoresC","RecursosInternos","ConsumoExternos","RecursosExternos","otrosConceptos","otrosGastoRecu","otrosRecursos","otrosServiciosConsu","GastoViajeConsumo","serviRecurExter","GastoViajeRecExter","LicenciasCon","WorkflowInstancias","ResumenCostesTotal","RecurInterTotal","ConsuExterTotal","RecuExterTotal","InfraestrLicencia","PerfilTotal"];let a=e.map(async e=>{let a=await fetch(`/odata/v4/datos-cdo/DatosProyect(${o})/${e}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(!a.ok){console.warn(`⚠️ No se pudieron obtener los registros de ${e}`);return}let s=a.headers.get("Content-Type");let n=s&&s.includes("application/json")?await a.json():{value:[]};let i=Array.isArray(n.value)?n.value:[n];if(i.length>0){return Promise.all(i.map(async o=>{let a=await fetch(`/odata/v4/datos-cdo/${e}(${o.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(!a.ok){console.error(`❌ Error eliminando ${e} con ID ${o.ID}`)}else{console.log(`✅ ${e} eliminado: ${o.ID}`)}}))}});await Promise.all(a);console.log("✅ Registros relacionados eliminados.");let s=await fetch(`/odata/v4/datos-cdo/DatosProyect(${o})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(s.ok){console.log("✅ Proyecto eliminado correctamente.");sap.m.MessageBox.success("Proyecto y registros eliminados exitosamente.",{title:"Éxito",actions:[sap.m.MessageBox.Action.OK],onClose:async function(){let e=this.byId("idPendientes");if(e){let t=e.getBinding("items");if(t){t.refresh(true)}else{console.warn("⚠️ No se encontró el binding de la tabla.")}}else{console.warn("⚠️ Tabla no encontrada con ID idPendientes.")}await this.filterEstado()}.bind(this)})}else{throw new Error("Error al eliminar el proyecto principal")}}catch(e){console.error("❌ Error eliminando el proyecto o registros:",e);sap.m.MessageToast.show("Error al eliminar el proyecto o registros.")}}})}catch(e){console.error("❌ Error al obtener el CSRF Token:",e);sap.m.MessageToast.show("Error al obtener el CSRF Token.")}},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("viewNoParam");var t=this.getOwnerComponent();var o=t.byId("view");if(!o){console.warn("No se encontró la vista objetivo.");return}function a(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}else if(e instanceof sap.viz.ui5.controls.VizFrame){e.destroyDataset();e.destroyFeeds();e.setVizProperties({})}if(e.getAggregation){const t=e.getMetadata().getAllAggregations();for(let o in t){const t=e.getAggregation(o);if(Array.isArray(t)){t.forEach(a)}else if(t instanceof sap.ui.core.Control){a(t)}}}}o.findAggregatedObjects(false,a);var s=this.getView();console.log("viwq "+s);if(s.getElementBinding()){s.getElementBinding().refresh()}var n=t.getModel();if(n){n.refresh()}e.navTo("viewNoParam")}})});
//# sourceMappingURL=App.controller.js.map