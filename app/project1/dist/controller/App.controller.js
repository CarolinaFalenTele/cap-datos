sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/CustomData","sap/m/MessageBox","sap/ui/core/format/DateFormat","project1/model/formatter"],function(e,t,o,a,s){"use strict";return e.extend("project1.controller.App",{formatter:s,onInit:function(){this._loadProjectData();const e=this.getOwnerComponent().getRouter();e.getRoute("app").attachPatternMatched(this._onObjectMatched,this);e.getRoute("appNoparame").attachPatternMatched(this._onObjectMatched,this);this.bProcessFlowAllowed=false;this.loadFilteredData();this.loadFilteredDataPend();this.getUserInfo();this._cargarDatosUsuario()},_cargarDatosUsuario:async function(){try{const e=await fetch("/odata/v4/datos-cdo/userdata");if(!e.ok){throw new Error("No se pudo obtener el usuario desde el backend.")}const t=await e.json();const o=new sap.ui.model.json.JSONModel(t);this.getView().setModel(o,"userModel");await this.filterEstado()}catch(e){console.error("Error al cargar el usuario:",e)}},filterEstado:async function(){try{const e=this.getView().getModel("userModel");if(!e){return}const t=e.getProperty("/ID");const o=e.getProperty("/email");const a=await fetch(`/odata/v4/datos-cdo/DatosProyect?$expand=Area,jefeProyectID`);const s=await a.json();const n=s.value;const r=n.filter(e=>e.Usuarios_ID===t);const i=async e=>await Promise.all(e.map(async e=>{const t=e.ID;const o=e=>{if(!e)return null;const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getFullYear()}`};e.FechaCreacionFormateada=o(e.fechaCreacion);e.fechaComiteForm=o(e.fechaComite);e.FechaModificacionFormateada=o(e.FechaModificacion);e.NombreArea=e.Area?.NombreArea||"Sin área";e.NombreJefe=e.jefeProyectID?.name||"Sin jefe";e.EstadoStatus=e.Estado==="Aprobado"?"Success":e.Estado==="Rechazado"?"Error":"None";e.OfertaIcon=e.Oferta?"sap-icon://accept":"sap-icon://decline";e.OfertaColor=e.Oferta?"#0066FF":"red";e.OfertaTexto=e.Oferta?"Si":"No";if(e.Estado==="Borrador"){e.workflowId=null;e.actualizadoEn=null;e.actualizadoEnFormateada="No aplica";e.Etapas=[];return e}const a=await fetch(`/odata/v4/datos-cdo/WorkflowInstancias?$filter=datosProyect_ID eq ${t}&$orderby=creadoEn desc&$top=1`);const s=await a.json();const n=s.value[0];let r=[];if(n?.ID){const e=await fetch(`/odata/v4/datos-cdo/WorkflowEtapas?$filter=workflow_ID eq ${n.workflowId}`);this._workID=n.workflowId;const t=await e.json();r=t.value||[]}const i=r.some(e=>e.estado==="Pendiente");if(i){e.Estado="Pendiente"}else if(n?.estado){e.Estado=n.estado}else{e.Estado=e.Estado||"Borrador"}e.workflowId=n?.workflowId||null;e.actualizadoEn=n?.actualizadoEn||null;e.actualizadoEnFormateada=o(e.actualizadoEn)||"Fecha no disponible";e.Etapas=r;return e}));const c=await i(n);const l=c.filter(e=>e.Estado==="Aprobado");const d=c.filter(e=>e.Estado==="Pendiente");const u=c.filter(e=>e.Estado==="Borrador"&&e.Usuarios_ID===t);const p=c.filter(e=>e.Estado==="Rechazado");const f=[];const m=[];d.forEach(e=>{const t=e.Etapas.filter(e=>e.estado==="Aprobado"||e.estado==="Rechazado").sort((e,t)=>new Date(t.fechaAprobado||t.creadoEn)-new Date(e.fechaAprobado||e.creadoEn))[0];if(t){e.UltimaEtapaComentario=t.comentario||"";e.UltimaEtapaNombre=t.nombreEtapa||"Etapa sin nombre"}else{e.UltimaEtapaComentario="";e.UltimaEtapaNombre=""}let a=false;e.Etapas.forEach(t=>{if(t.estado==="Pendiente"&&t.asignadoA?.trim().toLowerCase()===o?.trim().toLowerCase()){a=true;f.push({nombreEtapa:t.nombreEtapa,asignadoA:t.asignadoA,aprobadoPor:t.aprobadoPor,estado:t.estado,comentario:e.UltimaEtapaComentario,fechaAprobado:t.fechaAprobado,nameProyect:e.nameProyect,creadoPor:e.creadoPor,descripcion:e.descripcion,projectId:e.ID})}});if(a){m.push(e)}});const h=c.reduce((e,o)=>{if(o.Estado==="Borrador"&&o.Usuarios_ID!==t){return e}return e+1},0);this.getView().setModel(new sap.ui.model.json.JSONModel({Count:h}),"modelTotal");const g=await i(r);const w=g.filter(e=>e.Estado==="Pendiente");const I=[...l,...p];this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:I,Count:I.length}),"modelAprobados");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:d,Count:d.length}),"modelPendientes");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:u,Count:u.length}),"modelBorrador");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:p,Count:p.length}),"modelRechazados");this.getView().setModel(new sap.ui.model.json.JSONModel({Count:h}),"modelTotal");this.getView().setModel(new sap.ui.model.json.JSONModel({Etapas:f,Count:f.length}),"modelEtapasAsignadas");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:m,Count:m.length}),"modelAsignados");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:w,Count:w.length}),"modelMisSolicitudesPendientes");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:w,Count:w.length}),"modelMisSolicitudes");const C=this.byId("status0");if(d.length>0){C.setText("Pendiente");C.setState("Warning")}else if(p.length>0){C.setText("Rechazado");C.setState("None")}else if(u.length>0){C.setText("Borrador");C.setState("None")}else{C.setText("Aprobado");C.setState("Success")}}catch(e){console.error("❌ Error al cargar los proyectos con estado:",e)}},filtrarProyectosPorNombre:function(e){if(typeof e!=="string"){e=""}var t=this.getView().getModel("modelRechazados");var o=t.getProperty("/DatosProyect")||[];var a=o.filter(function(t){return t.name&&t.name.toLowerCase().includes(e.toLowerCase())});t.setProperty("/DatosProyect",a);t.setProperty("/Count",a.length)},filtrarProyectosPorNombre:function(e){if(typeof e!=="string"){e=""}var t=this.getView().getModel("modelRechazados");var o=t.getProperty("/DatosProyect")||[];var a=o.filter(function(t){return t.name&&t.name.toLowerCase().includes(e.toLowerCase())});t.setProperty("/DatosProyect",a);t.setProperty("/Count",a.length)},onActivityPress:function(e,t){this.byId("ma77").setVisible(true);var o=e.getSource();var a=o.getCustomData()[0].getValue();var s=o.getCustomData()[1].getValue();const n=t.value;var r=this.byId("processflow1");if(!r){console.error("No se encontró el ProcessFlow con ID 'processflow1'");return}r.removeAllNodes();this.createProcessFlowNodes(n,r,a);r.attachNodePress(this.onNodePress.bind(this));this.byId("idTitleProceso").setText("Proceso de solicitud: "+a);this.byId("text1881").setText("PEP de solicitud: "+s);this.byId("itb1").setSelectedKey("people")},onVerHistorial:async function(e){try{const t=e.getSource();let o=t.getBindingContext("modelPendientes");let a="modelPendientes";if(!o){o=t.getBindingContext("modelAprobados");a="modelAprobados"}if(!o){sap.m.MessageBox.warning("No se pudo determinar el modelo de origen.");return}const s=o.getObject();const n=s.workflowId;if(!n){return}const r=this.getOwnerComponent().getModel();const i=r.bindContext("/getWorkflowTimeline(...)");i.setParameter("ID",n);await i.execute();const c=i.getBoundContext().getObject();await this.onActivityPress(e,c);sap.m.MessageBox.information(JSON.stringify(c,null,2))}catch(e){console.error(" Error al obtener el historial del workflow:",e);sap.m.MessageBox.error("No se pudo obtener el historial del workflow.")}},onActivityPress:function(e,t){this.byId("ma77").setVisible(true);var o=e.getSource();var a=o.getCustomData()[0].getValue();var s=o.getCustomData()[1].getValue();const n=t.value;var r=this.byId("processflow1");if(!r){console.error("No se encontró el ProcessFlow con ID 'processflow1'");return}r.removeAllNodes();this.createProcessFlowNodes(n,r,a);r.attachNodePress(this.onNodePress.bind(this));this.byId("idTitleProceso").setText("Proceso de solicitud: "+a);this.byId("text1881").setText("PEP de solicitud: "+s);this.byId("itb1").setSelectedKey("people")},createProcessFlowNodes:function(e,t,o){const a={"SOLICITUD CDO":"0","APROBACIÓN":"1",BASIS:"2",PMO:"3","APROBADO PMO":"4",CONTROL:"5","GESTIÓN":"6","DIRECCIÓN":"8","APROBACIÓN DIRECCIÓN":"9",RECHAZO:"99",FINALIZADO:"99"};const s={COMPLETED:"Positive",APPROVED:"Positive",RECHAZO:"Negative",REJECTED:"Negative",PENDIENTE:"Critical",CREATED:"Neutral",TRIGGERED:"Neutral"};const n=[];const r=e.filter(e=>{const t=(e.paso||"").trim().toUpperCase();return!n.some(e=>t.includes(e.toUpperCase()))});const i=new Map;r.forEach(e=>{const t=`${e.instancia}-${(e.paso||"").trim()}`;const o=i.get(t);if(!o||new Date(e.timestamp)>new Date(o.timestamp)){i.set(t,e)}});const c=Array.from(i.values()).sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp));t.removeAllNodes();c.forEach((e,o)=>{if(!e.id)e.id="evento_"+o;let a=e.paso||"Paso desconocido";let n=this.obtenerLaneIdDesdePaso(a);const r=a.toUpperCase();if(r.includes("CDO")||r.includes("INICIO")){n="0"}else if(r.includes("APROBACIÓN")){n="1"}else if(r.includes("PENDIENTE")||r.includes("BASIS")||r.includes("TQ")||r.includes("FACTORIA")||r.includes("EMAIL DE APROBACIÓN")){n="2"}else if(r.includes("PMO")||r.includes("NOTIFICACIÓN")||r.includes("PENDIENTE")){if(r.includes("APROBACIÓN")){n="4"}else{n="3"}}else if(r.includes("CONTROL")||r.includes("GESTIÓN")){if(r.includes("APROBADO")){n="6"}else{n="5"}}else if(r.includes("DIRECCIÓN")||r.includes("REVISION")){if(r.includes("APROBACIÓN")){n="9"}else{n="8"}}else if(r.includes("RECHAZO")||r.includes("FINALIZADO")){n="99"}let i="Neutral";const l=(e.estado||e.tipo||"").toUpperCase();for(let e in s){if(l.includes(e)){i=s[e];break}}const d=c[o+1];const u=d?[d.id]:[];const p=new sap.suite.ui.commons.ProcessFlowNode({nodeId:e.id,laneId:n,title:a,titleAbbreviation:a.substring(0,3),state:i,stateText:e.descripcion||"",children:u,isTitleClickable:true,focused:false,highlighted:false,texts:[a,e.descripcion||""]});p.addCustomData(new sap.ui.core.CustomData({key:"eventoOriginal",value:JSON.stringify(e)}));p.data("eventoOriginal",e);t.addNode(p)})},obtenerLaneIdDesdePaso:function(e){const t=(e||"").toUpperCase();if(t.includes("CDO")||t.includes("SOLICITUD"))return"0";if(t.includes("NOTIFICACIÓN")&&t.includes("APROBACIÓN"))return"1";if(t.includes("BASIS")||t.includes("TQ")||t.includes("FACTORIA"))return"2";if(t.includes("NOTIFICACIÓN")&&t.includes("PMO"))return"3";if(t.includes("PMO")&&!t.includes("NOTIFICACIÓN"))return"4";if(t.includes("NOTIFICACIÓN")&&t.includes("CONTROL"))return"5";if(t.includes("CONTROL")&&!t.includes("NOTIFICACIÓN"))return"6";if(t.includes("NOTIFICACIÓN")&&t.includes("DIRECCIÓN"))return"8";if(t.includes("DIRECCIÓN")&&!t.includes("NOTIFICACIÓN"))return"9";if(t.includes("FINALIZADO")||t.includes("RECHAZO")||t.includes("RECHAZADO"))return"99";return"0"},onNodePress:function(e){const t=e.getParameters();if(!t)return;const o=t.data("eventoOriginal");if(!o)return;if(!this._oDialog){this._oDialog=new sap.m.Dialog({title:"Detalles del Paso",contentWidth:"500px",contentHeight:"auto",stretchOnPhone:true,verticalScrolling:true,content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[new sap.m.Label({text:"Paso"}),new sap.m.Text({text:o.paso||"Paso desconocido"}),new sap.m.Label({text:"Descripción"}),new sap.m.Text({text:o.descripcion||""}),new sap.m.Label({text:"Fecha"}),new sap.m.Text({text:o.timestamp||""}),new sap.m.Label({text:"Comentario"}),new sap.m.Text({text:o.comentario||"N/A",wrapping:true})]})],beginButton:new sap.m.Button({text:"Cerrar",type:"Emphasized",press:function(){this._oDialog.close()}.bind(this)})});this.getView().addDependent(this._oDialog)}else{const e=this._oDialog.getContent()[0];e.removeAllContent();e.addContent(new sap.m.ObjectStatus({title:"Paso",text:o.paso||"Paso desconocido",state:"Success"}));e.addContent(new sap.m.ObjectStatus({title:"Descripción",text:o.descripcion||"",state:"Information"}));e.addContent(new sap.m.ObjectStatus({title:"Fecha",text:o.timestamp||"",state:"Warning"}));e.addContent(new sap.m.Label({text:"Comentario",design:"Bold",class:"sapUiSmallMarginTop"}));e.addContent(new sap.m.Text({title:"Comentario",text:o.comentario||"N/A",wrapping:true,width:"100%"}))}this._oDialog.open()},getUserInfo:function(){fetch("/odata/v4/datos-cdo/getUserInfo").then(e=>{if(!e.ok){throw new Error(" No se pudo obtener la información del usuario.")}return e.json()}).then(e=>{const t=e.value;const o=e.token||t?.token;if(!t){console.error(" No se encontró la información del usuario.");return}const a=(e,t,o)=>{const a=this.byId(e);if(a){a.setText(t||o)}else{}};a("dddtg",t.email,"Sin email");a("attrEmpleado",t.fullName,"Sin nombre");const s=t.roles||{};const n=Object.keys(s);const r=["","Visualizador","user","DatosProyect.Read"];const i=n.length===r.length&&n.every(e=>r.includes(e));console.log("Roles del usuario:",n);const c=["newId_btnEditar","aprobBtnEdit","butn34"];const l=["ww","wsw","newId_btnEliminar","newId_btnEliminar2"];const d=this.byId("33");const u=["Control","Direccion","BasisTQFac","PMO"];const p=u.some(e=>n.includes(e));const f=this.byId("id34");if(f){f.setVisible(p)}else{}const m=(e,t,o)=>{e.forEach(e=>{const o=this.byId(e);if(!o){}else{o.setEnabled(t)}})};if(i){m(c,false,"editar");m(l,false,"eliminar");if(d){d.setEnabled(false)}else{}sap.m.MessageBox.warning("Solo tiene permisos de visualizador. No puede crear, editar ni borrar.",{title:"Permisos insuficientes"})}else{m(c,true,"editar");m(l,true,"eliminar");if(d){d.setEnabled(true)}else{console.warn(" Botón de creación no encontrado: id '33'")}}if(o){this._startSessionWatcher(o)}else{console.warn("Token no recibido en la respuesta.")}}).catch(e=>{console.error("Error obteniendo datos del usuario:",e)})},_startSessionWatcher:function(e){const t=this._parseJwt(e);const o=t.exp*1e3;const a=Date.now();const s=o-a-1*60*1e3;if(s>0){setTimeout(()=>{this._showSessionWarning(o)},s)}else{this._showSessionWarning(o)}},_showSessionWarning:function(e){let t=Math.floor((e-Date.now())/1e3);const a=setInterval(()=>{if(t<=0){clearInterval(a);o.error("  Tu sesión ha expirado. (En pruebas: no se cerrará la sesión)");return}if(s&&s.getContent&&s.getContent()[0]){s.getContent()[0].setText(`Tu sesión expirará en ${t} segundos. ¿Deseas continuar?`)}t--},1e3);const s=new sap.m.Dialog({title:"  Sesión a punto de expirar",content:[new sap.m.Text({text:`Tu sesión expirará en ${t} segundos. ¿Deseas continuar?`})],beginButton:new sap.m.Button({text:"Sí, mantener sesión",press:()=>{clearInterval(a);s.close();this._refreshToken()}}),endButton:new sap.m.Button({text:"No",press:()=>{clearInterval(a);s.close()}}),afterClose:()=>{s.destroy()}});s.open()},_parseJwt:function(e){const t=e.split(".")[1];const o=atob(t.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(decodeURIComponent(escape(o)))},_refreshToken:async function(){try{const e=await fetch("/odata/v4/datos-cdo/getUserInfo",{method:"GET"});const t=await e.json();console.log("Respuesta refresco token:",t);const a=t.token||t.value&&t.value.token;if(a){this._startSessionWatcher(a);o.success("Sesión renovada.")}else{throw new Error("Token no recibido.")}}catch(e){o.error("No se pudo renovar la sesión: "+e.message)}},loadFilteredData:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var t=this.byId("tabla_Aprobadores");var o=t.getBinding("items");if(o){o.filter([e]);this.updateIconTabFilterCount(o)}else{t.attachEventOnce("updateFinished",function(){var o=t.getBinding("items");o.filter([e]);this.updateIconTabFilterCount(o)}.bind(this))}},updateIconTabFilterCount:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma55").setCount(t.toString())}.bind(this))},loadFilteredDataPend:function(){var e=this.byId("idPendientes");var t=e.getBinding("items");if(t){var o=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");t.filter([o]);var a=t.getContexts();var s=a.map(e=>e.getObject());this.updateIconTabFilterCountPen(t)}else{e.attachEventOnce("updateFinished",function(){var t=e.getBinding("items");var o=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");t.filter([o]);var a=t.getContexts();var s=a.map(e=>e.getObject());this.updateIconTabFilterCountPen(t)}.bind(this))}},updateIconTabFilterCountPen:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma3").setCount(t.toString())}.bind(this))},onSearch:function(e){const t=e.getParameter("newValue")||e.getParameter("query")||"";const o=this.byId("TableBorrador");const a=o.getBinding("items");if(a){if(t.length>0){const e=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("FechaCreacionFormateada",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("nameProyect",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("descripcion",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("NombreArea",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("NombreJefe",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("FechaModificacionFormateada",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.Contains,t)],and:false});a.filter(e)}else{a.filter([])}}},onSearchApro:function(e){var t=e.getParameter("newValue");var o=this.byId("tabla_Aprobadores");var a=o.getBinding("items");var s=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var n=[s];if(t&&t.length>0){var r=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:t.toLowerCase(),caseSensitive:false});n.push(r)}var i=new sap.ui.model.Filter({filters:n,and:true});a.filter(i)},onSearchAprobadores:function(e){const t=e.getParameter("newValue")||e.getParameter("query")||"";const o=this.byId("tabla_Aprobadores");const a=o.getBinding("items");if(a){if(t.length>0){const e=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("nombreEtapa",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("nameProyect",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("descripcion",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("asignadoA",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("comentario",sap.ui.model.FilterOperator.Contains,t)],and:false});a.filter(e)}else{a.filter([])}}},onAfterShow:function(){this._loadProjectData()},_loadProjectData:function(){const e=this.byId("idPendientes");const t=e.getBinding("items");if(t){t.refresh()}},_onObjectMatched:async function(e){const t=this.getOwnerComponent().getModel("modelEtapasAsignadas");if(t){t.refresh(true)}this._refrescarModelEtapas();this.filterEstado()},_refrescarModelEtapas:async function(){try{const e=this.getView().getModel("userModel");if(!e)return;const t=e.getProperty("/email");const o=this.getView().getModel("modelPendientes");if(!o)return;const a=o.getProperty("/DatosProyect")||[];const s=[];a.forEach(e=>{e.Etapas.forEach(o=>{if(o.estado==="Pendiente"&&o.asignadoA?.trim().toLowerCase()===t?.trim().toLowerCase()){s.push({nombreEtapa:o.nombreEtapa,asignadoA:o.asignadoA,aprobadoPor:o.aprobadoPor,estado:o.estado,comentario:o.comentario,fechaAprobado:o.fechaAprobado,nameProyect:e.nameProyect,creadoPor:e.creadoPor,descripcion:e.descripcion,projectId:e.ID})}})});this.getView().getModel("modelEtapasAsignadas").setData({Etapas:s,Count:s.length})}catch(e){console.error("Error al refrescar modelEtapasAsignadas:",e)}},_refreshTableData:function(){const e=this.byId("idPendientes");if(e){e.getBinding("items")?.refresh()}},formatDate:function(e){if(!e){return""}if(typeof e==="object"&&typeof e.getTime==="function"){e=e}else{e=new Date(e)}if(isNaN(e.getTime())){return""}var t=a.getInstance({pattern:"dd MMM yyyy",UTC:true});return t.format(e)},onEditPress:function(e){var t=e.getSource();var o=t.getBindingContext("modelPendientes");var a=t.getBindingContext("modelAprobados");var s=t.getBindingContext("modelBorrador");var n=t.getBindingContext("modelEtapasAsignadas");var r=t.getBindingContext("modelRechazados");var i=o||a||s||n||r;if(!i){console.error("No se pudo obtener el contexto del ítem.");return}var c=i.getProperty("ID")||i.getProperty("projectId");if(!c){console.error("El ID del proyecto es nulo o indefinido");return}var l=i.getProperty("nameProyect");var d=this;var u=this.getView().getModel("mainService");if(u){u.setData({});u.refresh(true)}var p=null;if(o){p="modelPendientes"}else if(a){p="modelAprobados"}else if(s){p="modelBorrador"}else if(n){p="modelEtapasAsignadas"}else if(r){p="modelRechazados"}var f=p==="modelEtapasAsignadas"||p==="modelAprobados"||p==="modelRechazados"?"display":"edit";var m=f==="edit"?"Confirmar Edición":"Ver Solicitud";var h=f==="edit"?"¿Estás seguro de que quieres editar el proyecto '"+l+"'?":"¿Quieres ver el contenido de esta solicitud?";var g=new sap.m.Dialog({title:m,type:"Message",state:"Warning",content:new sap.m.Text({text:h}),beginButton:new sap.m.Button({text:"Confirmar",press:function(){g.close();var e=sap.ui.core.UIComponent.getRouterFor(d);if(p==="modelEtapasAsignadas"){e.navTo("viewWithAprobacion",{sourceModel:p,mode:f,sProjectID:c,aprobacion:"true"})}else{e.navTo("viewWithMode",{sourceModel:p,mode:f,sProjectID:c},true)}}}),endButton:new sap.m.Button({text:"Cancelar",press:function(){g.close()}})});g.open()},onView:function(e){if(!this.Dialog){this.Dialog=this.loadFragment({name:"project1.view.Dialog"})}this.Dialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},DialogInfo:async function(e){this.onView();var t=e.getSource();var o=t.getCustomData().find(function(e){return e.getKey()==="projectId"}).getValue();const a=this._sCsrfToken;var s=this.getView().getModel("mainService");if(s){s.setData({});s.refresh(true)}var n=`/odata/v4/datos-cdo/DatosProyect(${o})?$expand=jefeProyectID,Area`;try{const e=await fetch(n,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":a}});if(!e.ok){const t=await e.text();throw new Error("Network response was not ok: "+t)}const t=await e.json();this.byId("idNombreProyecto").setText(t.nameProyect);this.byId("idDescripcion1").setText(t.descripcion);this.byId("idCreador").setText(t.Empleado);this.byId("idEMail").setText(t.Email);this.byId("idModifi").setText(t.FechaModificacion);this.byId("fechainitProyect").setText(t.Fechainicio);const o=t.jefeProyectID?.name||"Sin jefe asignado";this.byId("idJefeProyect").setText(o);this.byId("idArea").setText(t.Area?.NombreArea||"Sin área");const s=sap.ui.core.format.DateFormat.getDateTimeInstance({style:"medium"});const u=new Date(t.fechaCreacion);const p=s.format(u);this.byId("idCreacion").setText(p);if(t.FechaFin){var r=t.FechaFin.split("T")[0];var i=r.split("-");var c=i[2]+"-"+i[1]+"-"+i[0];this.byId("idFechaFinProyect").setText(c)}else{this.byId("idFechaFinProyect").setText("Sin fecha");console.warn("FechaFin es null o indefinido")}this.byId("idEstadoProyect").setText(t.Estado);const f=t.Estado||"";const m=this.byId("idEstadoProyect");m.setText(f);switch(f.toLowerCase()){case"aprobado":m.setState("Success");break;case"rechazado":m.setState("Error");break;case"pendiente":m.setState("Warning");break;case"borrador":m.setState("None");break;default:m.setState("None");break}var l=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t.Total);var d=l+" €";this.byId("idtotal").setText(d)}catch(e){console.error("Error al obtener los datos del proyecto:",e)}},onEmailPress2:function(e){const t=e.getSource().getText();window.location.href="mailto:"+t},onDeletePress:async function(e){let t=e.getSource();const o=t.data("etapaId");let a=t.getCustomData()[0].getValue();if(!a){console.error("No se encontró un ID válido para eliminar.");sap.m.MessageToast.show("Error: No se encontró un ID válido.");return}const s={otrosGastoRecu:["ValorMensuServReInter"],RecursosInternos:["ValorMensuReInter"],otrosRecursos:["ValorMensuGastViaReInter"],ConsumoExternos:["ValorMensuConsuEx"],otrosServiciosConsu:["ValorMensuServConsuEx"],GastoViajeConsumo:["ValorMensuGastoViaConsuEx"],RecursosExternos:["ValorMensuRecuExter"],serviRecurExter:["ValorMensuSerExter"],GastoViajeRecExter:["ValorMensuGastoViExter"],otrosConceptos:["ValorMensuOtrConcep"],LicenciasCon:["ValorMensulicencia"]};try{let e=await fetch("/odata/v4/datos-cdo/",{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!e.ok)throw new Error("Error al obtener el CSRF Token");let t=e.headers.get("x-csrf-token");if(!t)throw new Error("No se recibió un CSRF Token");sap.m.MessageBox.confirm("¿Deseas eliminar este proyecto y todos sus registros relacionados?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async e=>{if(e!==sap.m.MessageBox.Action.YES)return;this.byId("idPendientes").setBusy(true);this.byId("idTableAprobados").setBusy(true);this.byId("TableBorrador").setBusy(true);this.byId("tabla_Aprobadores").setBusy(true);try{const e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${a})?$expand=WorkflowInstancias`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(e.ok){if(o){try{const e=this.getOwnerComponent().getModel();const t=e.bindContext("/cancelWorkflow(...)");t.setParameter("workflowInstanceId",o);await t.execute()}catch(e){console.warn("Error al cancelar el workflow. Continuando con la eliminación.",e)}}}else{console.warn("No se pudo obtener la instancia de workflow.")}const n=["planificacion","planServicio","Facturacion","ClientFactura","ProveedoresC","RecursosInternos","ConsumoExternos","RecursosExternos","otrosConceptos","otrosGastoRecu","otrosRecursos","otrosServiciosConsu","GastoViajeConsumo","serviRecurExter","GastoViajeRecExter","LicenciasCon","WorkflowInstancias","ResumenCostesTotal","RecurInterTotal","ConsuExterTotal","RecuExterTotal","InfraestrLicencia","PerfilTotal","Archivos"];for(const e of n){let o=await fetch(`/odata/v4/datos-cdo/DatosProyect(${a})/${e}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(!o.ok){console.warn(`  No se pudieron obtener los registros de ${e}`);continue}let n=o.headers.get("Content-Type");let r=n&&n.includes("application/json")?await o.json():{value:[]};let i=Array.isArray(r.value)?r.value:[r];if(i.length>0){for(const o of i){if(s[e]){let a=s[e];for(const s of a){let a=await fetch(`/odata/v4/datos-cdo/${e}(${o.ID})/${s}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(a.ok){let e=await a.json();let o=e.value||[];await Promise.all(o.map(async e=>{let o=await fetch(`/odata/v4/datos-cdo/${s}(${e.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(!o.ok){console.error(`Error eliminando hijo anidado ${s} con ID ${e.ID}`)}else{}}))}else{console.warn(`No se pudieron obtener registros para hijo anidado ${s} de ${e}(${o.ID})`)}}}let a=await fetch(`/odata/v4/datos-cdo/${e}(${o.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(!a.ok){console.error(`Error eliminando ${e} con ID ${o.ID}`)}else{}}}}let r=await fetch(`/odata/v4/datos-cdo/DatosProyect(${a})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":t}});if(r.ok){sap.m.MessageBox.success("Proyecto y registros eliminados exitosamente.",{title:"Éxito",actions:[sap.m.MessageBox.Action.OK],onClose:async function(){let e=this.byId("idPendientes");if(e){let t=e.getBinding("items");if(t){t.refresh(true)}else{console.warn("  No se encontró el binding de la tabla.")}}else{console.warn("  Tabla no encontrada con ID idPendientes.")}await this.filterEstado()}.bind(this)})}else{throw new Error("Error al eliminar el proyecto principal")}}catch(e){console.error("Error eliminando el proyecto o registros:",e);sap.m.MessageToast.show("Error al eliminar el proyecto o registros.")}finally{this.byId("TableBorrador").setBusy(false);this.byId("idPendientes").setBusy(false);this.byId("idTableAprobados").setBusy(false);this.byId("tabla_Aprobadores").setBusy(false)}}})}catch(e){console.error("Error al obtener el CSRF Token:",e);sap.m.MessageToast.show("Error al obtener el CSRF Token.")}},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=this.getOwnerComponent();Promise.resolve().then(()=>{var e=t.byId("view");if(e&&e.getController&&typeof e.getController==="function"){var o=e.getController();if(o._clearAllInputs){o._clearAllInputs()}}});e.navTo("viewNoParam",{mode:"create"})}})});
//# sourceMappingURL=App.controller.js.map