sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/CustomData","sap/ui/core/format/DateFormat"],function(e,o,t){"use strict";return e.extend("project1.controller.App",{onInit:function(){var e=this.byId("processflow1");e.attachNodePress(this.onNodePress,this);this._loadProjectData();const o=this.getOwnerComponent().getRouter();o.getRoute("app").attachPatternMatched(this._onObjectMatched,this);this.bProcessFlowAllowed=false;this.loadFilteredData();this.loadFilteredDataPend()},loadFilteredData:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var o=this.byId("idProductsTable");var t=o.getBinding("items");if(t){t.filter([e]);this.updateIconTabFilterCount(t)}else{o.attachEventOnce("updateFinished",function(){var t=o.getBinding("items");t.filter([e]);this.updateIconTabFilterCount(t)}.bind(this))}},updateIconTabFilterCount:function(e){e.attachEventOnce("dataReceived",function(){var o=e.getLength();console.log("TOTAL COUNT --\x3e ",o);this.byId("ma55").setCount(o.toString())}.bind(this))},loadFilteredDataPend:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");var o=this.byId("idPendientes");var t=o.getBinding("items");if(t){t.filter([e]);this.updateIconTabFilterCountPen(t)}else{o.attachEventOnce("updateFinished",function(){var t=o.getBinding("items");t.filter([e]);this.updateIconTabFilterCountPen(t)}.bind(this))}},updateIconTabFilterCountPen:function(e){e.attachEventOnce("dataReceived",function(){var o=e.getLength();this.byId("ma3").setCount(o.toString())}.bind(this))},onSearch:function(e){var o=e.getParameter("newValue");var t=this.byId("idPendientes");var i=t.getBinding("items");var a=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");var n=[a];if(o&&o.length>0){var s=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:o.toLowerCase(),caseSensitive:false});n.push(s)}var r=new sap.ui.model.Filter({filters:n,and:true});i.filter(r)},onSearchApro:function(e){var o=e.getParameter("newValue");var t=this.byId("idProductsTable");var i=t.getBinding("items");var a=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var n=[a];if(o&&o.length>0){var s=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:o.toLowerCase(),caseSensitive:false});n.push(s)}var r=new sap.ui.model.Filter({filters:n,and:true});i.filter(r)},onActivityPress:function(e){var o=e.getSource();var t=o.getCustomData()[0].getValue();var i=o.getCustomData()[1].getValue();var a=this.byId("idTitleProceso");a.setText("Proceso de solicitud: "+t);var n=this.byId("text1881");n.setText("PEP de solicitud: "+i);var s=this.byId("processflow1");s.removeAllNodes();this.bProcessFlowAllowed=true;s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"solicitanteCdoNode",title:t,laneId:"0",state:"Positive",stateText:"Solicitud Iniciada",children:["revisarTQNode"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisarTQNode",title:"Requiere Basis/TQ/Factoria",laneId:"1",state:"Neutral",stateText:"Esperando Revisión",children:["revisionTQNode","revisionPMONode"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionTQNode",title:"Revisión Basis/TQ/Factoria",laneId:"2",state:"Neutral",stateText:"En Revisión",children:["revisionPMONode"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionPMONode",title:"Revisión PMO",laneId:"3",state:"Neutral",stateText:"Revisión PMO Pendiente",children:["rechazadoPMONode","revisionCdGNode"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"rechazadoPMONode",title:"Rechazado por PMO",laneId:"4",state:"Negative",stateText:"Solicitud Rechazada"}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionCdGNode",title:"Revisión Control de Gestión",laneId:"5",state:"Neutral",stateText:"En Revisión",children:["revisionDireccionNode"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionDireccionNode",title:"Aprobado por Gestion",laneId:"6",state:"Positive",stateText:"Aprobada por Gestion",children:["ReviDirec"]}));s.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"ReviDirec",title:"Revisión Dirección/CdO",laneId:"8",state:"Neutral",stateText:"Aprobada por Dirección"}));var r=this.byId("itb1");r.setSelectedKey("people");s.attachNodePress(this.onNodePress.bind(this))},onNodePress:function(e){var o=e.getParameters().getNodeId();var t=this.byId("processflow1");var i=t.getNodes();var a=i.find(function(e){return e.getNodeId()===o});if(!a){console.error("Nodo no encontrado");return}var n=a.getTitle();var s=a.getStateText();if(!this._oPopover){this._oPopover=new sap.m.Popover({title:"Detalles",placement:sap.m.PlacementType.Auto,content:[new sap.m.Text({text:""}),new sap.m.Button({text:"Cerrar",press:function(){this._oPopover.close()}.bind(this)})]})}var r=this._oPopover.getContent()[0];var d;if(s==="Estado1"){d="Solicitud Enviado Correctamente. \nTítulo: "+n}else if(s==="Estado2"){d="Información adicional para Estado2. \nTítulo: "+n}else{d="Nodo: "+n+"\nEstado: "+s}r.setText(d);this._oPopover.openBy(e.getSource());this.getView().addDependent(this._oPopover)},onIconTabSelect:function(e){var o=e.getParameter("key");var t=this.byId("itb1");var i=this.byId("ma77");if(o==="people"&&!this.bProcessFlowAllowed){sap.m.MessageBox.show("Por favor, seleccione una solicitud en la pestaña de solicitudes para ver el proceso.",{title:"Advertencia",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}});t.setSelectedKey("attachments");return}if(this.bProcessFlowAllowed){i.setVisible(true)}else{i.setVisible(false)}},onAfterShow:function(){this._loadProjectData()},_loadProjectData:function(){const e=this.byId("idPendientes");const o=e.getBinding("items");if(o){o.refresh()}},_onObjectMatched:function(e){const o=e.getParameter("arguments").newId;this._highlightNewRow(o)},_highlightNewRow:function(e){const o=this.byId("idPendientes");o.attachEventOnce("updateFinished",()=>{const t=o.getItems();console.log("Número de ítems en la tabla:",t.length);if(t.length===0){console.log("No hay ítems en la tabla.");return}let i=false;t.forEach(o=>{const t=o.getCells().find(e=>e.getId().endsWith("butn34"));console.log("Botón encontrado:",t);if(t){const a=t.getCustomData().find(e=>e.getKey()==="projectId");console.log("CustomData encontrado:",a?a.getValue():"No encontrado");if(a){const t=a.getValue();console.log("Comparando IDs:",t,e);if(t===e){console.log("Resaltando fila con ID:",t);o.addStyleClass("highlight-border");i=true}}}});if(!i){console.log("No se encontró una fila con el ID:",e)}o.rerender()})},formatDate:function(e){if(!e){return""}var o=new Date(e);if(isNaN(o.getTime())){return e}var i=t.getInstance({pattern:"dd MMM yyyy",UTC:true});return i.format(o)},onEditPress:function(e){var o=e.getSource();var t=o.getCustomData().find(function(e){return e.getKey()==="projectId"}).getValue();if(!t){console.error("El ID del proyecto es nulo o indefinido");return}else{console.log("ID Correct",t)}var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("view",{sProjectID:t})},onDeletePress:async function(e){var o=e.getSource();var t=o.getCustomData()[0].getValue();console.log("ID del Proyecto a eliminar:",t);await new Promise(e=>setTimeout(e,50));sap.m.MessageBox.confirm("¿Estás seguro de que deseas eliminar este proyecto y todos sus registros relacionados?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async function(e){if(e===sap.m.MessageBox.Action.YES){try{const e=[`planificacion`,`Facturacion`,`ClientFactura`,`ProveedoresC`,`RecursosInternos`,`ConsumoExternos`,`RecursosExternos`,`otrosConceptos`];for(let o of e){console.log(`Procesando entidad: ${o}`);let e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${t})/${o}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!e.ok){console.error(`Error al obtener los registros de ${o}`);continue}const i=e.headers.get("Content-Type");if(i&&i.includes("application/json")){const t=await e.json();console.log(`Datos recibidos de ${o}:`,t);if(Array.isArray(t.value)&&t.value.length>0){for(let e of t.value){console.log(`Eliminando hijo con ID ${e.ID} en ${o}`);let t=await fetch(`/odata/v4/datos-cdo/${o}(${e.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!t.ok){console.error(`Error al eliminar el hijo en ${o}: ${e.ID}`)}else{console.log(`Hijo eliminado exitosamente en ${o}: ${e.ID}`)}}}else if(t.ID){console.log(`Eliminando objeto único con ID ${t.ID} en ${o}`);let e=await fetch(`/odata/v4/datos-cdo/${o}(${t.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!e.ok){console.error(`Error al eliminar el hijo en ${o}: ${t.ID}`)}else{console.log(`Hijo eliminado exitosamente en ${o}: ${t.ID}`)}}else{console.warn(`No se encontró ningún ID en la respuesta de ${o}`)}}else{console.warn(`La respuesta de ${o} no es JSON o está vacía. Continuando con el siguiente...`);continue}}console.log("Eliminando el proyecto principal con ID:",t);let i=await fetch(`/odata/v4/datos-cdo/DatosProyect(${t})`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(i.ok){console.log("Proyecto eliminado exitosamente.");sap.m.MessageToast.show("Proyecto y sus hijos eliminados exitosamente");const e=this.byId("idPendientes");const t=e.getBinding("items");t.refresh();var o=this.getView().getModel();o.refresh()}else{console.error("Error al eliminar el proyecto principal.");sap.m.MessageToast.show("Error al eliminar el proyecto")}}catch(e){console.error("Error eliminando el proyecto o sus hijos:",e);sap.m.MessageToast.show("Error al eliminar el proyecto o sus hijos")}}}.bind(this)})},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("viewNoParam")}})});
//# sourceMappingURL=App.controller.js.map