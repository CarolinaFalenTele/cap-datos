sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/CustomData","sap/ui/core/format/DateFormat"],function(e,t,o){"use strict";return e.extend("project1.controller.App",{onInit:function(){var e=this.byId("processflow1");e.attachNodePress(this.onNodePress,this);this._loadProjectData();const t=this.getOwnerComponent().getRouter();t.getRoute("app").attachPatternMatched(this._onObjectMatched,this);this.bProcessFlowAllowed=false;this.loadFilteredData();this.loadFilteredDataPend();console.log("Vista de appp "+this.getView())},loadFilteredData:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var t=this.byId("idProductsTable");var o=t.getBinding("items");if(o){o.filter([e]);this.updateIconTabFilterCount(o)}else{t.attachEventOnce("updateFinished",function(){var o=t.getBinding("items");o.filter([e]);this.updateIconTabFilterCount(o)}.bind(this))}},updateIconTabFilterCount:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma55").setCount(t.toString())}.bind(this))},loadFilteredDataPend:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");var t=this.byId("idPendientes");var o=t.getBinding("items");if(o){o.filter([e]);this.updateIconTabFilterCountPen(o)}else{t.attachEventOnce("updateFinished",function(){var o=t.getBinding("items");o.filter([e]);this.updateIconTabFilterCountPen(o)}.bind(this))}},updateIconTabFilterCountPen:function(e){e.attachEventOnce("dataReceived",function(){var t=e.getLength();this.byId("ma3").setCount(t.toString())}.bind(this))},onSearch:function(e){var t=e.getParameter("newValue");var o=this.byId("idPendientes");var s=o.getBinding("items");var i=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");var a=[i];if(t&&t.length>0){var n=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:t.toLowerCase(),caseSensitive:false});a.push(n)}var r=new sap.ui.model.Filter({filters:a,and:true});s.filter(r)},onSearchApro:function(e){var t=e.getParameter("newValue");var o=this.byId("idProductsTable");var s=o.getBinding("items");var i=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var a=[i];if(t&&t.length>0){var n=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:t.toLowerCase(),caseSensitive:false});a.push(n)}var r=new sap.ui.model.Filter({filters:a,and:true});s.filter(r)},onActivityPress:function(e){var t=e.getSource();var o=t.getCustomData()[0].getValue();var s=t.getCustomData()[1].getValue();var i=this.byId("idTitleProceso");i.setText("Proceso de solicitud: "+o);var a=this.byId("text1881");a.setText("PEP de solicitud: "+s);var n=this.byId("processflow1");n.removeAllNodes();this.bProcessFlowAllowed=true;n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"solicitanteCdoNode",title:o,laneId:"0",state:"Positive",stateText:"Solicitud Iniciada",children:["revisarTQNode"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisarTQNode",title:"Requiere Basis/TQ/Factoria",laneId:"1",state:"Neutral",stateText:"Esperando Revisión",children:["revisionTQNode","revisionPMONode"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionTQNode",title:"Revisión Basis/TQ/Factoria",laneId:"2",state:"Neutral",stateText:"En Revisión",children:["revisionPMONode"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionPMONode",title:"Revisión PMO",laneId:"3",state:"Neutral",stateText:"Revisión PMO Pendiente",children:["rechazadoPMONode","revisionCdGNode"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"rechazadoPMONode",title:"Rechazado por PMO",laneId:"4",state:"Negative",stateText:"Solicitud Rechazada"}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionCdGNode",title:"Revisión Control de Gestión",laneId:"5",state:"Neutral",stateText:"En Revisión",children:["revisionDireccionNode"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"revisionDireccionNode",title:"Aprobado por Gestion",laneId:"6",state:"Positive",stateText:"Aprobada por Gestion",children:["ReviDirec"]}));n.addNode(new sap.suite.ui.commons.ProcessFlowNode({nodeId:"ReviDirec",title:"Revisión Dirección/CdO",laneId:"8",state:"Neutral",stateText:"Aprobada por Dirección"}));var r=this.byId("itb1");r.setSelectedKey("people");n.attachNodePress(this.onNodePress.bind(this))},onNodePress:function(e){var t=e.getParameters().getNodeId();var o=this.byId("processflow1");var s=o.getNodes();var i=s.find(function(e){return e.getNodeId()===t});if(!i){console.error("Nodo no encontrado");return}var a=i.getTitle();var n=i.getStateText();if(!this._oPopover){this._oPopover=new sap.m.Popover({title:"Detalles",placement:sap.m.PlacementType.Auto,content:[new sap.m.Text({text:""}),new sap.m.Button({text:"Cerrar",press:function(){this._oPopover.close()}.bind(this)})]})}var r=this._oPopover.getContent()[0];var l;if(n==="Estado1"){l="Solicitud Enviado Correctamente. \nTítulo: "+a}else if(n==="Estado2"){l="Información adicional para Estado2. \nTítulo: "+a}else{l="Nodo: "+a+"\nEstado: "+n}r.setText(l);this._oPopover.openBy(e.getSource());this.getView().addDependent(this._oPopover)},onIconTabSelect:function(e){var t=e.getParameter("key");var o=this.byId("itb1");var s=this.byId("ma77");if(t==="people"&&!this.bProcessFlowAllowed){sap.m.MessageBox.show("Por favor, seleccione una solicitud en la pestaña de solicitudes para ver el proceso.",{title:"Advertencia",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}});o.setSelectedKey("attachments");return}if(this.bProcessFlowAllowed){s.setVisible(true)}else{s.setVisible(false)}},onAfterShow:function(){this._loadProjectData()},_loadProjectData:function(){const e=this.byId("idPendientes");const t=e.getBinding("items");if(t){t.refresh()}},_onObjectMatched:function(e){const t=e.getParameter("arguments").newId;console.log("ID recibido en _onObjectMatched:",t);if(!t){console.error("No se recibió un ID válido");return}this._highlightNewRow(t)},_highlightNewRow:function(e){const t=this.byId("idPendientes");if(t.getItems().length>0){this._processTableRows(t,e)}else{t.attachEventOnce("updateFinished",()=>{this._processTableRows(t,e)})}},_processTableRows:function(e,t){const o=e.getItems();let s=false;o.forEach(e=>{const o=e.getCells().find(e=>e.getId().endsWith("butn34"));if(o){const i=o.getCustomData().find(e=>e.getKey()==="projectId");if(i){const o=i.getValue();console.log("Comparando IDs:",o,t);if(o===t){console.log("Resaltando fila con ID:",o);e.addStyleClass("highlight-border");s=true}}}});if(!s){console.log("No se encontró una fila con el ID:",t)}e.rerender()},formatDate:function(e){if(!e){return""}var t=new Date(e);if(isNaN(t.getTime())){return e}var s=o.getInstance({pattern:"dd MMM yyyy",UTC:true});return s.format(t)},onEditPress:function(e){var t=e.getSource();var o=t.getCustomData().find(function(e){return e.getKey()==="projectId"}).getValue();if(!o){console.error("El ID del proyecto es nulo o indefinido");return}else{console.log("ID Correcto",o)}var s=this.getView().getModel("mainService");if(s){s.setData({});s.refresh(true)}var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("view",{sProjectID:o},true)},onDeletePress:async function(e){let t=this.getView().getModel();let o=t.sServiceUrl;let s=e.getSource();let i=s.getCustomData()[0].getValue();if(!i){console.error("No se encontró un ID válido para eliminar.");sap.m.MessageToast.show("Error: No se encontró un ID válido.");return}console.log("ID del Proyecto a eliminar:",i);try{let e=await fetch(o,{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!e.ok){throw new Error("Error al obtener el CSRF Token")}let s=e.headers.get("x-csrf-token");if(!s){throw new Error("No se recibió un CSRF Token")}console.log("✅ CSRF Token obtenido:",s);sap.m.MessageBox.confirm("¿Estás seguro de que deseas eliminar este proyecto y todos sus registros relacionados?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async e=>{if(e===sap.m.MessageBox.Action.YES){try{const e=[`planificacion`,`Facturacion`,`ClientFactura`,`ProveedoresC`,`RecursosInternos`,`ConsumoExternos`,`RecursosExternos`,`otrosConceptos`];for(let t of e){let e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${i})/${t}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":s}});if(!e.ok){console.error(`Error al obtener los registros de ${t}`);continue}const o=e.headers.get("Content-Type");if(o&&o.includes("application/json")){const o=await e.json();if(Array.isArray(o.value)&&o.value.length>0){for(let e of o.value){console.log(`Eliminando hijo con ID ${e.ID} en ${t}`);let o=await fetch(`/odata/v4/datos-cdo/${t}(${e.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":s}});if(!o.ok){console.error(`Error al eliminar el hijo en ${t}: ${e.ID}`)}else{console.log(`Hijo eliminado exitosamente en ${t}: ${e.ID}`)}}}else if(o.ID){console.log(`Eliminando objeto único con ID ${o.ID} en ${t}`);let e=await fetch(`/odata/v4/datos-cdo/${t}(${o.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":s}});if(!e.ok){console.error(`Error al eliminar el hijo en ${t}: ${o.ID}`)}else{console.log(`Hijo eliminado exitosamente en ${t}: ${o.ID}`)}}else{console.log(`No se encontró ningún ID en la respuesta de ${t}`)}}else{console.warn(`La respuesta de ${t} no es JSON o está vacía.`);continue}}console.log("Eliminando el proyecto principal con ID:",i);let o=await fetch(`/odata/v4/datos-cdo/DatosProyect(${i})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":s}});if(o.ok){console.log("Proyecto eliminado exitosamente.");sap.m.MessageToast.show("Proyecto y sus hijos eliminados exitosamente");const e=this.byId("idPendientes");if(e){const t=e.getBinding("items");if(t){t.refresh()}}t.refresh()}else{console.error("Error al eliminar el proyecto principal.");sap.m.MessageToast.show("Error al eliminar el proyecto")}}catch(e){console.error("Error eliminando el proyecto o sus hijos:",e);sap.m.MessageToast.show("Error al eliminar el proyecto o sus hijos")}}}})}catch(e){console.error("Error al obtener el CSRF Token:",e);sap.m.MessageToast.show("Error al obtener el CSRF Token")}},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=this.getOwnerComponent();var o=t.byId("view");if(!o){console.warn("No se encontró la vista objetivo.");e.navTo("viewNoParam");return}function s(e){if(e instanceof sap.m.Input){e.setValue("")}else if(e instanceof sap.m.Select||e instanceof sap.m.ComboBox){e.setSelectedKey("")}else if(e instanceof sap.m.DatePicker){e.setDateValue(null)}else if(e instanceof sap.m.TextArea){e.setValue("")}else if(e instanceof sap.m.CheckBox){e.setSelected(false)}if(e.getAggregation){const t=e.getMetadata().getAllAggregations();for(let o in t){const t=e.getAggregation(o);if(Array.isArray(t)){t.forEach(s)}else if(t instanceof sap.ui.core.Control){s(t)}}}}o.findAggregatedObjects(false,s);e.navTo("viewNoParam")}})});
//# sourceMappingURL=App.controller.js.map