sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/CustomData","sap/ui/core/format/DateFormat","sap/m/MessageBox"],function(e,o,t,s){"use strict";return e.extend("project1.controller.App",{onInit:function(){this._loadProjectData();const e=this.getOwnerComponent().getRouter();e.getRoute("app").attachPatternMatched(this._onObjectMatched,this);this.bProcessFlowAllowed=false;this.loadFilteredData();this.loadFilteredDataPend();this.getUserInfo();this._cargarDatosUsuario()},_cargarDatosUsuario:async function(){try{const e=await fetch("/odata/v4/datos-cdo/userdata");if(!e.ok){throw new Error("No se pudo obtener el usuario desde el backend.")}const o=await e.json();const t=new sap.ui.model.json.JSONModel(o);this.getView().setModel(t,"userModel");await this.filterEstado()}catch(e){console.error("Error al cargar el usuario:",e)}},filterEstado:async function(){try{const e=this.getView().getModel("userModel");if(!e){console.error("âŒ userModel no estÃ¡ definido aÃºn.");return}const o=e.getProperty("/ID");const t=e.getProperty("/email");const s=await fetch(`/odata/v4/datos-cdo/DatosProyect?$expand=Area,jefeProyectID&$filter=Usuarios_ID eq '${o}'`);const n=await s.json();const a=n.value;const r=await Promise.all(a.map(async e=>{const o=e.ID;const t=e=>{if(!e)return null;const o=new Date(e);return`${o.getDate().toString().padStart(2,"0")}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getFullYear()}`};e.FechaCreacionFormateada=t(e.fechaCreacion);e.FechaModificacionFormateada=t(e.FechaModificacion);e.NombreArea=e.Area?.NombreArea||"Sin Ã¡rea";e.NombreJefe=e.jefeProyectID?.name||"Sin jefe";if(e.Estado==="Borrador"){e.workflowId=null;e.actualizadoEn=null;e.actualizadoEnFormateada="No aplica";e.Etapas=[];return e}const s=await fetch(`/odata/v4/datos-cdo/WorkflowInstancias?$filter=datosProyect_ID eq ${o}&$orderby=creadoEn desc&$top=1`);const n=await s.json();const a=n.value[0];let r=[];if(a?.ID){const e=await fetch(`/odata/v4/datos-cdo/WorkflowEtapas?$filter=workflow_ID eq ${a.workflowId}`);this._workID=a.workflowId;const o=await e.json();r=o.value||[]}const i=r.some(e=>e.estado==="Pendiente");if(i){e.Estado="Pendiente"}else if(a?.estado){e.Estado=a.estado}else{e.Estado=e.Estado||"Borrador"}e.workflowId=a?.workflowId||null;e.actualizadoEn=a?.actualizadoEn||null;e.actualizadoEnFormateada=t(e.actualizadoEn)||"Fecha no disponible";e.Etapas=r;return e}));const i=r.filter(e=>e.Estado==="Aprobado");const l=r.filter(e=>e.Estado==="Pendiente");const c=r.filter(e=>e.Estado==="Borrador");const d=r.filter(e=>e.Estado==="Rechazado");const u=[];const p=[];l.forEach(e=>{let o=false;e.Etapas.forEach(s=>{if(s.estado==="Pendiente"&&s.asignadoA?.trim().toLowerCase()===t?.trim().toLowerCase()){o=true;u.push({nombreEtapa:s.nombreEtapa,asignadoA:s.asignadoA,aprobadoPor:s.aprobadoPor,estado:s.estado,comentario:s.comentario,fechaAprobado:s.fechaAprobado,nameProyect:e.nameProyect,creadoPor:e.creadoPor,descripcion:e.descripcion,projectId:e.ID})}});if(o){p.push(e)}});this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:i,Count:i.length}),"modelAprobados");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:l,Count:l.length}),"modelPendientes");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:c,Count:c.length}),"modelBorrador");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:d,Count:d.length}),"modelRechazados");this.getView().setModel(new sap.ui.model.json.JSONModel({Count:r.length}),"modelTotal");this.getView().setModel(new sap.ui.model.json.JSONModel({Etapas:u,Count:u.length}),"modelEtapasAsignadas");this.getView().setModel(new sap.ui.model.json.JSONModel({DatosProyect:p,Count:p.length}),"modelAsignados");const f=this.byId("id34");if(f){f.setVisible(u.length>0)}const m=this.byId("status0");if(l.length>0){m.setText("Pendiente");m.setState("Warning")}else if(d.length>0){m.setText("Rechazado");m.setState("None")}else if(c.length>0){m.setText("Borrador");m.setState("None")}else{m.setText("Aprobado");m.setState("Success")}}catch(e){console.error(" Error al cargar los proyectos con estado:",e)}},filtrarProyectosPorNombre:function(e){if(typeof e!=="string"){e=""}var o=this.getView().getModel("modelRechazados");var t=o.getProperty("/DatosProyect")||[];var s=t.filter(function(o){return o.name&&o.name.toLowerCase().includes(e.toLowerCase())});o.setProperty("/DatosProyect",s);o.setProperty("/Count",s.length)},onVerHistorial:async function(e){try{const o=e.getSource();let t=o.getBindingContext("modelPendientes");let s="modelPendientes";if(!t){t=o.getBindingContext("modelAprobados");s="modelAprobados"}if(!t){sap.m.MessageBox.warning("No se pudo determinar el modelo de origen.");return}const n=t.getObject();const a=n.workflowId;if(!a){return}const r=this.getOwnerComponent().getModel();const i=r.bindContext("/getWorkflowTimeline(...)");i.setParameter("ID",a);await i.execute();const l=i.getBoundContext().getObject();console.log(` Historial del workflow (${s}):`,l);await this.onActivityPress(e,l)}catch(e){console.error(" Error al obtener el historial del workflow:",e);sap.m.MessageBox.error("No se pudo obtener el historial del workflow.")}},onActivityPress:function(e,o){this.byId("ma77").setVisible(true);var t=e.getSource();var s=t.getCustomData()[0].getValue();var n=t.getCustomData()[1].getValue();const a=o.value;var r=this.byId("processflow1");if(!r){console.error("No se encontrÃ³ el ProcessFlow con ID 'processflow1'");return}r.removeAllNodes();this.createProcessFlowNodes(a,r,s);r.attachNodePress(this.onNodePress.bind(this));this.byId("idTitleProceso").setText("Proceso de solicitud: "+s);this.byId("text1881").setText("PEP de solicitud: "+n);this.byId("itb1").setSelectedKey("people")},onVerHistorial:async function(e){try{const o=e.getSource();let t=o.getBindingContext("modelPendientes");let s="modelPendientes";if(!t){t=o.getBindingContext("modelAprobados");s="modelAprobados"}if(!t){sap.m.MessageBox.warning("No se pudo determinar el modelo de origen.");return}const n=t.getObject();const a=n.workflowId;if(!a){return}const r=this.getOwnerComponent().getModel();const i=r.bindContext("/getWorkflowTimeline(...)");i.setParameter("ID",a);await i.execute();const l=i.getBoundContext().getObject();console.log(` Historial del workflow (${s}):`,l);await this.onActivityPress(e,l)}catch(e){console.error(" Error al obtener el historial del workflow:",e);sap.m.MessageBox.error("No se pudo obtener el historial del workflow.")}},onActivityPress:function(e,o){this.byId("ma77").setVisible(true);var t=e.getSource();var s=t.getCustomData()[0].getValue();var n=t.getCustomData()[1].getValue();const a=o.value;var r=this.byId("processflow1");if(!r){console.error("No se encontrÃ³ el ProcessFlow con ID 'processflow1'");return}r.removeAllNodes();this.createProcessFlowNodes(a,r,s);r.attachNodePress(this.onNodePress.bind(this));this.byId("idTitleProceso").setText("Proceso de solicitud: "+s);this.byId("text1881").setText("PEP de solicitud: "+n);this.byId("itb1").setSelectedKey("people")},createProcessFlowNodes:function(e,o,t){const s={"SOLICITUD CDO":"0","APROBACIÃ“N":"1",BASIS:"2",PMO:"3","APROBADO PMO":"4",CONTROL:"5","GESTIÃ“N":"6","DIRECCIÃ“N":"8","APROBACIÃ“N DIRECCIÃ“N":"9",RECHAZO:"99",FINALIZADO:"99"};const n={COMPLETED:"Positive",APPROVED:"Positive",RECHAZO:"Negative",REJECTED:"Negative",PENDIENTE:"Critical",CREATED:"Neutral",TRIGGERED:"Neutral"};const a=[];const r=e.filter(e=>{const o=(e.paso||"").trim().toUpperCase();return!a.some(e=>o.includes(e.toUpperCase()))});const i=new Map;r.forEach(e=>{const o=`${e.instancia}-${(e.paso||"").trim()}`;const t=i.get(o);if(!t||new Date(e.timestamp)>new Date(t.timestamp)){i.set(o,e)}});const l=Array.from(i.values()).sort((e,o)=>new Date(e.timestamp)-new Date(o.timestamp));o.removeAllNodes();l.forEach((e,t)=>{if(!e.id)e.id="evento_"+t;let s=e.paso||"Paso desconocido";let a=this.obtenerLaneIdDesdePaso(s);const r=s.toUpperCase();if(r.includes("CDO")||r.includes("INICIO")){a="0"}else if(r.includes("APROBACIÃ“N")){a="1"}else if(r.includes("PENDIENTE")||r.includes("BASIS")||r.includes("TQ")||r.includes("FACTORIA")||r.includes("EMAIL DE APROBACIÃ“N")){a="2"}else if(r.includes("PMO")||r.includes("NOTIFICACIÃ“N")||r.includes("PENDIENTE")){if(r.includes("APROBACIÃ“N")){a="4"}else{a="3"}}else if(r.includes("CONTROL")||r.includes("GESTIÃ“N")){if(r.includes("APROBADO")){a="6"}else{a="5"}}else if(r.includes("DIRECCIÃ“N")||r.includes("REVISION")){if(r.includes("APROBACIÃ“N")){a="9"}else{a="8"}}else if(r.includes("RECHAZO")||r.includes("FINALIZADO")){a="99"}let i="Neutral";const c=(e.estado||e.tipo||"").toUpperCase();for(let e in n){if(c.includes(e)){i=n[e];break}}const d=l[t+1];const u=d?[d.id]:[];const p=new sap.suite.ui.commons.ProcessFlowNode({nodeId:e.id,laneId:a,title:s,titleAbbreviation:s.substring(0,3),state:i,stateText:e.descripcion||"",children:u,isTitleClickable:true,focused:false,highlighted:false,texts:[s,e.descripcion||""]});p.addCustomData(new sap.ui.core.CustomData({key:"eventoOriginal",value:JSON.stringify(e)}));p.data("eventoOriginal",e);o.addNode(p)})},obtenerLaneIdDesdePaso:function(e){const o=(e||"").toUpperCase();if(o.includes("CDO")||o.includes("SOLICITUD"))return"0";if(o.includes("NOTIFICACIÃ“N")&&o.includes("APROBACIÃ“N"))return"1";if(o.includes("BASIS")||o.includes("TQ")||o.includes("FACTORIA"))return"2";if(o.includes("NOTIFICACIÃ“N")&&o.includes("PMO"))return"3";if(o.includes("PMO")&&!o.includes("NOTIFICACIÃ“N"))return"4";if(o.includes("NOTIFICACIÃ“N")&&o.includes("CONTROL"))return"5";if(o.includes("CONTROL")&&!o.includes("NOTIFICACIÃ“N"))return"6";if(o.includes("NOTIFICACIÃ“N")&&o.includes("DIRECCIÃ“N"))return"8";if(o.includes("DIRECCIÃ“N")&&!o.includes("NOTIFICACIÃ“N"))return"9";if(o.includes("FINALIZADO")||o.includes("RECHAZO")||o.includes("RECHAZADO"))return"99";return"0"},onNodePress:function(e){const o=e.getParameters();if(!o){console.warn("Nodo no encontrado (evento vacÃ­o)");return}const t=o.data("eventoOriginal");if(!t){console.warn("El nodo no tiene data 'eventoOriginal'");return}if(!this._oPopover){this._oPopover=new sap.m.Popover({title:"Detalles del Paso",placement:sap.m.PlacementType.Auto,contentWidth:"300px",content:[new sap.m.VBox({items:[new sap.m.HBox({alignItems:"Center",items:[new sap.ui.core.Icon({src:"sap-icon://hint",color:"#0070f2"}),new sap.m.Label({text:" InformaciÃ³n del Paso ",design:"Bold",class:"sapUiSmallMarginBegin"})],class:"sapUiSmallMarginBottom"}),new sap.m.ObjectStatus({title:"Paso ",text:"{/eventoPaso}",state:"Success",id:"statusPaso"}),new sap.m.ObjectStatus({title:"DescripciÃ³n ",text:"{/eventoDescripcion}",state:"Information",id:"statusDescripcion"}),new sap.m.ObjectStatus({title:"Fecha ",text:"{/eventoFecha}",state:"Warning",id:"statusFecha"}),new sap.m.Button({text:"Cerrar",type:"Emphasized",icon:"sap-icon://decline",press:function(){this._oPopover.close()}.bind(this),class:"sapUiSmallMarginTop"})],class:"sapUiContentPadding"})]})}sap.ui.getCore().byId("statusPaso").setText(t.paso);sap.ui.getCore().byId("statusDescripcion").setText(t.descripcion);sap.ui.getCore().byId("statusFecha").setText(t.timestamp);this._oPopover.openBy(o)},getUserInfo:function(){console.log("ðŸ” Iniciando getUserInfo...");fetch("/odata/v4/datos-cdo/getUserInfo").then(e=>{console.log("ðŸ“¥ Respuesta recibida del backend:",e);if(!e.ok){throw new Error(" No se pudo obtener la informaciÃ³n del usuario.")}return e.json()}).then(e=>{console.log("ðŸ“¦ Datos parseados:",e);const o=e.value;const t=e.token||o?.token;if(!o){console.error(" No se encontrÃ³ la informaciÃ³n del usuario.");return}console.log("ðŸ‘¤ InformaciÃ³n del usuario:",o);const s=(e,o,t)=>{const s=this.byId(e);if(s){s.setText(o||t);console.log(` Control '${e}' seteado a:`,o||t)}else{console.warn(` Control no encontrado: id '${e}'`)}};s("dddtg",o.email,"Sin email");s("233",o.fullName,"Sin nombre");const n=o.roles||{};const a=Object.keys(n);const r=["","Visualizador","user","DatosProyect.Read"];const i=a.length===r.length&&a.every(e=>r.includes(e));console.log("Roles del usuario:",a);console.log(" Â¿Es solo Visualizador?",i);const l=["newId_btnEditar","aprobBtnEdit","butn34"];const c=["ww","wsw","newId_btnEliminar","newId_btnEliminar2"];const d=this.byId("33");const u=(e,o,t)=>{e.forEach(e=>{const s=this.byId(e);if(!s){console.warn(` BotÃ³n de ${t} no encontrado:`,e)}else{s.setEnabled(o)}})};if(i){u(l,false,"editar");u(c,false,"eliminar");if(d){d.setEnabled(false);console.log(" BotÃ³n de creaciÃ³n deshabilitado.")}else{console.warn(" BotÃ³n de creaciÃ³n no encontrado: id '33'")}sap.m.MessageBox.warning("Solo tiene permisos de visualizador. No puede crear, editar ni borrar.",{title:"Permisos insuficientes"})}else{console.log("Usuario con mÃ¡s permisos: habilitando botones...");u(l,true,"editar");u(c,true,"eliminar");if(d){d.setEnabled(true);console.log(" BotÃ³n de creaciÃ³n habilitado.")}else{console.warn(" BotÃ³n de creaciÃ³n no encontrado: id '33'")}}if(t){this._startSessionWatcher(t)}else{console.warn("Token no recibido en la respuesta.")}}).catch(e=>{console.error("Error obteniendo datos del usuario:",e)})},_startSessionWatcher:function(e){const o=this._parseJwt(e);const t=o.exp*1e3;const s=Date.now();const n=t-s-1*60*1e3;if(n>0){setTimeout(()=>{this._showSessionWarning(t)},n)}else{this._showSessionWarning(t)}},_showSessionWarning:function(e){let o=Math.floor((e-Date.now())/1e3);const s=setInterval(()=>{if(o<=0){clearInterval(s);t.error("â›” Tu sesiÃ³n ha expirado. (En pruebas: no se cerrarÃ¡ la sesiÃ³n)");return}if(n&&n.getContent&&n.getContent()[0]){n.getContent()[0].setText(`Tu sesiÃ³n expirarÃ¡ en ${o} segundos. Â¿Deseas continuar?`)}o--},1e3);const n=new sap.m.Dialog({title:"âš ï¸ SesiÃ³n a punto de expirar",content:[new sap.m.Text({text:`Tu sesiÃ³n expirarÃ¡ en ${o} segundos. Â¿Deseas continuar?`})],beginButton:new sap.m.Button({text:"SÃ­, mantener sesiÃ³n",press:()=>{clearInterval(s);n.close();this._refreshToken()}}),endButton:new sap.m.Button({text:"No",press:()=>{clearInterval(s);n.close()}}),afterClose:()=>{n.destroy()}});n.open()},_parseJwt:function(e){const o=e.split(".")[1];const t=atob(o.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(decodeURIComponent(escape(t)))},_refreshToken:async function(){try{const e=await fetch("/odata/v4/datos-cdo/getUserInfo",{method:"GET"});const o=await e.json();console.log("Respuesta refresco token:",o);const s=o.token||o.value&&o.value.token;if(s){this._startSessionWatcher(s);t.success("SesiÃ³n renovada.")}else{throw new Error("Token no recibido.")}}catch(e){t.error("No se pudo renovar la sesiÃ³n: "+e.message)}},loadFilteredData:function(){var e=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var o=this.byId("idProductsTable");var t=o.getBinding("items");if(t){t.filter([e]);this.updateIconTabFilterCount(t)}else{o.attachEventOnce("updateFinished",function(){var t=o.getBinding("items");t.filter([e]);this.updateIconTabFilterCount(t)}.bind(this))}},updateIconTabFilterCount:function(e){e.attachEventOnce("dataReceived",function(){var o=e.getLength();this.byId("ma55").setCount(o.toString())}.bind(this))},loadFilteredDataPend:function(){var e=this.byId("idPendientes");var o=e.getBinding("items");if(o){var t=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");o.filter([t]);var s=o.getContexts();var n=s.map(e=>e.getObject());this.updateIconTabFilterCountPen(o)}else{e.attachEventOnce("updateFinished",function(){var o=e.getBinding("items");var t=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Pendiente");o.filter([t]);var s=o.getContexts();var n=s.map(e=>e.getObject());this.updateIconTabFilterCountPen(o)}.bind(this))}},updateIconTabFilterCountPen:function(e){e.attachEventOnce("dataReceived",function(){var o=e.getLength();this.byId("ma3").setCount(o.toString())}.bind(this))},onSearch:function(e){const o=e.getParameter("newValue")||e.getParameter("query")||"";const t=this.byId("newId_tablePendientes");const s=t.getBinding("items");if(s){if(o.length>0){const e=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("FechaCreacionFormateada",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("nameProyect",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("descripcion",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("NombreArea",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("NombreJefe",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("FechaModificacionFormateada",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.Contains,o)],and:false});s.filter(e)}else{s.filter([])}}},onSearchApro:function(e){var o=e.getParameter("newValue");var t=this.byId("idProductsTable");var s=t.getBinding("items");var n=new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,"Aprobado");var a=[n];if(o&&o.length>0){var r=new sap.ui.model.Filter({path:"nameProyect",operator:sap.ui.model.FilterOperator.Contains,value1:o.toLowerCase(),caseSensitive:false});a.push(r)}var i=new sap.ui.model.Filter({filters:a,and:true});s.filter(i)},onSearchAprobadores:function(e){const o=e.getParameter("newValue")||e.getParameter("query")||"";const t=this.byId("tabla_Aprobadores");const s=t.getBinding("items");if(s){if(o.length>0){const e=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("nombreEtapa",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("nameProyect",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("descripcion",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("asignadoA",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("comentario",sap.ui.model.FilterOperator.Contains,o)],and:false});s.filter(e)}else{s.filter([])}}},onAfterShow:function(){this._loadProjectData()},_loadProjectData:function(){const e=this.byId("idPendientes");const o=e.getBinding("items");if(o){o.refresh()}},_onObjectMatched:async function(e){const o=e.getParameter("arguments").newId;console.log("ids comtenriofg");if(!o){console.error("No se recibiÃ³ un ID vÃ¡lido");return}const t=this.getOwnerComponent().getModel("modelEtapasAsignadas");if(t){t.refresh(true)}this.filterEstado()},_refreshTableData:function(){const e=this.byId("idPendientes");if(e){e.getBinding("items")?.refresh()}},formatDate:function(e){if(!e){return""}if(typeof e==="object"&&typeof e.getTime==="function"){e=e}else{e=new Date(e)}if(isNaN(e.getTime())){return""}var o=s.getInstance({pattern:"dd MMM yyyy",UTC:true});return o.format(e)},onEditPress:function(e){var o=e.getSource();var t=o.getBindingContext("modelPendientes");var s=o.getBindingContext("modelAprobados");var n=o.getBindingContext("modelBorrador");var a=o.getBindingContext("modelEtapasAsignadas");var r=o.getBindingContext("modelRechazados");var i=t||s||n||a||r;if(!i){console.error("No se pudo obtener el contexto del Ã­tem.");return}var l=i.getProperty("ID")||i.getProperty("projectId");if(!l){console.error("El ID del proyecto es nulo o indefinido");return}var c=i.getProperty("nameProyect");var d=this;var u=this.getView().getModel("mainService");if(u){u.setData({});u.refresh(true)}var p=null;if(t){p="modelPendientes"}else if(s){p="modelAprobados"}else if(n){p="modelBorrador"}else if(a){p="modelEtapasAsignadas"}else if(r){p="modelRechazados"}var f=p==="modelEtapasAsignadas"||p==="modelAprobados"||p==="modelRechazados"?"display":"edit";var m=f==="edit"?"Confirmar EdiciÃ³n":"Ver Solicitud";var g=f==="edit"?"Â¿EstÃ¡s seguro de que quieres editar el proyecto '"+c+"'?":"Â¿Quieres ver el contenido de esta solicitud?";var h=new sap.m.Dialog({title:m,type:"Message",state:"Warning",content:new sap.m.Text({text:g}),beginButton:new sap.m.Button({text:"Confirmar",press:function(){h.close();var e=sap.ui.core.UIComponent.getRouterFor(d);if(p==="modelEtapasAsignadas"){e.navTo("viewWithAprobacion",{sourceModel:p,mode:f,sProjectID:l,aprobacion:"true"})}else{e.navTo("viewWithMode",{sourceModel:p,mode:f,sProjectID:l},true)}}}),endButton:new sap.m.Button({text:"Cancelar",press:function(){h.close()}})});h.open()},onView:function(e){if(!this.Dialog){this.Dialog=this.loadFragment({name:"project1.view.Dialog"})}this.Dialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},DialogInfo:async function(e){this.onView();var o=e.getSource();var t=o.getCustomData().find(function(e){return e.getKey()==="projectId"}).getValue();console.log("Metodo project "+t);const s=this._sCsrfToken;var n=this.getView().getModel("mainService");if(n){n.setData({});n.refresh(true)}var a=`/odata/v4/datos-cdo/DatosProyect(${t})`;try{const e=await fetch(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-csrf-token":s}});if(!e.ok){const o=await e.text();throw new Error("Network response was not ok: "+o)}const o=await e.json();console.log(JSON.stringify(o));this.byId("idNombreProyecto").setText(o.nameProyect);this.byId("idDescripcion1").setText(o.descripcion);this.byId("idCreador").setText(o.Empleado);this.byId("idEMail").setText(o.Email);this.byId("idModifi").setText(o.FechaModificacion);this.byId("fechainitProyect").setText(o.Fechainicio);const t=sap.ui.core.format.DateFormat.getDateTimeInstance({style:"medium"});const n=new Date(o.fechaCreacion);const u=t.format(n);this.byId("idCreacion").setText(u);var r=o.FechaFin.split("T")[0];var i=r.split("-");var l=i[2]+"-"+i[1]+"-"+i[0];this.byId("idFechaFinProyect").setText(l);this.byId("idEstadoProyect").setText(o.Estado);this.byId("idArea").setText(o.Area_ID.NombreArea);var c=new Intl.NumberFormat("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}).format(o.Total);var d=c+" â‚¬";this.byId("idtotal").setText(d)}catch(e){console.error("Error al obtener los datos del proyecto:",e);sap.m.MessageToast.show("Error al cargar los datos del proyecto")}},onEmailPress2:function(e){const o=e.getSource().getText();window.location.href="mailto:"+o},onDeletePress:async function(e){let o=e.getSource();const t=o.data("etapaId");let s=o.getCustomData()[0].getValue();if(!s){console.error("No se encontrÃ³ un ID vÃ¡lido para eliminar.");sap.m.MessageToast.show("Error: No se encontrÃ³ un ID vÃ¡lido.");return}console.log("Eliminando Proyecto con ID:",s);const n={otrosGastoRecu:["ValorMensuServReInter"],RecursosInternos:["ValorMensuReInter"],otrosRecursos:["ValorMensuGastViaReInter"],ConsumoExternos:["ValorMensuConsuEx"],otrosServiciosConsu:["ValorMensuServConsuEx"],GastoViajeConsumo:["ValorMensuGastoViaConsuEx"],RecursosExternos:["ValorMensuRecuExter"],serviRecurExter:["ValorMensuSerExter"],GastoViajeRecExter:["ValorMensuGastoViExter"],otrosConceptos:["ValorMensuOtrConcep"],LicenciasCon:["ValorMensulicencia"]};try{let e=await fetch("/odata/v4/datos-cdo/",{method:"GET",headers:{"x-csrf-token":"Fetch"}});if(!e.ok)throw new Error("Error al obtener el CSRF Token");let o=e.headers.get("x-csrf-token");if(!o)throw new Error("No se recibiÃ³ un CSRF Token");console.log("CSRF Token obtenido:",o);sap.m.MessageBox.confirm("Â¿Deseas eliminar este proyecto y todos sus registros relacionados?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async e=>{if(e!==sap.m.MessageBox.Action.YES)return;try{const e=await fetch(`/odata/v4/datos-cdo/DatosProyect(${s})?$expand=WorkflowInstancias`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(e.ok){console.log("Cancelando el workflow con ID:",t);if(t){const e=this.getOwnerComponent().getModel();const o=e.bindContext("/cancelWorkflow(...)");o.setParameter("workflowInstanceId",t);await o.execute()}}else{console.warn("No se pudo obtener la instancia de workflow.")}const a=["planificacion","Facturacion","ClientFactura","ProveedoresC","RecursosInternos","ConsumoExternos","RecursosExternos","otrosConceptos","otrosGastoRecu","otrosRecursos","otrosServiciosConsu","GastoViajeConsumo","serviRecurExter","GastoViajeRecExter","LicenciasCon","WorkflowInstancias","ResumenCostesTotal","RecurInterTotal","ConsuExterTotal","RecuExterTotal","InfraestrLicencia","PerfilTotal"];for(const e of a){let t=await fetch(`/odata/v4/datos-cdo/DatosProyect(${s})/${e}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(!t.ok){console.warn(`âš ï¸ No se pudieron obtener los registros de ${e}`);continue}let a=t.headers.get("Content-Type");let r=a&&a.includes("application/json")?await t.json():{value:[]};let i=Array.isArray(r.value)?r.value:[r];if(i.length>0){for(const t of i){if(n[e]){let s=n[e];for(const n of s){let s=await fetch(`/odata/v4/datos-cdo/${e}(${t.ID})/${n}`,{method:"GET",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(s.ok){let e=await s.json();let t=e.value||[];await Promise.all(t.map(async e=>{let t=await fetch(`/odata/v4/datos-cdo/${n}(${e.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(!t.ok){console.error(`Error eliminando hijo anidado ${n} con ID ${e.ID}`)}else{console.log(`Hijo anidado eliminado: ${n} ID ${e.ID}`)}}))}else{console.warn(`No se pudieron obtener registros para hijo anidado ${n} de ${e}(${t.ID})`)}}}let s=await fetch(`/odata/v4/datos-cdo/${e}(${t.ID})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(!s.ok){console.error(`Error eliminando ${e} con ID ${t.ID}`)}else{console.log(`${e} eliminado: ${t.ID}`)}}}}console.log("Registros relacionados eliminados.");let r=await fetch(`/odata/v4/datos-cdo/DatosProyect(${s})`,{method:"DELETE",headers:{"Content-Type":"application/json","x-csrf-token":o}});if(r.ok){console.log("Proyecto eliminado correctamente.");sap.m.MessageBox.success("Proyecto y registros eliminados exitosamente.",{title:"Ã‰xito",actions:[sap.m.MessageBox.Action.OK],onClose:async function(){let e=this.byId("idPendientes");if(e){let o=e.getBinding("items");if(o){o.refresh(true)}else{console.warn("âš ï¸ No se encontrÃ³ el binding de la tabla.")}}else{console.warn("âš ï¸ Tabla no encontrada con ID idPendientes.")}await this.filterEstado()}.bind(this)})}else{throw new Error("Error al eliminar el proyecto principal")}}catch(e){console.error("Error eliminando el proyecto o registros:",e);sap.m.MessageToast.show("Error al eliminar el proyecto o registros.")}}})}catch(e){console.error("Error al obtener el CSRF Token:",e);sap.m.MessageToast.show("Error al obtener el CSRF Token.")}},onNavToView1:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var o=this.getOwnerComponent();Promise.resolve().then(()=>{var e=o.byId("view");if(e&&e.getController&&typeof e.getController==="function"){var t=e.getController();if(t._clearAllInputs){t._clearAllInputs()}}});e.navTo("viewNoParam",{mode:"create"})}})});
//# sourceMappingURL=App.controller.js.map